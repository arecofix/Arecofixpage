<div class="max-w-2xl mx-auto text-gray-800">
  <h2 class="text-lg font-medium mb-4">{{ id ? 'Editar' : 'Nuevo' }} producto</h2>

  <form (ngSubmit)="save()" #f="ngForm" class="grid gap-4">
    <div>
      <label class="block text-sm">Nombre</label>
      <input type="text" [(ngModel)]="form().name" name="name" class="input input-bordered w-full" required />
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="form-control">
        <label class="label">SKU</label>
        <input type="text" [(ngModel)]="form().sku" name="sku" class="input input-bordered">
      </div>
      <div class="form-control">
        <label class="label">Código de Barras</label>
        <div class="join">
          <input type="text" [(ngModel)]="form().barcode" name="barcode" class="input input-bordered join-item w-full">
          <button type="button" class="btn join-item" (click)="generateBarcode()">
            <i class="fas fa-random"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="form-control">
      <label class="label">Nombre</label>
      <input type="text" [(ngModel)]="form().name" name="name" class="input input-bordered" required>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="form-control">
        <label class="label">Marca</label>
        <select [(ngModel)]="form().brand_id" name="brand_id" class="select select-bordered">
          <option value="">Seleccionar Marca</option>
          @for (brand of brands(); track brand.id) {
          <option [value]="brand.id">{{ brand.name }}</option>
          }
        </select>
      </div>
      <div class="form-control">
        <label class="label">Categoría</label>
        <select [(ngModel)]="form().category_id" name="category_id" class="select select-bordered">
          <option value="">Seleccionar Categoría</option>
          @for (cat of categories(); track cat.id) {
          <option [value]="cat.id">{{ cat.name }}</option>
          }
        </select>
      </div>
    </div>

    <div>
      <label class="block text-sm">Descripción</label>
      <textarea [(ngModel)]="form().description" name="description" class="textarea textarea-bordered w-full"
        rows="4"></textarea>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm">Precio</label>
        <input type="number" [(ngModel)]="form().price" name="price" class="input input-bordered w-full" required />
      </div>
      <div>
        <label class="block text-sm">Stock</label>
        <input type="number" [(ngModel)]="form().stock" name="stock" class="input input-bordered w-full" />
      </div>
    </div>

    <div class="flex items-center gap-2">
      <input type="checkbox" [(ngModel)]="form().is_active" name="is_active" />
      <span>Activo</span>
    </div>

    <div>
      <label class="block text-sm font-medium mb-2">Fotos del Producto</label>
      <input type="file" (change)="onFileChange($event)" accept="image/*" class="file-input file-input-bordered w-full"
        multiple />
      <p class="text-sm text-gray-500 mt-1">Puedes subir múltiples imágenes. La primera será la imagen principal.</p>

      @if (form().images.length > 0) {
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-4">
        @for (img of form().images; track img; let idx = $index) {
        <div class="relative group">
          <img [src]="img" class="w-full h-32 object-cover rounded-lg border-2 border-gray-200" />
          <button type="button" (click)="removeImage(idx)"
            class="absolute top-1 right-1 btn btn-circle btn-sm btn-error opacity-0 group-hover:opacity-100 transition-opacity">
            <i class="fas fa-times"></i>
          </button>
          @if (idx === 0) {
          <span class="absolute bottom-1 left-1 badge badge-primary badge-sm">Principal</span>
          }
        </div>
        }
      </div>
      }
    </div>

    @if (error) {
    <div class="text-red-600">{{ error }}</div>
    }

    <div class="flex gap-2">
      <button type="submit" class="btn btn-primary" [disabled]="saving || uploading()">
        @if (uploading()) {
        <span class="loading loading-spinner loading-xs"></span>
        }
        Guardar
      </button>
      <a routerLink="/admin/products" class="btn">Cancelar</a>
    </div>
  </form>
</div>