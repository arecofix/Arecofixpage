@if (isOpen()) {
<div class="modal modal-open z-50">
  <div class="modal-box w-11/12 max-w-2xl bg-white dark:bg-gray-800 rounded-2xl shadow-2xl relative p-0 overflow-hidden border border-gray-200 dark:border-gray-700">

    <!-- Header -->
    <div class="px-6 pt-5 pb-0">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h3 class="font-bold text-xl text-gray-800 dark:text-white">Operación Masiva</h3>
          <p class="text-xs text-gray-500 mt-0.5">
            <span class="font-bold text-primary">{{ selectedIds().length }}</span> productos seleccionados
          </p>
        </div>
        <button class="btn btn-sm btn-circle btn-ghost" (click)="close()" [disabled]="isProcessing()">✕</button>
      </div>

      <!-- Tabs -->
      <div class="tabs tabs-bordered w-full">
        <button class="tab tab-lg flex-1 font-semibold gap-2"
          [class.tab-active]="activeTab() === 'edit'"
          (click)="setTab('edit')">
          <i class="fas fa-pen-to-square text-sm"></i> Editar campos
        </button>
        <button class="tab tab-lg flex-1 font-semibold gap-2 hover:text-error"
          [class.tab-active]="activeTab() === 'delete'"
          [class.text-error]="activeTab() === 'delete'"
          (click)="setTab('delete')">
          <i class="fas fa-trash-alt text-sm"></i> Eliminar
        </button>
      </div>
    </div>

    @if (!showConfirmation()) {

      <!-- ═══════ EDIT TAB ═══════ -->
      @if (activeTab() === 'edit') {
        <div class="p-6 space-y-5 max-h-[60vh] overflow-y-auto">

          @if (error()) {
            <div class="alert alert-error text-sm py-2">
              <i class="fas fa-exclamation-circle"></i>
              <span>{{ error() }}</span>
            </div>
          }

          <!-- PRICE -->
          <div class="grid grid-cols-3 gap-3 items-start border-b border-gray-100 dark:border-gray-700 pb-5">
            <div class="pt-2">
              <p class="font-bold text-xs uppercase tracking-wider text-gray-400">Precio</p>
            </div>
            <div class="col-span-2 space-y-2">
              <select [ngModel]="priceMode()" (ngModelChange)="priceMode.set($event)"
                class="select select-bordered w-full select-sm">
                <option value="none">— Sin cambios —</option>
                <option value="fixed">Fijar precio exacto...</option>
                <option value="percentage">Ajuste porcentual (+/- %)</option>
              </select>
              @if (priceMode() !== 'none') {
                <div class="relative">
                  <input type="number" [ngModel]="priceValue()" (ngModelChange)="priceValue.set($event)"
                    [placeholder]="priceMode() === 'fixed' ? 'Monto en $' : 'Ej: 10 (aumento) o -5 (descuento)'"
                    class="input input-bordered w-full input-sm pr-8" />
                  <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs font-bold">
                    {{ priceMode() === 'fixed' ? '$' : '%' }}
                  </span>
                </div>
              }
            </div>
          </div>

          <!-- STOCK -->
          <div class="grid grid-cols-3 gap-3 items-start border-b border-gray-100 dark:border-gray-700 pb-5">
            <div class="pt-2">
              <p class="font-bold text-xs uppercase tracking-wider text-gray-400">Stock</p>
            </div>
            <div class="col-span-2 space-y-2">
              <select [ngModel]="stockMode()" (ngModelChange)="stockMode.set($event)"
                class="select select-bordered w-full select-sm">
                <option value="none">— Sin cambios —</option>
                <option value="fixed">Fijar en...</option>
                <option value="increase">Aumentar en...</option>
                <option value="decrease">Disminuir en...</option>
              </select>
              @if (stockMode() !== 'none') {
                <input type="number" min="0" [ngModel]="stockValue()" (ngModelChange)="stockValue.set($event)"
                  placeholder="Cantidad"
                  class="input input-bordered w-full input-sm" />
              }
            </div>
          </div>

          <!-- CATEGORY -->
          <div class="grid grid-cols-3 gap-3 items-center border-b border-gray-100 dark:border-gray-700 pb-5">
            <p class="font-bold text-xs uppercase tracking-wider text-gray-400">Categoría</p>
            <div class="col-span-2">
              <select [ngModel]="targetCategoryId()" (ngModelChange)="targetCategoryId.set($event)"
                class="select select-bordered w-full select-sm">
                <option value="">— Sin cambios —</option>
                @for(cat of categories(); track cat.id) {
                  <option [value]="cat.id">{{ cat.name }}</option>
                }
              </select>
            </div>
          </div>

          <!-- BRAND -->
          <div class="grid grid-cols-3 gap-3 items-center border-b border-gray-100 dark:border-gray-700 pb-5">
            <p class="font-bold text-xs uppercase tracking-wider text-gray-400">Marca</p>
            <div class="col-span-2">
              <select [ngModel]="targetBrandId()" (ngModelChange)="targetBrandId.set($event)"
                class="select select-bordered w-full select-sm">
                <option value="">— Sin cambios —</option>
                @for(b of brands(); track b.id) {
                  <option [value]="b.id">{{ b.name }}</option>
                }
              </select>
            </div>
          </div>

          <!-- STATUS -->
          <div class="grid grid-cols-3 gap-3 items-center">
            <p class="font-bold text-xs uppercase tracking-wider text-gray-400">Estado</p>
            <div class="col-span-2">
              <select [ngModel]="targetStatus()" (ngModelChange)="targetStatus.set($event)"
                class="select select-bordered w-full select-sm">
                <option value="none">— Sin cambios —</option>
                <option value="active">✅ Publicado (Activo)</option>
                <option value="inactive">⬜ Borrador (Inactivo)</option>
              </select>
            </div>
          </div>

        </div>

        <!-- Footer Edit -->
        <div class="bg-gray-50 dark:bg-gray-700/50 p-4 flex justify-end gap-3 border-t border-gray-200 dark:border-gray-700">
          <button class="btn btn-ghost btn-sm" (click)="close()">Cancelar</button>
          <button class="btn btn-primary btn-sm px-8 shadow-lg shadow-primary/20"
            (click)="prepareExecute()"
            [disabled]="!hasEditChanges()">
            <i class="fas fa-eye mr-2"></i> Vista previa
          </button>
        </div>
      }

      <!-- ═══════ DELETE TAB ═══════ -->
      @if (activeTab() === 'delete') {
        <div class="p-8 text-center">
          <div class="w-20 h-20 bg-error/10 text-error rounded-full flex items-center justify-center mx-auto mb-5">
            <i class="fas fa-trash-alt text-4xl"></i>
          </div>
          <h4 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Eliminar productos seleccionados</h4>
          <p class="text-gray-500 text-sm max-w-sm mx-auto mb-6">
            Se eliminarán <span class="font-bold text-error">{{ selectedIds().length }} producto{{ selectedIds().length !== 1 ? 's' : '' }}</span> de forma permanente del inventario. Los productos eliminados no aparecerán en el catálogo ni en búsquedas.
          </p>
          @if (error()) {
            <div class="alert alert-error text-sm py-2 mb-4">
              <i class="fas fa-exclamation-circle"></i>
              <span>{{ error() }}</span>
            </div>
          }
        </div>
        <!-- Footer Delete -->
        <div class="bg-error/5 p-4 flex justify-end gap-3 border-t border-error/20">
          <button class="btn btn-ghost btn-sm" (click)="close()">Cancelar</button>
          <button class="btn btn-error btn-sm px-8"
            (click)="prepareExecute()">
            <i class="fas fa-trash-alt mr-2"></i> Confirmar eliminación
          </button>
        </div>
      }

    } @else {
      <!-- ═══════ CONFIRMATION SCREEN ═══════ -->
      <div class="p-10 text-center space-y-5">

        @if (activeTab() === 'delete') {
          <div class="w-20 h-20 bg-error/10 text-error rounded-full flex items-center justify-center mx-auto">
            <i class="fas fa-trash-alt text-4xl"></i>
          </div>
          <div>
            <h4 class="text-2xl font-bold text-gray-800 dark:text-white">¿Confirmar eliminación?</h4>
            <p class="text-gray-500 mt-2">
              Se eliminarán <span class="font-bold text-error">{{ selectedIds().length }} productos</span>.
              <br><span class="text-xs text-gray-400">Esta acción no se puede deshacer.</span>
            </p>
          </div>
          <div class="flex justify-center gap-4">
            <button class="btn btn-outline btn-sm px-8" (click)="showConfirmation.set(false)" [disabled]="isProcessing()">
              Regresar
            </button>
            <button class="btn btn-error btn-sm px-10" (click)="execute()" [disabled]="isProcessing()">
              @if (isProcessing()) {
                <span class="loading loading-spinner loading-xs"></span> Eliminando...
              } @else {
                <i class="fas fa-trash-alt mr-2"></i> Sí, eliminar ahora
              }
            </button>
          </div>
        } @else {
          <div class="w-20 h-20 bg-warning/10 text-warning rounded-full flex items-center justify-center mx-auto">
            <i class="fas fa-check-circle text-4xl"></i>
          </div>
          <div>
            <h4 class="text-2xl font-bold text-gray-800 dark:text-white">¿Aplicar cambios?</h4>
            <p class="text-gray-500 mt-1 text-sm">
              A <span class="font-bold text-gray-800 dark:text-white">{{ selectedIds().length }} productos</span>:
            </p>
            <ul class="mt-3 space-y-1 text-sm text-left inline-block">
              @for (line of confirmSummary(); track $index) {
                <li class="flex items-center gap-2">
                  <i class="fas fa-check text-success text-xs w-4"></i>
                  <span>{{ line }}</span>
                </li>
              }
            </ul>
          </div>
          <div class="flex justify-center gap-4 mt-4">
            <button class="btn btn-outline btn-sm px-8" (click)="showConfirmation.set(false)" [disabled]="isProcessing()">
              Regresar
            </button>
            <button class="btn btn-primary btn-sm px-10" (click)="execute()" [disabled]="isProcessing()">
              @if (isProcessing()) {
                <span class="loading loading-spinner loading-xs"></span> Actualizando...
              } @else {
                <i class="fas fa-check mr-2"></i> ¡Sí, actualizar ahora!
              }
            </button>
          </div>
        }

      </div>
    }

  </div>
  <form method="dialog" class="modal-backdrop bg-black/60 backdrop-blur-sm">
    <button (click)="close()">close</button>
  </form>
</div>
}
