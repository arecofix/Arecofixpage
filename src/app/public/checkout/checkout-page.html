<div class="container mx-auto px-4 py-8 max-w-4xl">
    <h1 class="text-3xl font-bold mb-8 text-center text-base-content">Checkout</h1>

    @if (orderSuccess()) {
    <div class="card bg-base-100 shadow-xl text-center p-10 border border-base-200">
        <div class="card-body items-center">
            <div class="text-success text-6xl mb-4">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 class="card-title text-2xl text-base-content">¡Orden Recibida!</h2>
            <p class="text-base-content/80">Gracias por tu compra. Nos pondremos en contacto contigo pronto.</p>
            <div class="card-actions mt-6">
                <a routerLink="/" class="btn btn-primary">Volver al Inicio</a>
            </div>
        </div>
    </div>
    } @else {
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Cart Summary -->
        <div class="card bg-base-100 shadow-xl h-fit border border-base-200">
            <div class="card-body">
                <h2 class="card-title mb-4 text-base-content">Resumen del Carrito</h2>

                @if (cartService.cartItems().length === 0) {
                <p class="text-base-content/70">Tu carrito está vacío.</p>
                <a routerLink="/products" class="btn btn-link px-0">Ir a comprar</a>
                } @else {
                <div class="space-y-4">
                    @for (item of cartService.cartItems(); track item.product.id) {
                    <div class="flex gap-4 items-center p-2 hover:bg-base-200 rounded-lg transition-colors">
                        <img [src]="item.product.image_url || item.product.gallery_urls?.[0] || 'assets/img/no-image.png'"
                            class="w-16 h-16 object-cover rounded-lg border border-base-300" />
                        <div class="flex-1">
                            <h3 class="font-bold text-base-content">{{ item.product.name }}</h3>
                            <p class="text-sm text-base-content/70">${{ item.product.price }} x {{ item.quantity }}</p>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="font-bold text-base-content">
                                ${{ (item.product.price * item.quantity).toFixed(2) }}
                            </span>
                            <button (click)="cartService.removeFromCart(item.product.id)" class="btn btn-ghost btn-xs text-error" aria-label="Eliminar">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    }
                </div>

                <div class="divider"></div>

                <div class="flex justify-between text-xl font-bold text-base-content">
                    <span>Total</span>
                    <span>${{ cartService.totalPrice().toFixed(2) }}</span>
                </div>
                }
            </div>
        </div>

        <!-- Customer Form -->
        <div class="card bg-base-100 shadow-xl border border-base-200">
            <div class="card-body">
                <h2 class="card-title mb-4 text-base-content">Datos del Cliente</h2>

                <form [formGroup]="checkoutForm" (ngSubmit)="placeOrder()" class="space-y-4">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-base-content">Nombre Completo</span>
                        </label>
                        <input type="text" formControlName="name" class="input input-bordered w-full bg-base-100 text-base-content"
                            [class.input-error]="checkoutForm.get('name')?.invalid && checkoutForm.get('name')?.touched" />
                        @if (checkoutForm.get('name')?.invalid && checkoutForm.get('name')?.touched) {
                        <span class="text-error text-xs mt-1">El nombre es requerido</span>
                        }
                    </div>

                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-base-content">Email</span>
                        </label>
                        <input type="email" formControlName="email" class="input input-bordered w-full bg-base-100 text-base-content"
                            [class.input-error]="checkoutForm.get('email')?.invalid && checkoutForm.get('email')?.touched" />
                        @if (checkoutForm.get('email')?.invalid && checkoutForm.get('email')?.touched) {
                        <span class="text-error text-xs mt-1">Email inválido</span>
                        }
                    </div>

                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-base-content">Teléfono</span>
                        </label>
                        <input type="tel" formControlName="phone" class="input input-bordered w-full bg-base-100 text-base-content"
                            [class.input-error]="checkoutForm.get('phone')?.invalid && checkoutForm.get('phone')?.touched" />
                        @if (checkoutForm.get('phone')?.invalid && checkoutForm.get('phone')?.touched) {
                        <span class="text-error text-xs mt-1">El teléfono es requerido</span>
                        }
                    </div>

                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-base-content">Dirección de Envío</span>
                        </label>
                        <textarea formControlName="address" class="textarea textarea-bordered h-24 w-full bg-base-100 text-base-content"
                            [class.textarea-error]="checkoutForm.get('address')?.invalid && checkoutForm.get('address')?.touched"></textarea>
                        @if (checkoutForm.get('address')?.invalid && checkoutForm.get('address')?.touched) {
                        <span class="text-error text-xs mt-1">La dirección es requerida</span>
                        }
                    </div>

                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-base-content">Notas (Opcional)</span>
                        </label>
                        <textarea formControlName="notes" class="textarea textarea-bordered w-full bg-base-100 text-base-content"></textarea>
                    </div>

                    <div class="mt-6">
                        <button type="submit" class="btn btn-primary btn-block btn-lg"
                            [disabled]="isProcessing() || cartService.cartItems().length === 0">
                            @if (isProcessing()) {
                            <span class="loading loading-spinner"></span>
                            }
                            Finalizar Compra
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    }
</div>