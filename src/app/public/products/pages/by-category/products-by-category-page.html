<!-- Mobile Filter Drawer Wrapper -->
<div class="drawer lg:drawer-open">
  <input id="cat-filters-drawer" type="checkbox" class="drawer-toggle" />
  
  <div class="drawer-content flex flex-col min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <!-- Mobile Header -->
    <div class="lg:hidden sticky top-0 z-30 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 px-4 py-3 flex items-center justify-between">
      <h2 class="font-bold text-gray-900 dark:text-white truncate">
          {{ currentCategory()?.name || 'Categoría' }}
      </h2>
      <label for="cat-filters-drawer" class="btn btn-sm btn-ghost lg:hidden">
        <i class="fas fa-sliders-h mr-2"></i> Filtros
      </label>
    </div>

    <!-- DYNAMIC HERO -->
    <header class="relative bg-gray-900 text-white overflow-hidden isolate">
       <div class="absolute inset-0 bg-linear-to-br from-indigo-900 via-blue-950 to-slate-900 opacity-90"></div>
       <div class="absolute -bottom-32 -left-32 w-96 h-96 bg-indigo-600 rounded-full mix-blend-overlay filter blur-3xl opacity-20"></div>
       <div class="absolute top-0 right-0 w-64 h-64 bg-teal-500 rounded-full mix-blend-overlay filter blur-3xl opacity-10"></div>

       <div class="relative container mx-auto px-4 py-16 lg:py-24 text-center">
           <div class="text-sm breadcrumbs text-indigo-200 justify-center mb-6 hidden md:flex">
                <ul>
                <li><a routerLink="/">Inicio</a></li>
                <li><a routerLink="/productos">Productos</a></li>
                <li class="font-semibold text-white">{{ currentCategory()?.name || 'Cargando...' }}</li>
                </ul>
            </div>

            <h1 class="text-4xl md:text-5xl font-black mb-6 tracking-tight animate-fade-in-up">
                {{ currentCategory()?.name || 'Explorando Categoría' }}
            </h1>
            
            <p class="text-lg md:text-xl text-gray-300 max-w-2xl mx-auto mb-8 font-light">
                 {{ currentCategory()?.description || 'Encontrá los mejores productos de esta sección con calidad garantizada.' }}
            </p>
       </div>
    </header>

    <!-- MAIN CONTENT -->
    <div class="flex-1 container mx-auto px-4 py-12">
         <!-- Toolbar -->
         <div class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-200 dark:border-gray-800 gap-4">
            <div class="text-gray-600 dark:text-gray-400 font-medium text-sm">
                 @if (productsRs.value()) {
                    Mostrando <span class="text-gray-900 dark:text-white font-bold">{{ productsRs.value()?.items }}</span> resultados
                  } @else {
                    Cargando catálogo...
                  }
            </div>
            
             <div class="flex items-center gap-3">
                 <!-- Search in Category -->
                 <div class="relative hidden md:block">
                     <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                     <input 
                         [ngModel]="searchQuery()" 
                         (ngModelChange)="onSearch($event)" 
                         type="text" 
                         [placeholder]="'Buscar en ' + (currentCategory()?.name || 'esta sección') + '...'" 
                         class="input input-bordered input-sm rounded-full pl-9 w-64 focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-gray-800"
                     />
                 </div>

                <select (change)="setSort($any($event.target).value.split('|')[0], $any($event.target).value.split('|')[1])"
                    class="select select-bordered select-sm rounded-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-700 min-w-[150px]">
                    <option value="created_at|desc">Más Recientes</option>
                    <option value="price|asc">Precio: Menor a Mayor</option>
                    <option value="price|desc">Precio: Mayor a Menor</option>
                </select>
            </div>
         </div>
         
         <!-- Mobile Search Block (Visible only on mobile) -->
         <div class="md:hidden mb-6">
             <div class="relative">
                 <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                 <input 
                     [ngModel]="searchQuery()" 
                     (ngModelChange)="onSearch($event)" 
                     type="text" 
                     placeholder="Buscar en esta categoría..." 
                     class="input input-bordered w-full rounded-2xl pl-10"
                 />
             </div>
         </div>

         <!-- GRID -->
         <main class="min-h-[400px]">
            @if (productsRs.isLoading()) {
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6">
                    @for(i of [1,2,3,4,5,6]; track i) {
                        <div class="animate-pulse bg-gray-200 dark:bg-gray-800 rounded-3xl h-[400px] w-full"></div>
                    }
                 </div>
            } @else if (productsRs.error()) {
                 <is-error [message]="productsRs.error()?.message || 'Error al cargar categoría'" />
            } @else if (productsRs.value()) {
                 @if (productsRs.value()?.items === 0) {
                     <div class="text-center py-20 bg-white dark:bg-gray-800 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700">
                         <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                         <h3 class="font-bold text-lg text-gray-900 dark:text-white">Sin resultados en esta categoría</h3>
                         <button (click)="onSearch(''); minPriceInput.set(null); maxPriceInput.set(null); applyPriceFilter()" class="btn btn-link text-indigo-600">
                             Ver todos los productos
                         </button>
                     </div>
                 } @else {
                     <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6">
                        @for (product of productsRs.value()!.data; track product.id; let i = $index) {
                            <product-card [product]="product" [isPriority]="i < 2" (quickView)="openQuickView($event)"></product-card>
                        }
                     </div>

                     @if (paginationData()) {
                        <div class="mt-12 flex justify-center">
                            <pagination [pages]="paginationData()!.pages" [currentPage]="paginationService.currentPage()"></pagination>
                        </div>
                     }
                 }
            }
         </main>
    </div>
  </div>

  <!-- SIDEBAR (Filters) -->
  <div class="drawer-side z-40">
    <label for="cat-filters-drawer" aria-label="close sidebar" class="drawer-overlay backdrop-blur-sm"></label>
    <aside class="menu p-6 w-80 min-h-full bg-white dark:bg-gray-800 text-base-content border-r border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center mb-8">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Filtros</h3>
            <label for="cat-filters-drawer" class="btn btn-sm btn-circle btn-ghost">✕</label>
        </div>

        <div class="space-y-8">
            <!-- Price -->
            <div>
                <h4 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                    <i class="fas fa-tag text-indigo-500"></i> Precio
                </h4>
                <div class="flex flex-col gap-3">
                    <div class="form-control w-full">
                        <label class="label text-xs text-gray-500">Mínimo</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-gray-400">$</span>
                            <input type="number" [ngModel]="minPriceInput()" (ngModelChange)="minPriceInput.set($event)" placeholder="0" class="input input-bordered w-full pl-8 rounded-xl" />
                        </div>
                    </div>
                    <div class="form-control w-full">
                        <label class="label text-xs text-gray-500">Máximo</label>
                        <div class="relative">
                             <span class="absolute left-3 top-3 text-gray-400">$</span>
                            <input type="number" [ngModel]="maxPriceInput()" (ngModelChange)="maxPriceInput.set($event)" placeholder="Max" class="input input-bordered w-full pl-8 rounded-xl" />
                        </div>
                    </div>
                   <button (click)="applyPriceFilter()" class="btn btn-primary w-full mt-2 rounded-xl">
                        Aplicar
                    </button>
                </div>
            </div>

            <!-- Other Categories -->
             <div>
                <h4 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                    <i class="fas fa-layer-group text-indigo-500"></i> Otras Secciones
                </h4>
                <div class="max-h-60 overflow-y-auto custom-scrollbar">
                    <ul class="space-y-1">
                        @if (categoriesListRs.value()) {
                            @for (cat of categoriesListRs.value()!.data; track cat.id) {
                                <li>
                                    <a [routerLink]="['/productos/categoria', cat.slug]" 
                                       [class.active]="currentCategory()?.id === cat.id"
                                       class="block py-2 px-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition text-sm">
                                        {{ cat.name }}
                                    </a>
                                </li>
                            }
                        }
                    </ul>
                </div>
             </div>
        </div>
    </aside>
  </div>
</div>

<!-- Quick View Modal -->
@if (isQuickViewOpen()) {
<div class="modal modal-open z-50 animate-fade-in">
  <div class="modal-box relative max-w-4xl bg-white dark:bg-gray-800 rounded-3xl p-0 overflow-hidden shadow-2xl">
    <button class="btn btn-sm btn-circle btn-ghost absolute right-4 top-4 z-10 bg-white/50 backdrop-blur-md" (click)="closeQuickView()">✕</button>
    
    @if (quickViewProduct(); as p) {
        <div class="flex flex-col md:flex-row h-full">
            <div class="w-full md:w-1/2 bg-gray-50 dark:bg-gray-700/30 p-8 flex items-center justify-center relative">
                <img [src]="p.image_url || 'assets/img/no-image.png'" class="max-h-[300px] object-contain drop-shadow-xl" [alt]="p.name"/>
                @if((p.stock ?? 0) <= 0) {
                     <span class="absolute top-8 left-8 badge badge-error text-white font-bold p-3">Sin Stock</span>
                }
            </div>
            
            <div class="w-full md:w-1/2 p-8 flex flex-col">
                <div class="mb-auto">
                    <h3 class="font-black text-2xl md:text-3xl mb-2 text-gray-900 dark:text-white leading-tight">{{ p.name }}</h3>
                    <div class="flex items-baseline gap-3 mb-6">
                        <span class="text-4xl font-bold text-indigo-600 dark:text-indigo-400">{{ p.price | currency }}</span>
                        @if(p.regular_price && p.regular_price > p.price) {
                            <span class="text-lg text-gray-400 line-through">{{ p.regular_price | currency }}</span>
                        }
                    </div>
                
                    <p class="text-gray-600 dark:text-gray-300 mb-6 leading-relaxed">{{ p.description || 'Sin descripción disponible.' }}</p>
                </div>
                
                <button class="btn btn-primary btn-lg w-full rounded-2xl shadow-xl shadow-indigo-600/30 gap-3" (click)="addToCart(p)">
                   <i class="fas fa-shopping-cart"></i> Agregar al Carrito
                </button>
            </div>
        </div>
    }
  </div>
  <form method="dialog" class="modal-backdrop bg-black/50 backdrop-blur-sm">
    <button (click)="closeQuickView()">close</button>
  </form>
</div>
}
