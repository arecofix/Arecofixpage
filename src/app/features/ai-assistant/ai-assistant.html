
<!-- Toggler Button -->
<button (click)="toggleChat()"
  class="fixed bottom-6 left-6 z-9999 w-14 h-14 md:w-16 md:h-16 rounded-full bg-linear-to-r from-blue-600 to-purple-600 text-white shadow-lg shadow-purple-500/30 flex items-center justify-center hover:scale-110 transition-transform active:scale-95 group"
  [attr.aria-label]="isOpen() ? 'Cerrar asistente de IA' : 'Abrir asistente de IA'"
  aria-haspopup="dialog">
  @if (!isOpen()) {
    <div class="absolute inset-0 rounded-full border border-white/20 animate-ping opacity-20"></div>
  }
  <!-- AI Icon -->
  @if (!isOpen()) {
    <i class="fas fa-microchip text-2xl group-hover:rotate-12 transition-transform"></i>
  }
  @if (isOpen()) {
    <i class="fas fa-times text-xl"></i>
  }
</button>

<!-- Chat Window -->
@if (isOpen()) {
  <div
    class="fixed bottom-0 right-0 md:bottom-24 md:right-6 w-full md:w-[400px] h-dvh md:h-[600px] md:max-h-[80vh] z-9999 md:rounded-2xl glass-panel border-t md:border border-white/10 shadow-2xl flex flex-col overflow-hidden animate-slide-up bg-surface-dark/95 backdrop-blur-xl">
    <!-- Header -->
    <div class="p-4 border-b border-white/10 flex items-center justify-between bg-white/5 shrink-0">
      <div class="flex items-center gap-3">
        <div class="w-2 h-2 rounded-full" [ngClass]="aiService.modelLoaded() ? 'bg-green-500 animate-pulse' : 'bg-yellow-500'"></div>
        <h3 class="font-bold text-white text-sm">Arecofix AI @if (aiService.isLoadingModel()) {
          <span class="text-xs font-normal text-gray-400 block">Iniciando Motor...</span>
        }</h3>
      </div>
      <div class="flex items-center gap-3">
        <div class="text-[10px] text-gray-500 font-mono hidden sm:block">WebLLM / MCP</div>
        <!-- Mobile Close Button -->
        <button (click)="toggleChat()" class="md:hidden w-8 h-8 flex items-center justify-center bg-white/10 rounded-full text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <!-- Progress Bar (Model Loading) -->
    @if (aiService.isLoadingModel()) {
      <div class="p-4 bg-blue-900/20 text-center shrink-0">
        <p class="text-xs text-blue-300 mb-2">{{ aiService.loadingProgress() }}</p>
        <div class="w-full h-1 bg-gray-700 rounded-full overflow-hidden">
          <div class="h-full bg-blue-500 animate-pulse-width"></div>
        </div>
        <p class="text-[10px] text-gray-400 mt-2">Descargando modelo IA (solo la primera vez)...</p>
      </div>
    }
    <!-- Messages Area -->
    <div class="grow overflow-y-auto p-4 space-y-4 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-transparent" #scrollContainer>
      <!-- Welcome Message -->
      <div class="flex gap-3">
        <div class="w-8 h-8 rounded-full bg-linear-to-br from-blue-500 to-purple-600 flex items-center justify-center shrink-0">
          <i class="fas fa-robot text-xs text-white"></i>
        </div>
        <div class="bg-white/10 p-3 rounded-2xl rounded-tl-sm text-sm text-gray-200 shadow-md">
          Hola! Soy tu asistente de Arecofix potenciado con IA local (WebLLM). Puedo ayudarte a consultar reparaciones, servicios o agendar citas. Â¿En quÃ© te ayudo?
        </div>
      </div>
      @for (msg of aiService.visibleMessages(); track $index) {
        <div class="flex gap-3" [ngClass]="{'flex-row-reverse': msg.role === 'user'}">
          <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0"
            [ngClass]="msg.role === 'user' ? 'bg-gray-700' : 'bg-linear-to-br from-blue-500 to-purple-600'">
            <i [class]="msg.role === 'user' ? 'fas fa-user' : 'fas fa-robot'" class="text-xs text-white"></i>
          </div>
          <div class="p-3 rounded-2xl text-sm max-w-[80%] shadow-md whitespace-pre-wrap"
            [ngClass]="msg.role === 'user' ? 'bg-blue-600 text-white rounded-tr-sm' : 'bg-white/10 text-gray-200 rounded-tl-sm'">
            {{ msg.content }}
          </div>
        </div>
      }
      <!-- Typing Indicator -->
      @if (aiService.isGenerating()) {
        <div class="flex gap-3">
          <div class="w-8 h-8 rounded-full bg-linear-to-br from-blue-500 to-purple-600 flex items-center justify-center shrink-0">
            <i class="fas fa-robot text-xs text-white"></i>
          </div>
          <div class="bg-white/5 p-3 rounded-2xl rounded-tl-sm flex gap-1 items-center h-10">
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-100"></span>
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-200"></span>
          </div>
        </div>
      }
    </div>
    <!-- Suggestions Chips -->
    @if (aiService.messages().length < 2) {
      <div class="px-4 py-2 flex gap-2 overflow-x-auto no-scrollbar shrink-0">
        <button (click)="userInput.set('Estado de mi reparaciÃ³n'); sendMessage()" class="whitespace-nowrap px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs text-blue-300 hover:bg-white/10 transition-colors">
          ðŸ”§ Estado ReparaciÃ³n
        </button>
        <button (click)="userInput.set('Quiero un presupuesto web'); sendMessage()" class="whitespace-nowrap px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs text-purple-300 hover:bg-white/10 transition-colors">
          ðŸ’» Presupuesto Web
        </button>
        <button (click)="userInput.set('Cambio de pantalla iPhone'); sendMessage()" class="whitespace-nowrap px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs text-green-300 hover:bg-white/10 transition-colors">
          ðŸ“± Reparar Celular
        </button>
      </div>
    }
    <!-- Input Area -->
    <div class="p-3 bg-white/5 border-t border-white/10 shrink-0 pb-6 md:pb-3">
      <form (submit)="sendMessage()" class="relative">
        <input
          type="text"
          [disabled]="aiService.isLoadingModel() || aiService.isGenerating()"
          [(ngModel)]="userInput"
          name="userInput"
          placeholder="Escribe tu mensaje..."
          class="w-full bg-black/30 border border-white/10 rounded-xl py-3 pl-4 pr-12 text-white placeholder-gray-500 focus:outline-hidden focus:border-blue-500/50 transition-colors disabled:opacity-50 text-sm">
          <button
            type="submit"
            [disabled]="!userInput() || aiService.isLoadingModel()"
            class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-blue-600 hover:bg-blue-500 rounded-lg flex items-center justify-center text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-paper-plane text-xs"></i>
          </button>
        </form>
      </div>
    </div>
  }
