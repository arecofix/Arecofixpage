import{b as U,d as B,g as W,r as z}from"./chunk-67JN6MIM.js";import{a as O}from"./chunk-ETUYVYEI.js";import{b as j}from"./chunk-23BTM2IY.js";import{c as L}from"./chunk-ZWPO54DG.js";import"./chunk-SH266SLM.js";import"./chunk-Z5OW2DIK.js";import{p as $}from"./chunk-DTICAINP.js";import{$ as f,Ca as S,Db as T,Fa as o,Fb as d,Gb as w,Hb as b,Ib as D,Jb as V,Kb as F,Lb as N,Ta as M,W as v,aa as _,bc as Q,eb as C,fb as k,ib as E,jb as P,kb as y,lb as a,ma as u,mb as r,nb as m,rb as q,vb as p,xb as g}from"./chunk-RGAVNK56.js";import{a as h,b as x}from"./chunk-VOSPIT4N.js";var R=(s,t)=>t.id;function H(s,t){if(s&1){let e=q();a(0,"div",17),p("click",function(){let n=f(e).$implicit,l=g();return _(l.addToCart(n))}),a(1,"figure",18),m(2,"img",19),r(),a(3,"div",20)(4,"h3",21),d(5),r(),a(6,"p",22),d(7),r(),a(8,"div",23),d(9),r()()()}if(s&2){let e=t.$implicit;o(2),y("src",e.image_url||"assets/img/no-image.png",S),o(3),w(e.name),o(2),b("$",e.price),o(),T("badge-warning",e.stock<5)("badge-success",e.stock>=5),o(),b(" Stock: ",e.stock," ")}}function J(s,t){s&1&&(a(0,"div",11),m(1,"i",24),a(2,"p"),d(3,"El carrito est\xE1 vac\xEDo"),r()())}function X(s,t){if(s&1){let e=q();a(0,"div",25),m(1,"img",26),a(2,"div",27)(3,"div",28),d(4),r(),a(5,"div",29),d(6),r()(),a(7,"div",30)(8,"button",31),p("click",function(){let n=f(e).$implicit,l=g(2);return _(l.updateQuantity(n.id,-1))}),d(9,"-"),r(),a(10,"span",32),d(11),r(),a(12,"button",31),p("click",function(){let n=f(e).$implicit,l=g(2);return _(l.updateQuantity(n.id,1))}),d(13,"+"),r()(),a(14,"div",33),d(15),r(),a(16,"button",34),p("click",function(){let n=f(e).$implicit,l=g(2);return _(l.removeFromCart(n.id))}),m(17,"i",35),r()()}if(s&2){let e=t.$implicit;o(),y("src",e.image_url||"assets/img/no-image.png",S),o(3),w(e.name),o(2),D("$",e.price," x ",e.quantity),o(5),w(e.quantity),o(4),b(" $",e.price*e.quantity," ")}}function Y(s,t){if(s&1&&E(0,X,18,6,"div",25,R),s&2){let e=g();P(e.cart())}}function Z(s,t){s&1&&m(0,"span",15)}var K=class s{auth=v(O);router=v(L);logger=v(j);products=u([]);cart=u([]);searchQuery=u("");loading=u(!1);processing=u(!1);total=Q(()=>this.cart().reduce((t,e)=>t+e.price*e.quantity,0));async ngOnInit(){await this.loadProducts()}async loadProducts(){this.loading.set(!0);let t=this.auth.getSupabaseClient(),{data:e}=await t.from("products").select("*").eq("is_active",!0).gt("stock",0).order("name");e&&this.products.set(e),this.loading.set(!1)}addToCart(t){this.cart.update(e=>e.find(n=>n.id===t.id)?e.map(n=>n.id===t.id?x(h({},n),{quantity:n.quantity+1}):n):[...e,x(h({},t),{quantity:1})])}removeFromCart(t){this.cart.update(e=>e.filter(i=>i.id!==t))}updateQuantity(t,e){this.cart.update(i=>i.map(n=>{if(n.id===t){let l=n.quantity+e;return l>0?x(h({},n),{quantity:l}):n}return n}))}async checkout(){if(this.cart().length===0)return;this.processing.set(!0);let t=this.auth.getSupabaseClient(),e=this.auth.getCurrentUser();try{let{data:i,error:n}=await t.from("sales").insert({staff_id:e?.id,total_amount:this.total(),status:"completed",payment_method:"cash"}).select().single();if(n)throw n;let l=this.cart().map(c=>({sale_id:i.id,product_id:c.id,quantity:c.quantity,unit_price:c.price,subtotal:c.price*c.quantity})),{error:A}=await t.from("sale_items").insert(l);if(A)throw A;for(let c of this.cart()){let{error:G}=await t.rpc("decrement_stock",{row_id:c.id,amount:c.quantity});if(G){let{data:I}=await t.from("products").select("stock").eq("id",c.id).single();I&&await t.from("products").update({stock:I.stock-c.quantity}).eq("id",c.id)}}await t.from("invoices").insert({sale_id:i.id,total_amount:this.total(),type:"B",issued_at:new Date().toISOString()}),this.cart.set([]),this.router.navigate(["/admin/invoices"])}catch(i){this.logger.error("Checkout error",i),alert("Error al procesar la venta: "+i.message)}finally{this.processing.set(!1)}}filteredProducts(){let t=this.searchQuery().toLowerCase();return this.products().filter(e=>e.name.toLowerCase().includes(t)||e.sku?.toLowerCase().includes(t)||e.barcode?.toLowerCase().includes(t))}static \u0275fac=function(e){return new(e||s)};static \u0275cmp=M({type:s,selectors:[["app-admin-sales-page"]],decls:25,vars:5,consts:[[1,"flex","h-[calc(100vh-6rem)]","gap-6"],[1,"flex-1","flex","flex-col","bg-white","rounded-lg","shadow","overflow-hidden"],[1,"p-4","border-b"],["type","text","placeholder","Buscar producto por nombre, SKU o c\xF3digo de barras...","autofocus","",1,"input","input-bordered","w-full",3,"ngModelChange","ngModel"],[1,"flex-1","overflow-y-auto","p-4"],[1,"grid","grid-cols-2","md:grid-cols-3","lg:grid-cols-4","gap-4"],[1,"card","bg-base-100","shadow-sm","border","hover:shadow-md","cursor-pointer","transition-all","hover:-translate-y-1"],[1,"w-96","bg-white","rounded-lg","shadow","flex","flex-col"],[1,"p-4","border-b","bg-gray-50"],[1,"text-xl","font-bold"],[1,"flex-1","overflow-y-auto","p-4","space-y-4"],[1,"text-center","text-gray-400","py-10"],[1,"p-4","border-t","bg-gray-50"],[1,"flex","justify-between","items-center","mb-4","text-xl","font-bold"],[1,"btn","btn-primary","w-full","btn-lg",3,"click","disabled"],[1,"loading","loading-spinner"],[1,"fas","fa-cash-register","mr-2"],[1,"card","bg-base-100","shadow-sm","border","hover:shadow-md","cursor-pointer","transition-all","hover:-translate-y-1",3,"click"],[1,"px-4","pt-4"],["alt","Product",1,"rounded-xl","h-32","object-contain",3,"src"],[1,"card-body","p-4","text-center"],[1,"font-bold","text-sm","line-clamp-2"],[1,"text-primary","font-bold","mt-2"],[1,"badge","badge-sm"],[1,"fas","fa-shopping-cart","text-4xl","mb-3"],[1,"flex","items-center","gap-3","bg-gray-50","p-2","rounded"],[1,"w-12","h-12","object-cover","rounded",3,"src"],[1,"flex-1","min-w-0"],[1,"font-bold","text-sm","truncate"],[1,"text-xs","text-gray-500"],[1,"flex","items-center","gap-2"],[1,"btn","btn-xs","btn-circle","btn-ghost",3,"click"],[1,"font-bold","w-4","text-center"],[1,"font-bold","text-sm","w-16","text-right"],[1,"btn","btn-xs","btn-circle","btn-ghost","text-red-400",3,"click"],[1,"fas","fa-times"]],template:function(e,i){e&1&&(a(0,"div",0)(1,"div",1)(2,"div",2)(3,"input",3),N("ngModelChange",function(l){return F(i.searchQuery,l)||(i.searchQuery=l),l}),r()(),a(4,"div",4)(5,"div",5),E(6,H,10,8,"div",6,R),r()()(),a(8,"div",7)(9,"div",8)(10,"h2",9),d(11,"Nueva Venta"),r()(),a(12,"div",10),C(13,J,4,0,"div",11)(14,Y,2,0),r(),a(15,"div",12)(16,"div",13)(17,"span"),d(18,"Total"),r(),a(19,"span"),d(20),r()(),a(21,"button",14),p("click",function(){return i.checkout()}),C(22,Z,1,0,"span",15),m(23,"i",16),d(24," Cobrar "),r()()()()),e&2&&(o(3),V("ngModel",i.searchQuery),o(3),P(i.filteredProducts()),o(7),k(i.cart().length===0?13:14),o(7),b("$",i.total()),o(),y("disabled",i.cart().length===0||i.processing()),o(),k(i.processing()?22:-1))},dependencies:[$,z,U,B,W],encapsulation:2})};export{K as AdminSalesPage};
