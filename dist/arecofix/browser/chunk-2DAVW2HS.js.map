{
  "version": 3,
  "sources": ["src/app/features/repairs/application/services/admin-repair.service.ts"],
  "sourcesContent": ["import { Injectable, inject } from '@angular/core';\r\nimport { RepairRepository } from '../../domain/repositories/repair.repository';\r\nimport { Repair, CreateRepairDto, UpdateRepairDto, RepairStatus, RepairPart } from '../../domain/entities/repair.entity';\r\nimport { Observable, firstValueFrom } from 'rxjs';\r\nimport { AuthService } from '@app/core/services/auth.service';\r\n\r\n@Injectable({\r\n    providedIn: 'root'\r\n})\r\nexport class AdminRepairService {\r\n    private repository = inject(RepairRepository);\r\n    private auth = inject(AuthService);\r\n\r\n    // Status logic\r\n    private readonly STATUS_DELIVERED = RepairStatus.DELIVERED;\r\n    private readonly STATUS_CANCELLED = RepairStatus.CANCELLED;\r\n\r\n    async getById(id: string): Promise<Repair> {\r\n        return firstValueFrom(this.repository.getById(id));\r\n    }\r\n\r\n    async getAdminList(limit?: number, offset?: number): Promise<Repair[]> {\r\n        const user = this.auth.getCurrentUser();\r\n        if (!user) throw new Error('Usuario no autenticado');\r\n\r\n        const profile = await this.auth.getUserProfile(user.id);\r\n        const branch_id = profile?.branch_id;\r\n\r\n        return firstValueFrom(this.repository.getAdminList({ branch_id, limit, offset }));\r\n    }\r\n\r\n    async delete(id: string): Promise<void> {\r\n        await firstValueFrom(this.repository.delete(id));\r\n    }\r\n\r\n    async create(dto: CreateRepairDto): Promise<Repair> {\r\n        const user = this.auth.getCurrentUser();\r\n        if (!user) throw new Error('Usuario no autenticado');\r\n\r\n        const profile = await this.auth.getUserProfile(user.id);\r\n        if (!profile) throw new Error('Perfil no encontrado');\r\n\r\n        const payload: any = {\r\n            ...dto,\r\n            branch_id: profile.branch_id,\r\n            received_by: user.id,\r\n            assigned_technician_id: dto.assigned_technician_id || user.id,\r\n            tracking_code: this.generateTrackingCode()\r\n        };\r\n\r\n        // Logic: Set completed_at if status is final\r\n        if (payload.current_status_id && this.isFinalStatus(payload.current_status_id)) {\r\n            payload.completed_at = new Date().toISOString();\r\n        }\r\n\r\n        return firstValueFrom(this.repository.create(payload));\r\n    }\r\n\r\n    async update(id: string, dto: UpdateRepairDto): Promise<void> {\r\n        const payload = { ...dto };\r\n\r\n        // Logic: Set completed_at if status changes to final\r\n        if (payload.current_status_id && this.isFinalStatus(payload.current_status_id)) {\r\n            if (!payload.completed_at) {\r\n                payload.completed_at = new Date().toISOString();\r\n            }\r\n        }\r\n\r\n        await firstValueFrom(this.repository.update(id, payload));\r\n    }\r\n\r\n    async uploadImage(file: File): Promise<string> {\r\n        return this.repository.uploadImage(file);\r\n    }\r\n\r\n    private generateTrackingCode(): string {\r\n        return Math.random().toString(36).substring(2, 10).toUpperCase() + '-' + Date.now().toString(36).toUpperCase();\r\n    }\r\n\r\n    private isFinalStatus(statusId: number): boolean {\r\n        return statusId === this.STATUS_DELIVERED || statusId === this.STATUS_CANCELLED;\r\n    }\r\n}\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;AASM,IAAO,qBAAP,MAAO,oBAAkB;EACnB,aAAa,OAAO,gBAAgB;EACpC,OAAO,OAAO,WAAW;;EAGhB,mBAAmB,aAAa;EAChC,mBAAmB,aAAa;EAEjD,MAAM,QAAQ,IAAU;AACpB,WAAO,eAAe,KAAK,WAAW,QAAQ,EAAE,CAAC;EACrD;EAEA,MAAM,aAAa,OAAgB,QAAe;AAC9C,UAAM,OAAO,KAAK,KAAK,eAAc;AACrC,QAAI,CAAC;AAAM,YAAM,IAAI,MAAM,wBAAwB;AAEnD,UAAM,UAAU,MAAM,KAAK,KAAK,eAAe,KAAK,EAAE;AACtD,UAAM,YAAY,SAAS;AAE3B,WAAO,eAAe,KAAK,WAAW,aAAa,EAAE,WAAW,OAAO,OAAM,CAAE,CAAC;EACpF;EAEA,MAAM,OAAO,IAAU;AACnB,UAAM,eAAe,KAAK,WAAW,OAAO,EAAE,CAAC;EACnD;EAEA,MAAM,OAAO,KAAoB;AAC7B,UAAM,OAAO,KAAK,KAAK,eAAc;AACrC,QAAI,CAAC;AAAM,YAAM,IAAI,MAAM,wBAAwB;AAEnD,UAAM,UAAU,MAAM,KAAK,KAAK,eAAe,KAAK,EAAE;AACtD,QAAI,CAAC;AAAS,YAAM,IAAI,MAAM,sBAAsB;AAEpD,UAAM,UAAe,iCACd,MADc;MAEjB,WAAW,QAAQ;MACnB,aAAa,KAAK;MAClB,wBAAwB,IAAI,0BAA0B,KAAK;MAC3D,eAAe,KAAK,qBAAoB;;AAI5C,QAAI,QAAQ,qBAAqB,KAAK,cAAc,QAAQ,iBAAiB,GAAG;AAC5E,cAAQ,gBAAe,oBAAI,KAAI,GAAG,YAAW;IACjD;AAEA,WAAO,eAAe,KAAK,WAAW,OAAO,OAAO,CAAC;EACzD;EAEA,MAAM,OAAO,IAAY,KAAoB;AACzC,UAAM,UAAU,mBAAK;AAGrB,QAAI,QAAQ,qBAAqB,KAAK,cAAc,QAAQ,iBAAiB,GAAG;AAC5E,UAAI,CAAC,QAAQ,cAAc;AACvB,gBAAQ,gBAAe,oBAAI,KAAI,GAAG,YAAW;MACjD;IACJ;AAEA,UAAM,eAAe,KAAK,WAAW,OAAO,IAAI,OAAO,CAAC;EAC5D;EAEA,MAAM,YAAY,MAAU;AACxB,WAAO,KAAK,WAAW,YAAY,IAAI;EAC3C;EAEQ,uBAAoB;AACxB,WAAO,KAAK,OAAM,EAAG,SAAS,EAAE,EAAE,UAAU,GAAG,EAAE,EAAE,YAAW,IAAK,MAAM,KAAK,IAAG,EAAG,SAAS,EAAE,EAAE,YAAW;EAChH;EAEQ,cAAc,UAAgB;AAClC,WAAO,aAAa,KAAK,oBAAoB,aAAa,KAAK;EACnE;;qCAxES,qBAAkB;EAAA;4EAAlB,qBAAkB,SAAlB,oBAAkB,WAAA,YAFf,OAAM,CAAA;;;sEAET,oBAAkB,CAAA;UAH9B;WAAW;MACR,YAAY;KACf;;;",
  "names": []
}
