import{a as re}from"./chunk-CT2O6UG6.js";import{a as G}from"./chunk-JYOT3LNB.js";import{b as U,d as Q,e as H,f as z,g as J,h as K,i as X,l as Y,m as Z,n as ee,o as te,p as ne,s as ie}from"./chunk-7KJYGRRN.js";import"./chunk-F5WBDNED.js";import"./chunk-F4YL3ILH.js";import{A as j,B as $,l as B,y as R}from"./chunk-RVT6AV4G.js";import{$ as u,$b as g,Ab as n,Bb as i,Cb as _,Fc as q,Ib as A,Mb as x,Ob as v,R as T,Tb as N,Ua as l,W as h,Xb as s,Yb as D,Zb as f,_b as L,aa as c,ac as p,bc as b,gb as I,ma as O,tb as S,ub as C,vb as W,xb as V,yb as k,zb as y}from"./chunk-G4WDTWI7.js";import{a as F,b as P}from"./chunk-7CGTOI24.js";var M=class m{statusTranslations={pending:"Pendiente",processing:"En Reparaci\xF3n",completed:"Listo para retirar",cancelled:"Cancelado"};getStatusLabel(t){return this.statusTranslations[t]||t}generateWhatsAppLink(t,o,e,a,d="tu equipo"){if(!t)return null;let r=t.replace(/\D/g,"");r.length===10&&(r="549"+r),r.startsWith("0")&&(r=r.substring(1),r.length===10&&(r="549"+r));let w=this.getStatusLabel(e),E=`Hola ${o}, te contactamos de Arecofix. 

El estado de tu reparaci\xF3n (Orden #${a}) para ${d} ha cambiado a: *${w}*. 

Cualquier consulta estamos a tu disposici\xF3n.`,ae=encodeURIComponent(E);return`https://wa.me/${r}?text=${ae}`}static \u0275fac=function(o){return new(o||m)};static \u0275prov=T({token:m,factory:m.\u0275fac,providedIn:"root"})};var de=(m,t)=>t.id;function le(m,t){m&1&&(n(0,"div",24),_(1,"i",43),n(2,"p"),s(3,"No hay productos agregados"),i()())}function me(m,t){if(m&1&&(n(0,"option",54),s(1),i()),m&2){let o=t.$implicit;y("value",o.id),l(),L(" ",o.name," (",o.sku,") ")}}function ue(m,t){if(m&1){let o=A();n(0,"tr",50)(1,"td",51)(2,"select",52),x("change",function(a){let d=u(o).$index,r=v(2);return c(r.onProductSelect(d,a.target.value))}),n(3,"option",53),s(4,"Seleccionar producto..."),i(),V(5,me,2,3,"option",54,de),i()(),n(7,"td")(8,"input",55),b("ngModelChange",function(a){let d=u(o).$implicit;return p(d.quantity,a)||(d.quantity=a),c(a)}),x("ngModelChange",function(){let a=u(o).$index,d=v(2);return c(d.onQuantityChange(a))}),i()(),n(9,"td",56),s(10),i(),n(11,"td",57),s(12),i(),n(13,"td",58)(14,"button",59),x("click",function(){let a=u(o).$index,d=v(2);return c(d.removeItem(a))}),_(15,"i",60),i()()()}if(m&2){let o=t.$implicit,e=t.$index,a=v(2);l(2),y("value",o.product_id),l(3),k(a.products),l(3),g("ngModel",o.quantity),y("name","quantity_"+e),l(2),f("$",o.unit_price.toFixed(2)),l(2),f("$",o.subtotal.toFixed(2)," ")}}function ce(m,t){if(m&1&&(n(0,"div",25)(1,"table",44)(2,"thead")(3,"tr",45)(4,"th",46),s(5,"Producto"),i(),n(6,"th",47),s(7,"Cantidad"),i(),n(8,"th",48),s(9,"Precio Unit."),i(),n(10,"th",48),s(11,"Subtotal"),i(),_(12,"th",49),i()(),n(13,"tbody"),V(14,ue,16,5,"tr",50,W),i()()()),m&2){let o=v();l(14),k(o.items())}}function ge(m,t){if(m&1&&(n(0,"div",38),_(1,"i",61),n(2,"span"),s(3),i()()),m&2){let o=v();l(3),D(o.error)}}function pe(m,t){m&1&&_(0,"span",42)}var oe=class m{route=h(R);router=h(j);orderService=h(re);authService=h(G);repairStatusService=h(M);cdr=h(q);id=null;loading=!0;saving=!1;error=null;originalStatus=null;products=[];form=O({customer_name:"",customer_email:"",customer_phone:"",customer_address:"",imei:"",status:"pending",subtotal:0,tax:0,discount:0,total:0,notes:""});items=O([]);async ngOnInit(){this.id=this.route.snapshot.paramMap.get("id"),await this.loadProducts(),this.id&&await this.loadOrder(),this.loading=!1,this.cdr.markForCheck()}async loadProducts(){let t=this.authService.getSupabaseClient(),{data:o,error:e}=await t.from("products").select("id, name, sku, price, stock").eq("is_active",!0).order("name");!e&&o&&(this.products=o)}async loadOrder(){this.id&&this.orderService.getOrderById(this.id).subscribe({next:t=>{this.form.set({customer_name:t.customer_name,customer_email:t.customer_email,customer_phone:t.customer_phone,customer_address:t.customer_address,status:t.status,subtotal:t.subtotal,tax:t.tax,discount:t.discount,total:t.total,notes:t.notes,imei:t.imei||""}),this.items.set(t.items),this.originalStatus=t.status,this.cdr.markForCheck()},error:t=>{this.error=t.message||"Error desconocido",this.cdr.markForCheck()}})}addItem(){this.items.update(t=>[...t,{product_name:"",quantity:1,unit_price:0,subtotal:0}]),this.cdr.markForCheck()}removeItem(t){this.items.update(o=>o.filter((e,a)=>a!==t)),this.calculateTotals()}onProductSelect(t,o){let e=this.products.find(a=>a.id===o);e&&(this.items.update(a=>{let d=[...a];return d[t]=P(F({},d[t]),{product_id:e.id,product_name:e.name,product_sku:e.sku,unit_price:e.price,subtotal:e.price*d[t].quantity}),d}),this.calculateTotals())}onQuantityChange(t){this.items.update(o=>{let e=[...o];return e[t].subtotal=e[t].unit_price*e[t].quantity,e}),this.calculateTotals()}calculateTotals(){let t=this.items().reduce((w,E)=>w+E.subtotal,0),o=this.form().discount||0,e=.21,a=t-o,d=a*e,r=a+d;this.form.update(w=>P(F({},w),{subtotal:t,tax:d,total:r})),this.cdr.markForCheck()}async save(){if(this.items().length===0){this.error="Debes agregar al menos un producto",this.cdr.markForCheck();return}this.saving=!0,this.error=null;try{let t;this.id?t=await this.orderService.updateOrder(this.id,this.form(),this.items()):t=await this.orderService.createOrder(this.form(),this.items());let{error:o}=t;if(o)throw o;if(this.id&&this.originalStatus&&this.form().status!==this.originalStatus){let e=this.form(),a=this.items().length>0?this.items()[0].product_name:"tu equipo",d=this.repairStatusService.generateWhatsAppLink(e.customer_phone||"",e.customer_name,e.status,this.id.substring(0,8).toUpperCase(),a);d&&window.open(d,"_blank")}this.router.navigate(["/admin/orders"])}catch(t){this.error=t.message||"Error al guardar pedido",this.saving=!1,this.cdr.markForCheck()}}static \u0275fac=function(o){return new(o||m)};static \u0275cmp=I({type:m,selectors:[["app-admin-order-form-page"]],decls:93,vars:18,consts:[["f","ngForm"],[1,"max-w-4xl","mx-auto","text-base-content"],[1,"text-2xl","font-bold","mb-6","text-green-600"],[3,"ngSubmit"],[1,"bg-base-100","p-6","rounded-xl","shadow-sm","border","border-base-200","mb-6","text-base-content"],[1,"text-lg","font-semibold","mb-4","text-base-content","border-b","border-base-200","pb-2"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-6"],[1,"block","text-sm","font-medium","text-base-content","mb-1.5"],["type","text","name","customer_name","required","",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["type","email","name","customer_email","required","",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["type","tel","name","customer_phone",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["type","text","name","customer_address",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],[1,"col-span-1","md:col-span-2"],["type","text","name","imei","placeholder","Ej: 3520190...",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],[1,"md:col-span-2"],["name","status",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["value","pending"],["value","processing"],["value","completed"],["value","cancelled"],[1,"flex","justify-between","items-center","mb-4","border-b","border-base-200","pb-2"],[1,"text-lg","font-semibold","text-base-content"],["type","button",1,"btn","btn-sm","btn-primary",3,"click"],[1,"fas","fa-plus","mr-2"],[1,"text-center","py-8","text-gray-500","bg-gray-50","rounded-lg","border","border-dashed","border-gray-300"],[1,"overflow-x-auto"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-8"],[1,"space-y-4"],["type","number","name","discount","min","0","step","0.01",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["name","notes","rows","3",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],[1,"bg-base-200","p-6","rounded-xl","border","border-base-300","h-fit"],[1,"space-y-3"],[1,"flex","justify-between","text-base-content/80"],[1,"font-mono","font-medium"],[1,"font-mono","font-medium","text-error"],[1,"divider","my-2"],[1,"flex","justify-between","text-xl","font-bold","text-base-content"],[1,"font-mono","text-primary"],[1,"alert","alert-error","mb-6"],[1,"flex","gap-4","justify-end","mb-8"],["routerLink","/admin/orders",1,"btn","btn-error","text-white"],["type","submit",1,"btn","btn-primary","px-8",3,"disabled"],[1,"loading","loading-spinner","loading-xs","mr-2"],[1,"fas","fa-box-open","text-4xl","mb-2","text-gray-400"],[1,"table","w-full"],[1,"text-base-content","border-b-2","border-base-200"],[1,"font-semibold"],[1,"font-semibold","w-24"],[1,"font-semibold","text-right"],[1,"w-10"],[1,"border-b","border-base-200","hover:bg-base-200/50"],[1,"min-w-[200px]"],["required","",1,"select","select-bordered","select-sm","w-full","bg-base-100","text-base-content","border-base-300",3,"change","value"],["value",""],[3,"value"],["type","number","min","1",1,"input","input-bordered","input-sm","w-full","bg-base-100","text-base-content","border-base-300",3,"ngModelChange","ngModel","name"],[1,"font-mono","text-right","text-base-content/80"],[1,"font-mono","font-semibold","text-right","text-base-content"],[1,"text-right"],["type","button",1,"btn","btn-ghost","btn-sm","btn-circle","text-error","hover:bg-red-50",3,"click"],[1,"fas","fa-trash"],[1,"fas","fa-exclamation-circle"]],template:function(o,e){if(o&1){let a=A();n(0,"div",1)(1,"h2",2),s(2),i(),n(3,"form",3,0),x("ngSubmit",function(){return u(a),c(e.save())}),n(5,"div",4)(6,"h3",5),s(7,"Informaci\xF3n del Cliente"),i(),n(8,"div",6)(9,"div")(10,"label",7),s(11,"Nombre *"),i(),n(12,"input",8),b("ngModelChange",function(r){return u(a),p(e.form().customer_name,r)||(e.form().customer_name=r),c(r)}),i()(),n(13,"div")(14,"label",7),s(15,"Email *"),i(),n(16,"input",9),b("ngModelChange",function(r){return u(a),p(e.form().customer_email,r)||(e.form().customer_email=r),c(r)}),i()(),n(17,"div")(18,"label",7),s(19,"Tel\xE9fono"),i(),n(20,"input",10),b("ngModelChange",function(r){return u(a),p(e.form().customer_phone,r)||(e.form().customer_phone=r),c(r)}),i()(),n(21,"div")(22,"label",7),s(23,"Direcci\xF3n"),i(),n(24,"input",11),b("ngModelChange",function(r){return u(a),p(e.form().customer_address,r)||(e.form().customer_address=r),c(r)}),i()(),n(25,"div",12)(26,"label",7),s(27,"IMEI / S/N del Dispositivo"),i(),n(28,"input",13),b("ngModelChange",function(r){return u(a),p(e.form().imei,r)||(e.form().imei=r),c(r)}),i()(),n(29,"div",14)(30,"label",7),s(31,"Estado"),i(),n(32,"select",15),b("ngModelChange",function(r){return u(a),p(e.form().status,r)||(e.form().status=r),c(r)}),n(33,"option",16),s(34,"Pendiente"),i(),n(35,"option",17),s(36,"Procesando"),i(),n(37,"option",18),s(38,"Completado"),i(),n(39,"option",19),s(40,"Cancelado"),i()()()()(),n(41,"div",4)(42,"div",20)(43,"h3",21),s(44,"Productos"),i(),n(45,"button",22),x("click",function(){return u(a),c(e.addItem())}),_(46,"i",23),s(47," Agregar Producto "),i()(),S(48,le,4,0,"div",24)(49,ce,16,0,"div",25),i(),n(50,"div",4)(51,"h3",5),s(52,"Totales y Notas"),i(),n(53,"div",26)(54,"div",27)(55,"div")(56,"label",7),s(57,"Descuento"),i(),n(58,"input",28),b("ngModelChange",function(r){return u(a),p(e.form().discount,r)||(e.form().discount=r),c(r)}),x("ngModelChange",function(){return u(a),c(e.calculateTotals())}),i()(),n(59,"div")(60,"label",7),s(61,"Notas"),i(),n(62,"textarea",29),b("ngModelChange",function(r){return u(a),p(e.form().notes,r)||(e.form().notes=r),c(r)}),i()()(),n(63,"div",30)(64,"div",31)(65,"div",32)(66,"span"),s(67,"Subtotal:"),i(),n(68,"span",33),s(69),i()(),n(70,"div",32)(71,"span"),s(72,"Descuento:"),i(),n(73,"span",34),s(74),i()(),n(75,"div",32)(76,"span"),s(77,"IVA (21%):"),i(),n(78,"span",33),s(79),i()(),_(80,"div",35),n(81,"div",36)(82,"span"),s(83,"Total:"),i(),n(84,"span",37),s(85),i()()()()()(),S(86,ge,4,1,"div",38),n(87,"div",39)(88,"a",40),s(89,"Cancelar"),i(),n(90,"button",41),S(91,pe,1,0,"span",42),s(92),i()()()()}if(o&2){let a=N(4);l(2),f("",e.id?"Editar":"Nuevo"," Pedido"),l(10),g("ngModel",e.form().customer_name),l(4),g("ngModel",e.form().customer_email),l(4),g("ngModel",e.form().customer_phone),l(4),g("ngModel",e.form().customer_address),l(4),g("ngModel",e.form().imei),l(4),g("ngModel",e.form().status),l(16),C(e.items().length===0?48:49),l(10),g("ngModel",e.form().discount),l(4),g("ngModel",e.form().notes),l(7),f("$",e.form().subtotal.toFixed(2)),l(5),f("-$",e.form().discount.toFixed(2)),l(5),f("$",e.form().tax.toFixed(2)),l(6),f("$",e.form().total.toFixed(2)),l(),C(e.error?86:-1),l(4),y("disabled",e.saving||a.invalid),l(),C(e.saving?91:-1),l(),f(" ",e.saving?"Guardando...":"Guardar Pedido"," ")}},dependencies:[ie,K,Z,ee,U,X,Y,Q,H,ne,te,J,z,$,B],encapsulation:2,changeDetection:0})};export{oe as AdminOrderFormPage};
