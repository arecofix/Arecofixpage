{
  "version": 3,
  "sources": ["src/app/core/services/seo.service.ts"],
  "sourcesContent": ["import { Injectable, inject, PLATFORM_ID, makeStateKey, TransferState } from '@angular/core';\r\nimport { Title, Meta } from '@angular/platform-browser';\r\nimport { Router, NavigationEnd, ActivatedRoute } from '@angular/router';\r\nimport { DOCUMENT, isPlatformServer } from '@angular/common';\r\nimport { filter, map, mergeMap } from 'rxjs/operators';\r\nimport { environment } from '../../../environments/environment';\r\n\r\nexport interface SeoData {\r\n  title: string;\r\n  description: string;\r\n  imageUrl?: string;\r\n  type?: 'website' | 'product' | 'article' | 'profile';\r\n  keywords?: string;\r\n  url?: string; // Optional override\r\n  schema?: Record<string, any>;\r\n  author?: string;\r\n  twitterCard?: 'summary' | 'summary_large_image' | 'app' | 'player';\r\n}\r\n\r\nconst SEO_DATA_KEY = makeStateKey<SeoData>('SEO_DATA');\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class SeoService {\r\n  private titleService = inject(Title);\r\n  private metaService = inject(Meta);\r\n  private router = inject(Router);\r\n  private activatedRoute = inject(ActivatedRoute);\r\n  private document = inject(DOCUMENT);\r\n  private platformId = inject(PLATFORM_ID);\r\n  private transferState = inject(TransferState);\r\n\r\n  constructor() {\r\n    // Service is singleton, initialization logic moved to separate method \r\n    // to allow explicit control from AppComponent as requested.\r\n  }\r\n\r\n  /**\r\n   * Initializes the SEO service.\r\n   * Subscribes to router events to automatically update tags.\r\n   * Must be called once from AppComponent.\r\n   */\r\n  public initialize() {\r\n    // 1. Check if we have TransferState data (Client Side Hydration)\r\n    // This prevents flickering on the client side if the server already rendered the tags.\r\n    if (!isPlatformServer(this.platformId)) {\r\n      const serverSeoData = this.transferState.get(SEO_DATA_KEY, null);\r\n      if (serverSeoData) {\r\n        this.setPageData(serverSeoData);\r\n      }\r\n    }\r\n\r\n    // 2. Subscribe to Route Changes\r\n    this.router.events.pipe(\r\n      filter(event => event instanceof NavigationEnd),\r\n      map(() => this.getContentRoute(this.activatedRoute)),\r\n      filter(route => route.outlet === 'primary'),\r\n      mergeMap(route => route.data)\r\n    ).subscribe(data => {\r\n      if (data['seo']) {\r\n        const seoData = data['seo'] as SeoData;\r\n        this.setPageData(seoData);\r\n\r\n        // If running on Server, save to TransferState for the Client\r\n        if (isPlatformServer(this.platformId)) {\r\n          this.transferState.set(SEO_DATA_KEY, seoData);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Recursively traverses the route tree to find the last child (the actual page component).\r\n   */\r\n  private getContentRoute(route: ActivatedRoute): ActivatedRoute {\r\n    while (route.firstChild) {\r\n      route = route.firstChild;\r\n    }\r\n    return route;\r\n  }\r\n\r\n  /**\r\n   * Sets all SEO metadata for the current page.\r\n   */\r\n  public setPageData(data: SeoData) {\r\n    const { \r\n        title, \r\n        description, \r\n        imageUrl, \r\n        type = 'website', \r\n        keywords, \r\n        schema,\r\n        url,\r\n        author,\r\n        twitterCard = 'summary_large_image'\r\n    } = data;\r\n    \r\n    // 0. Cleanup previous state\r\n    // Note: Angular's Meta service `updateTag` will replace existing tags with the same name/property,\r\n    // so explicit removal is only needed for tags that might not be present in the new data.\r\n    \r\n    // 1. Set Browser Title\r\n    const finalTitle = title.includes('|') || title.includes('Arecofix') ? title : `${title} | Arecofix`;\r\n    this.titleService.setTitle(finalTitle);\r\n\r\n    // 2. Set Meta Description\r\n    this.metaService.updateTag({ name: 'description', content: description });\r\n\r\n    // 3. Keywords\r\n    if (keywords) {\r\n      this.metaService.updateTag({ name: 'keywords', content: keywords });\r\n    }\r\n\r\n    // 4. Author\r\n    if (author) {\r\n        this.metaService.updateTag({ name: 'author', content: author });\r\n    }\r\n\r\n    // 5. Construct Canonical & Image URLs\r\n    const currentPath = url || this.router.url;\r\n    const finalUrl = currentPath.startsWith('http') ? currentPath : `${environment.baseUrl}${currentPath}`;\r\n    \r\n    // Handle Image URL: if it's relative, append baseUrl. Use default if missing.\r\n    let finalImageUrl = 'assets/img/branding/og-services.jpg'; // Default valid image\r\n    if (imageUrl) {\r\n        finalImageUrl = imageUrl;\r\n    }\r\n    if (!finalImageUrl.startsWith('http')) {\r\n        // Ensure strictly no double slashes if imageUrl starts with /\r\n        const cleanPath = finalImageUrl.startsWith('/') ? finalImageUrl.substring(1) : finalImageUrl;\r\n        finalImageUrl = `${environment.baseUrl}/${cleanPath}`;\r\n    }\r\n\r\n    // 6. Set Social Media Tags (Open Graph)\r\n    this.metaService.updateTag({ property: 'og:title', content: finalTitle });\r\n    this.metaService.updateTag({ property: 'og:description', content: description });\r\n    this.metaService.updateTag({ property: 'og:type', content: type });\r\n    this.metaService.updateTag({ property: 'og:url', content: finalUrl });\r\n    this.metaService.updateTag({ property: 'og:image', content: finalImageUrl });\r\n    if (finalImageUrl.startsWith('https')) {\r\n        this.metaService.updateTag({ property: 'og:image:secure_url', content: finalImageUrl });\r\n    }\r\n    this.metaService.updateTag({ property: 'og:site_name', content: 'Arecofix' });\r\n\r\n    // 7. Twitter Cards\r\n    this.metaService.updateTag({ name: 'twitter:card', content: twitterCard });\r\n    this.metaService.updateTag({ name: 'twitter:title', content: finalTitle });\r\n    this.metaService.updateTag({ name: 'twitter:description', content: description });\r\n    this.metaService.updateTag({ name: 'twitter:image', content: finalImageUrl });\r\n\r\n    // 8. Canonical URL\r\n    this.setCanonicalUrl(finalUrl);\r\n\r\n    // 9. Structured Data (JSON-LD)\r\n    if (schema) {\r\n      this.injectJsonLd(schema);\r\n    } else {\r\n        this.removeJsonLd();\r\n    }\r\n  }\r\n\r\n  private setCanonicalUrl(url: string) {\r\n    let link: HTMLLinkElement | null = this.document.querySelector('link[rel=\"canonical\"]');\r\n    if (!link) {\r\n        link = this.document.createElement('link');\r\n        link.setAttribute('rel', 'canonical');\r\n        this.document.head.appendChild(link);\r\n    }\r\n    link.setAttribute('href', url);\r\n  }\r\n\r\n  private injectJsonLd(schema: Record<string, any>) {\r\n    const scriptId = 'json-ld-schema';\r\n    let script = this.document.getElementById(scriptId) as HTMLScriptElement;\r\n\r\n    if (!script) {\r\n        script = this.document.createElement('script');\r\n        script.id = scriptId;\r\n        script.type = 'application/ld+json';\r\n        this.document.head.appendChild(script);\r\n    }\r\n\r\n    script.text = JSON.stringify(schema);\r\n  }\r\n\r\n  private removeJsonLd() {\r\n    const script = this.document.getElementById('json-ld-schema');\r\n    if (script) {\r\n      script.remove();\r\n    }\r\n  }\r\n}\r\n\r\n"],
  "mappings": "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",
  "names": []
}
