import{b as U,d as B,g as W,s as z}from"./chunk-VC54SGJZ.js";import{a as O}from"./chunk-SFGK2H4E.js";import{a as j}from"./chunk-RLEXB5XQ.js";import{g as L}from"./chunk-UWELTD43.js";import"./chunk-KREPGFQR.js";import"./chunk-T7AXESXA.js";import{r as $}from"./chunk-IZ4CGVWK.js";import{$b as D,Ab as P,Bb as v,Cb as a,Db as r,Eb as m,Kb as q,Ob as p,Qb as g,Ra as S,Wa as o,Wb as T,Y as y,Yb as l,Zb as w,_b as _,ac as V,ba as f,bc as F,ca as x,cc as N,ib as M,oa as u,vb as C,vc as Q,wb as k,zb as E}from"./chunk-IZKGPZFC.js";import{a as h,b}from"./chunk-VOSPIT4N.js";var R=(s,t)=>t.id;function H(s,t){if(s&1){let e=q();a(0,"div",17),p("click",function(){let n=f(e).$implicit,d=g();return x(d.addToCart(n))}),a(1,"figure",18),m(2,"img",19),r(),a(3,"div",20)(4,"h3",21),l(5),r(),a(6,"p",22),l(7),r(),a(8,"div",23),l(9),r()()()}if(s&2){let e=t.$implicit;o(2),v("src",e.image_url||"assets/img/no-image.png",S),o(3),w(e.name),o(2),_("$",e.price),o(),T("badge-warning",e.stock<5)("badge-success",e.stock>=5),o(),_(" Stock: ",e.stock," ")}}function J(s,t){s&1&&(a(0,"div",11),m(1,"i",24),a(2,"p"),l(3,"El carrito est\xE1 vac\xEDo"),r()())}function X(s,t){if(s&1){let e=q();a(0,"div",25),m(1,"img",26),a(2,"div",27)(3,"div",28),l(4),r(),a(5,"div",29),l(6),r()(),a(7,"div",30)(8,"button",31),p("click",function(){let n=f(e).$implicit,d=g(2);return x(d.updateQuantity(n.id,-1))}),l(9,"-"),r(),a(10,"span",32),l(11),r(),a(12,"button",31),p("click",function(){let n=f(e).$implicit,d=g(2);return x(d.updateQuantity(n.id,1))}),l(13,"+"),r()(),a(14,"div",33),l(15),r(),a(16,"button",34),p("click",function(){let n=f(e).$implicit,d=g(2);return x(d.removeFromCart(n.id))}),m(17,"i",35),r()()}if(s&2){let e=t.$implicit;o(),v("src",e.image_url||"assets/img/no-image.png",S),o(3),w(e.name),o(2),D("$",e.price," x ",e.quantity),o(5),w(e.quantity),o(4),_(" $",e.price*e.quantity," ")}}function Y(s,t){if(s&1&&E(0,X,18,6,"div",25,R),s&2){let e=g();P(e.cart())}}function Z(s,t){s&1&&m(0,"span",15)}var K=class s{auth=y(O);router=y(L);logger=y(j);products=u([]);cart=u([]);searchQuery=u("");loading=u(!1);processing=u(!1);total=Q(()=>this.cart().reduce((t,e)=>t+e.price*e.quantity,0));async ngOnInit(){await this.loadProducts()}async loadProducts(){this.loading.set(!0);let t=this.auth.getSupabaseClient(),{data:e}=await t.from("products").select("*").eq("is_active",!0).gt("stock",0).order("name");e&&this.products.set(e),this.loading.set(!1)}addToCart(t){this.cart.update(e=>e.find(n=>n.id===t.id)?e.map(n=>n.id===t.id?b(h({},n),{quantity:n.quantity+1}):n):[...e,b(h({},t),{quantity:1})])}removeFromCart(t){this.cart.update(e=>e.filter(i=>i.id!==t))}updateQuantity(t,e){this.cart.update(i=>i.map(n=>{if(n.id===t){let d=n.quantity+e;return d>0?b(h({},n),{quantity:d}):n}return n}))}async checkout(){if(this.cart().length===0)return;this.processing.set(!0);let t=this.auth.getSupabaseClient(),e=this.auth.getCurrentUser();try{let{data:i,error:n}=await t.from("sales").insert({staff_id:e?.id,total_amount:this.total(),status:"completed",payment_method:"cash"}).select().single();if(n)throw n;let d=this.cart().map(c=>({sale_id:i.id,product_id:c.id,quantity:c.quantity,unit_price:c.price,subtotal:c.price*c.quantity})),{error:A}=await t.from("sale_items").insert(d);if(A)throw A;for(let c of this.cart()){let{error:G}=await t.rpc("decrement_stock",{row_id:c.id,amount:c.quantity});if(G){let{data:I}=await t.from("products").select("stock").eq("id",c.id).single();I&&await t.from("products").update({stock:I.stock-c.quantity}).eq("id",c.id)}}await t.from("invoices").insert({sale_id:i.id,total_amount:this.total(),type:"B",issued_at:new Date().toISOString()}),this.cart.set([]),this.router.navigate(["/admin/invoices"])}catch(i){this.logger.error("Checkout error",i),alert("Error al procesar la venta: "+i.message)}finally{this.processing.set(!1)}}filteredProducts(){let t=this.searchQuery().toLowerCase();return this.products().filter(e=>e.name.toLowerCase().includes(t)||e.sku?.toLowerCase().includes(t)||e.barcode?.toLowerCase().includes(t))}static \u0275fac=function(e){return new(e||s)};static \u0275cmp=M({type:s,selectors:[["app-admin-sales-page"]],decls:25,vars:5,consts:[[1,"flex","h-[calc(100vh-6rem)]","gap-6"],[1,"flex-1","flex","flex-col","bg-white","rounded-lg","shadow","overflow-hidden","text-gray-800","dark:text-white"],[1,"p-4","border-b"],["type","text","placeholder","Buscar producto por nombre, SKU o c\xF3digo de barras...","autofocus","",1,"input","input-bordered","w-full","bg-white","text-gray-800","dark:text-white","dark:bg-gray-700",3,"ngModelChange","ngModel"],[1,"flex-1","overflow-y-auto","p-4"],[1,"grid","grid-cols-2","md:grid-cols-3","lg:grid-cols-4","gap-4"],[1,"card","bg-white","shadow-sm","border","hover:shadow-md","cursor-pointer","transition-all","hover:-translate-y-1"],[1,"w-96","bg-white","rounded-lg","shadow","flex","flex-col","text-gray-800","dark:text-white"],[1,"p-4","border-b","bg-gray-50"],[1,"text-xl","font-bold","text-gray-800","dark:text-white"],[1,"flex-1","overflow-y-auto","p-4","space-y-4"],[1,"text-center","text-gray-400","py-10"],[1,"p-4","border-t","bg-gray-50"],[1,"flex","justify-between","items-center","mb-4","text-xl","font-bold","text-gray-800","dark:text-white"],[1,"btn","btn-primary","w-full","btn-lg",3,"click","disabled"],[1,"loading","loading-spinner"],[1,"fas","fa-cash-register","mr-2"],[1,"card","bg-white","shadow-sm","border","hover:shadow-md","cursor-pointer","transition-all","hover:-translate-y-1",3,"click"],[1,"px-4","pt-4"],["alt","Product",1,"rounded-xl","h-32","object-contain",3,"src"],[1,"card-body","p-4","text-center"],[1,"font-bold","text-sm","line-clamp-2","text-gray-800","dark:text-white"],[1,"text-primary","font-bold","mt-2"],[1,"badge","badge-sm"],[1,"fas","fa-shopping-cart","text-4xl","mb-3"],[1,"flex","items-center","gap-3","bg-gray-50","p-2","rounded"],[1,"w-12","h-12","object-cover","rounded",3,"src"],[1,"flex-1","min-w-0"],[1,"font-bold","text-sm","truncate","text-gray-800","dark:text-white"],[1,"text-xs","text-gray-500"],[1,"flex","items-center","gap-2"],[1,"btn","btn-xs","btn-circle","btn-ghost","text-gray-600",3,"click"],[1,"font-bold","w-4","text-center","text-gray-800","dark:text-white"],[1,"font-bold","text-sm","w-16","text-right","text-gray-800","dark:text-white"],[1,"btn","btn-xs","btn-circle","btn-ghost","text-red-400",3,"click"],[1,"fas","fa-times"]],template:function(e,i){e&1&&(a(0,"div",0)(1,"div",1)(2,"div",2)(3,"input",3),N("ngModelChange",function(d){return F(i.searchQuery,d)||(i.searchQuery=d),d}),r()(),a(4,"div",4)(5,"div",5),E(6,H,10,8,"div",6,R),r()()(),a(8,"div",7)(9,"div",8)(10,"h2",9),l(11,"Nueva Venta"),r()(),a(12,"div",10),C(13,J,4,0,"div",11)(14,Y,2,0),r(),a(15,"div",12)(16,"div",13)(17,"span"),l(18,"Total"),r(),a(19,"span"),l(20),r()(),a(21,"button",14),p("click",function(){return i.checkout()}),C(22,Z,1,0,"span",15),m(23,"i",16),l(24," Cobrar "),r()()()()),e&2&&(o(3),V("ngModel",i.searchQuery),o(3),P(i.filteredProducts()),o(7),k(i.cart().length===0?13:14),o(7),_("$",i.total()),o(),v("disabled",i.cart().length===0||i.processing()),o(),k(i.processing()?22:-1))},dependencies:[$,z,U,B,W],encapsulation:2})};export{K as AdminSalesPage};
