import{b as B,d as j,e as G,f as U,g as z,h as H,i as J,l as K,m as Q,n as X,o as Y,p as Z,s as ee}from"./chunk-LSPUXVBI.js";import{a as L}from"./chunk-4HXPTVC3.js";import"./chunk-773BQMTG.js";import"./chunk-NIOBXWFE.js";import{d as O,e as R}from"./chunk-755N3HP6.js";import{i as $,o as W}from"./chunk-P77MY6VE.js";import{$b as D,Ab as v,Bb as c,Cb as i,Db as r,Eb as _,Kb as q,Ob as p,Qb as g,Wa as s,Y as C,Yb as l,Zb as F,_b as E,ac as y,ba as b,bc as S,ca as f,cc as P,ib as N,nb as h,oa as u,vb as M,wb as w,wc as V,xb as k,zb as x}from"./chunk-OOA6GWW3.js";import{a as I,b as T}from"./chunk-7CGTOI24.js";var ie=(o,n)=>n.id;function ne(o,n){if(o&1&&(i(0,"div",6),_(1,"i",29),i(2,"span"),l(3),r()()),o&2){let e=g();s(3),F(e.error())}}function re(o,n){if(o&1&&(i(0,"option",13),l(1),r()),o&2){let e=n.$implicit;c("value",e.id),s(),F(e.name)}}function ae(o,n){o&1&&(i(0,"label",41),l(1,"Producto"),r())}function oe(o,n){if(o&1&&(i(0,"option",13),l(1),r()),o&2){let e=n.$implicit;c("value",e.id),s(),D("",e.name," (Stock: ",e.stock,")")}}function se(o,n){o&1&&(i(0,"label",41),l(1,"Cantidad"),r())}function le(o,n){o&1&&(i(0,"label",41),l(1,"Costo Unit."),r())}function de(o,n){if(o&1){let e=q();i(0,"div",20)(1,"div",30),h(2,ae,2,0,"label",31),i(3,"select",32),p("ngModelChange",function(d){let a=b(e).$index,m=g();return f(m.updateItem(a,"product_id",d))}),i(4,"option",33),l(5,"Seleccionar Producto"),r(),x(6,oe,2,3,"option",13,ie),r()(),i(8,"div",34),h(9,se,2,0,"label",31),i(10,"input",35),p("ngModelChange",function(d){let a=b(e).$index,m=g();return f(m.updateItem(a,"quantity",d))}),r()(),i(11,"div",36),h(12,le,2,0,"label",31),i(13,"input",37),p("ngModelChange",function(d){let a=b(e).$index,m=g();return f(m.updateItem(a,"unit_cost",d))}),r()(),i(14,"div",38),l(15),r(),i(16,"button",39),p("click",function(){let d=b(e).$index,a=g();return f(a.removeItem(d))}),_(17,"i",40),r()()}if(o&2){let e=n.$implicit,t=n.$index,d=g();s(2),c("ngIf",t===0),s(),c("ngModel",e.product_id)("name","product_"+t),s(3),v(d.products()),s(3),c("ngIf",t===0),s(),c("ngModel",e.quantity)("name","qty_"+t),s(2),c("ngIf",t===0),s(),c("ngModel",e.unit_cost)("name","cost_"+t),s(2),E(" $",e.quantity*e.unit_cost," ")}}function me(o,n){o&1&&_(0,"span",28)}var te=class o{auth=C(L);router=C(O);suppliers=u([]);products=u([]);form=u({supplier_id:"",purchase_date:new Date().toISOString().split("T")[0],status:"received"});items=u([]);loading=u(!0);saving=u(!1);error=u(null);total=V(()=>this.items().reduce((n,e)=>n+e.quantity*e.unit_cost,0));async ngOnInit(){let n=this.auth.getSupabaseClient(),[e,t]=await Promise.all([n.from("suppliers").select("*").eq("is_active",!0),n.from("products").select("*").eq("is_active",!0)]);e.data&&this.suppliers.set(e.data),t.data&&this.products.set(t.data),this.loading.set(!1)}addItem(){this.items.update(n=>[...n,{product_id:"",quantity:1,unit_cost:0}])}removeItem(n){this.items.update(e=>e.filter((t,d)=>d!==n))}updateItem(n,e,t){this.items.update(d=>{let a=[...d];return a[n]=T(I({},a[n]),{[e]:t}),a})}async save(){if(this.items().length===0){this.error.set("Debe agregar al menos un producto");return}if(!this.form().supplier_id){this.error.set("Debe seleccionar un proveedor");return}this.saving.set(!0),this.error.set(null);let n=this.auth.getSupabaseClient();try{let{data:e,error:t}=await n.from("purchases").insert({supplier_id:this.form().supplier_id,purchase_date:this.form().purchase_date,status:this.form().status,total_amount:this.total()}).select().single();if(t)throw t;let d=this.items().map(m=>({purchase_id:e.id,product_id:m.product_id,quantity:m.quantity,unit_cost:m.unit_cost})),{error:a}=await n.from("purchase_items").insert(d);if(a)throw a;if(this.form().status==="received")for(let m of this.items()){let{data:A}=await n.from("products").select("stock").eq("id",m.product_id).single();A&&await n.from("products").update({stock:A.stock+m.quantity}).eq("id",m.product_id)}this.router.navigate(["/admin/purchases"])}catch(e){this.error.set(e.message)}finally{this.saving.set(!1)}}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=N({type:o,selectors:[["app-admin-purchase-form-page"]],decls:47,vars:7,consts:[[1,"max-w-4xl","mx-auto","text-base-content"],[1,"flex","items-center","gap-4","mb-6"],["routerLink","/admin/purchases",1,"btn","btn-circle","btn-ghost","text-base-content"],[1,"fas","fa-arrow-left"],[1,"text-2xl","font-bold","text-green-600"],[1,"bg-base-100","rounded-lg","shadow","p-6","text-base-content"],[1,"alert","alert-error","mb-4"],[1,"space-y-6",3,"ngSubmit"],[1,"grid","grid-cols-1","md:grid-cols-3","gap-6"],[1,"form-control"],[1,"label","text-base-content"],["name","supplier_id","required","",1,"select","select-bordered","bg-base-100","text-base-content","border-base-300",3,"ngModelChange","ngModel"],["value","","disabled","","selected",""],[1,"text-gray-900","bg-white","dark:text-white","dark:bg-gray-800",3,"value"],["type","date","name","purchase_date","required","",1,"input","input-bordered","bg-base-100","text-base-content","border-base-300",3,"ngModelChange","ngModel"],["name","status",1,"select","select-bordered","bg-base-100","text-base-content","border-base-300",3,"ngModelChange","ngModel"],["value","received"],["value","ordered"],[1,"divider"],[1,"space-y-4"],[1,"flex","gap-4","items-end","bg-base-200","p-4","rounded","text-base-content"],["type","button",1,"btn","btn-outline","btn-sm","w-full","border-dashed",3,"click"],[1,"fas","fa-plus","mr-2"],[1,"flex","justify-between","items-center","mt-8","pt-4","border-t"],[1,"text-2xl","font-bold"],[1,"flex","gap-4"],["routerLink","/admin/purchases",1,"btn","btn-error","text-white"],["type","submit",1,"btn","btn-primary",3,"disabled"],[1,"loading","loading-spinner"],[1,"fas","fa-exclamation-circle"],[1,"form-control","flex-1"],["class","label text-xs text-base-content/70",4,"ngIf"],[1,"select","select-bordered","w-full","select-sm","bg-base-100","text-base-content","border-base-300",3,"ngModelChange","ngModel","name"],["value","","disabled","","selected","",1,"text-gray-400"],[1,"form-control","w-24"],["type","number","min","1",1,"input","input-bordered","input-sm","bg-base-100","text-base-content","border-base-300",3,"ngModelChange","ngModel","name"],[1,"form-control","w-32"],["type","number","min","0",1,"input","input-bordered","input-sm","bg-base-100","text-base-content","border-base-300",3,"ngModelChange","ngModel","name"],[1,"w-24","text-right","font-bold","text-sm","pb-2","text-base-content"],["type","button",1,"btn","btn-ghost","btn-sm","text-error","hover:bg-base-300",3,"click"],[1,"fas","fa-trash"],[1,"label","text-xs","text-base-content/70"]],template:function(e,t){e&1&&(i(0,"div",0)(1,"div",1)(2,"a",2),_(3,"i",3),r(),i(4,"h1",4),l(5,"Registrar Compra"),r()(),i(6,"div",5),M(7,ne,4,1,"div",6),i(8,"form",7),p("ngSubmit",function(){return t.save()}),i(9,"div",8)(10,"div",9)(11,"label",10),l(12,"Proveedor"),r(),i(13,"select",11),P("ngModelChange",function(a){return S(t.form().supplier_id,a)||(t.form().supplier_id=a),a}),i(14,"option",12),l(15,"Seleccionar Proveedor"),r(),x(16,re,2,2,"option",13,ie),r()(),i(18,"div",9)(19,"label",10),l(20,"Fecha"),r(),i(21,"input",14),P("ngModelChange",function(a){return S(t.form().purchase_date,a)||(t.form().purchase_date=a),a}),r()(),i(22,"div",9)(23,"label",10),l(24,"Estado"),r(),i(25,"select",15),P("ngModelChange",function(a){return S(t.form().status,a)||(t.form().status=a),a}),i(26,"option",16),l(27,"Recibido (Aumenta Stock)"),r(),i(28,"option",17),l(29,"Ordenado (Pendiente)"),r()()()(),i(30,"div",18),l(31,"Productos"),r(),i(32,"div",19),x(33,de,18,10,"div",20,k),i(35,"button",21),p("click",function(){return t.addItem()}),_(36,"i",22),l(37," Agregar Producto "),r()(),i(38,"div",23)(39,"div",24),l(40),r(),i(41,"div",25)(42,"a",26),l(43,"Cancelar"),r(),i(44,"button",27),M(45,me,1,0,"span",28),l(46," Guardar Compra "),r()()()()()()),e&2&&(s(7),w(t.error()?7:-1),s(6),y("ngModel",t.form().supplier_id),s(3),v(t.suppliers()),s(5),y("ngModel",t.form().purchase_date),s(4),y("ngModel",t.form().status),s(8),v(t.items()),s(7),E("Total: $",t.total()),s(4),c("disabled",t.saving()),s(),w(t.saving()?45:-1))},dependencies:[W,$,ee,H,Q,X,B,J,K,j,G,Z,Y,z,U,R],encapsulation:2})};export{te as AdminPurchaseFormPage};
