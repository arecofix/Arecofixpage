import{a as I}from"./chunk-4TKL6PHB.js";import{D as f,T as w,X as g,p,v as h}from"./chunk-D4Q5CFD4.js";import{a as d,b as u}from"./chunk-VOSPIT4N.js";var E=class c{constructor(r){this.authService=r;this.supabase=this.authService.getSupabaseClient()}supabase;getOrders(){return p(this.supabase.from("orders").select("*").order("created_at",{ascending:!1})).pipe(h(({data:r,error:e})=>{if(e)throw e;return r||[]}),f(r=>{throw console.error("Error fetching orders:",r),r}))}getOrderById(r){return p(Promise.all([this.supabase.from("orders").select("*").eq("id",r).single(),this.supabase.from("order_items").select("*").eq("order_id",r)])).pipe(h(([e,t])=>{if(e.error)throw e.error;if(t.error)throw t.error;return u(d({},e.data),{items:t.data||[]})}),f(e=>{throw console.error("Error fetching order:",e),e}))}async createOrder(r,e){try{let t=crypto.randomUUID(),s=`ORD-${Date.now()}`,a={id:t,customer_name:r.customer_name,customer_email:r.customer_email,customer_phone:r.customer_phone,customer_address:r.customer_address,status:r.status,subtotal:r.subtotal,tax:r.tax,discount:r.discount,total_amount:r.total,notes:r.notes,order_number:s},{error:i}=await this.supabase.from("orders").insert(a);if(i)throw i;let m=e.map(l=>u(d({},l),{order_id:t})),{error:n}=await this.supabase.from("order_items").insert(m);if(n)throw n;return{data:u(d({},a),{created_at:new Date().toISOString()}),error:null}}catch(t){return console.error("Error creating order:",t),{data:null,error:t}}}async updateOrderStatus(r,e){let{error:t}=await this.supabase.from("orders").update({status:e,updated_at:new Date().toISOString()}).eq("id",r);return{error:t}}async deleteOrder(r){let{error:e}=await this.supabase.from("orders").delete().eq("id",r);return{error:e}}async updateOrder(r,e,t){try{let s={customer_name:e.customer_name,customer_email:e.customer_email,customer_phone:e.customer_phone,customer_address:e.customer_address,status:e.status,subtotal:e.subtotal,tax:e.tax,discount:e.discount,total_amount:e.total,notes:e.notes,updated_at:new Date().toISOString()},{data:a,error:i}=await this.supabase.from("orders").update(s).eq("id",r).select().maybeSingle();if(i)throw i;if(!a)throw new Error("Order not found or permission denied");let{data:m,error:n}=await this.supabase.from("order_items").select("id").eq("order_id",r);if(n)throw n;let b=m.map(o=>o.id),l=t.filter(o=>o.id).map(o=>o.id),_=b.filter(o=>!l.includes(o));if(_.length>0){let{error:o}=await this.supabase.from("order_items").delete().in("id",_);if(o)throw o}let y=t.map(o=>u(d({},o),{order_id:r})),{error:O}=await this.supabase.from("order_items").upsert(y);if(O)throw O;return{data:a,error:null}}catch(s){return console.error("Error updating order:",s),{data:null,error:s}}}static \u0275fac=function(e){return new(e||c)(g(I))};static \u0275prov=w({token:c,factory:c.\u0275fac,providedIn:"root"})};export{E as a};
