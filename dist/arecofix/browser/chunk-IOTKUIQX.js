import{k as Y,l as Z}from"./chunk-ECZXGVFH.js";import{a as ee}from"./chunk-MQUL3GSM.js";import{b as W,d as O,e as L,f as B,g as j,h as G,i as U,m as z,n as H,o as J,p as K,q as Q,t as X}from"./chunk-63CMMPDH.js";import"./chunk-P2JKZEUE.js";import"./chunk-XIH5YEDL.js";import"./chunk-M7RWEG4P.js";import{n as $,o as R}from"./chunk-YNFFGNY6.js";import"./chunk-Q44XB7TV.js";import{$ as x,$b as w,Ab as i,Bb as r,Cb as h,Gb as q,Kb as g,Mb as _,Ua as d,Vb as l,W as v,Wb as F,Xb as E,Yb as D,Zb as C,_b as M,aa as S,gb as k,ma as c,tb as b,ub as f,uc as V,vb as N,xb as y,yb as P,zb as p}from"./chunk-DX2LKEMG.js";import{a as I,b as T}from"./chunk-C6Q5SG76.js";var ie=(o,n)=>n.id;function ne(o,n){if(o&1&&(i(0,"div",6),h(1,"i",29),i(2,"span"),l(3),r()()),o&2){let e=_();d(3),F(e.error())}}function re(o,n){if(o&1&&(i(0,"option",13),l(1),r()),o&2){let e=n.$implicit;p("value",e.id),d(),F(e.name)}}function ae(o,n){o&1&&(i(0,"label",31),l(1,"Producto"),r())}function oe(o,n){if(o&1&&(i(0,"option",13),l(1),r()),o&2){let e=n.$implicit;p("value",e.id),d(),D("",e.name," (Stock: ",e.stock,")")}}function se(o,n){o&1&&(i(0,"label",31),l(1,"Cantidad"),r())}function de(o,n){o&1&&(i(0,"label",31),l(1,"Costo Unit."),r())}function le(o,n){if(o&1){let e=q();i(0,"div",20)(1,"div",30),b(2,ae,2,0,"label",31),i(3,"select",32),g("ngModelChange",function(s){let a=x(e).$index,m=_();return S(m.updateItem(a,"product_id",s))}),i(4,"option",33),l(5,"Seleccionar Producto"),r(),y(6,oe,2,3,"option",13,ie),r()(),i(8,"div",34),b(9,se,2,0,"label",31),i(10,"input",35),g("ngModelChange",function(s){let a=x(e).$index,m=_();return S(m.updateItem(a,"quantity",s))}),r()(),i(11,"div",36),b(12,de,2,0,"label",31),i(13,"input",37),g("ngModelChange",function(s){let a=x(e).$index,m=_();return S(m.updateItem(a,"unit_cost",s))}),r()(),i(14,"div",38),l(15),r(),i(16,"button",39),g("click",function(){let s=x(e).$index,a=_();return S(a.removeItem(s))}),h(17,"i",40),r()()}if(o&2){let e=n.$implicit,t=n.$index,s=_();d(2),f(t===0?2:-1),d(),p("ngModel",e.product_id)("name","product_"+t),d(3),P(s.products()),d(3),f(t===0?9:-1),d(),p("ngModel",e.quantity)("name","qty_"+t),d(2),f(t===0?12:-1),d(),p("ngModel",e.unit_cost)("name","cost_"+t),d(2),E(" $",e.quantity*e.unit_cost," ")}}function me(o,n){o&1&&h(0,"span",28)}var te=class o{auth=v(Z);router=v($);tenantService=v(Y);productRepository=v(ee);suppliers=c([]);products=c([]);form=c({supplier_id:"",purchase_date:new Date().toISOString().split("T")[0],status:"received"});items=c([]);loading=c(!0);saving=c(!1);error=c(null);total=V(()=>this.items().reduce((n,e)=>n+e.quantity*e.unit_cost,0));async ngOnInit(){let n=this.auth.getSupabaseClient(),e=this.tenantService.getTenantId();this.productRepository.findAvailable().subscribe(s=>{this.products.set(s)});let{data:t}=await n.from("suppliers").select("*").eq("is_active",!0).eq("tenant_id",e);t&&this.suppliers.set(t),this.loading.set(!1)}addItem(){this.items.update(n=>[...n,{product_id:"",quantity:1,unit_cost:0}])}removeItem(n){this.items.update(e=>e.filter((t,s)=>s!==n))}updateItem(n,e,t){this.items.update(s=>{let a=[...s];return a[n]=T(I({},a[n]),{[e]:t}),a})}async save(){if(this.items().length===0){this.error.set("Debe agregar al menos un producto");return}if(!this.form().supplier_id){this.error.set("Debe seleccionar un proveedor");return}this.saving.set(!0),this.error.set(null);let n=this.auth.getSupabaseClient();try{let e=this.tenantService.getTenantId(),{data:t,error:s}=await n.from("purchases").insert({supplier_id:this.form().supplier_id,date:this.form().purchase_date,status:this.form().status,total_amount:this.total(),tenant_id:e}).select().single();if(s)throw s;let a=this.items().map(u=>({purchase_id:t.id,product_id:u.product_id,quantity:u.quantity,unit_cost:u.unit_cost,tenant_id:e})),{error:m}=await n.from("purchase_items").insert(a);if(m)throw m;if(this.form().status==="received")for(let u of this.items()){let{data:A}=await n.from("products").select("stock").eq("id",u.product_id).eq("tenant_id",e).single();A&&await n.from("products").update({stock:A.stock+u.quantity}).eq("id",u.product_id).eq("tenant_id",e)}this.router.navigate(["/admin/purchases"])}catch(e){this.error.set(e.message)}finally{this.saving.set(!1)}}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=k({type:o,selectors:[["app-admin-purchase-form-page"]],decls:47,vars:7,consts:[[1,"max-w-4xl","mx-auto","text-base-content"],[1,"flex","items-center","gap-4","mb-6"],["routerLink","/admin/purchases",1,"btn","btn-circle","btn-ghost","text-base-content"],[1,"fas","fa-arrow-left"],[1,"text-2xl","font-bold","text-green-600"],[1,"bg-base-100","rounded-lg","shadow","p-6","text-base-content"],[1,"alert","alert-error","mb-4"],[1,"space-y-6",3,"ngSubmit"],[1,"grid","grid-cols-1","md:grid-cols-3","gap-6"],[1,"form-control"],[1,"label","text-base-content"],["name","supplier_id","required","",1,"select","select-bordered","bg-base-100","text-base-content","border-base-300",3,"ngModelChange","ngModel"],["value","","disabled","","selected",""],[1,"text-gray-900","bg-white","dark:text-white","dark:bg-gray-800",3,"value"],["type","date","name","purchase_date","required","",1,"input","input-bordered","bg-base-100","text-base-content","border-base-300",3,"ngModelChange","ngModel"],["name","status",1,"select","select-bordered","bg-base-100","text-base-content","border-base-300",3,"ngModelChange","ngModel"],["value","received"],["value","ordered"],[1,"divider"],[1,"space-y-4"],[1,"flex","gap-4","items-end","bg-base-200","p-4","rounded","text-base-content"],["type","button",1,"btn","btn-outline","btn-sm","w-full","border-dashed",3,"click"],[1,"fas","fa-plus","mr-2"],[1,"flex","justify-between","items-center","mt-8","pt-4","border-t"],[1,"text-2xl","font-bold"],[1,"flex","gap-4"],["routerLink","/admin/purchases",1,"btn","btn-error","text-white"],["type","submit",1,"btn","btn-primary",3,"disabled"],[1,"loading","loading-spinner"],[1,"fas","fa-exclamation-circle"],[1,"form-control","flex-1"],[1,"label","text-xs","text-base-content/70"],[1,"select","select-bordered","w-full","select-sm","bg-base-100","text-base-content","border-base-300",3,"ngModelChange","ngModel","name"],["value","","disabled","","selected","",1,"text-gray-400"],[1,"form-control","w-24"],["type","number","min","1",1,"input","input-bordered","input-sm","bg-base-100","text-base-content","border-base-300",3,"ngModelChange","ngModel","name"],[1,"form-control","w-32"],["type","number","min","0",1,"input","input-bordered","input-sm","bg-base-100","text-base-content","border-base-300",3,"ngModelChange","ngModel","name"],[1,"w-24","text-right","font-bold","text-sm","pb-2","text-base-content"],["type","button",1,"btn","btn-ghost","btn-sm","text-error","hover:bg-base-300",3,"click"],[1,"fas","fa-trash"]],template:function(e,t){e&1&&(i(0,"div",0)(1,"div",1)(2,"a",2),h(3,"i",3),r(),i(4,"h1",4),l(5,"Registrar Compra"),r()(),i(6,"div",5),b(7,ne,4,1,"div",6),i(8,"form",7),g("ngSubmit",function(){return t.save()}),i(9,"div",8)(10,"div",9)(11,"label",10),l(12,"Proveedor"),r(),i(13,"select",11),w("ngModelChange",function(a){return M(t.form().supplier_id,a)||(t.form().supplier_id=a),a}),i(14,"option",12),l(15,"Seleccionar Proveedor"),r(),y(16,re,2,2,"option",13,ie),r()(),i(18,"div",9)(19,"label",10),l(20,"Fecha"),r(),i(21,"input",14),w("ngModelChange",function(a){return M(t.form().purchase_date,a)||(t.form().purchase_date=a),a}),r()(),i(22,"div",9)(23,"label",10),l(24,"Estado"),r(),i(25,"select",15),w("ngModelChange",function(a){return M(t.form().status,a)||(t.form().status=a),a}),i(26,"option",16),l(27,"Recibido (Aumenta Stock)"),r(),i(28,"option",17),l(29,"Ordenado (Pendiente)"),r()()()(),i(30,"div",18),l(31,"Productos"),r(),i(32,"div",19),y(33,le,18,10,"div",20,N),i(35,"button",21),g("click",function(){return t.addItem()}),h(36,"i",22),l(37," Agregar Producto "),r()(),i(38,"div",23)(39,"div",24),l(40),r(),i(41,"div",25)(42,"a",26),l(43,"Cancelar"),r(),i(44,"button",27),b(45,me,1,0,"span",28),l(46," Guardar Compra "),r()()()()()()),e&2&&(d(7),f(t.error()?7:-1),d(6),C("ngModel",t.form().supplier_id),d(3),P(t.suppliers()),d(5),C("ngModel",t.form().purchase_date),d(4),C("ngModel",t.form().status),d(8),P(t.items()),d(7),E("Total: $",t.total()),d(4),p("disabled",t.saving()),d(),f(t.saving()?45:-1))},dependencies:[X,G,H,J,W,U,z,O,L,Q,K,j,B,R],encapsulation:2})};export{te as AdminPurchaseFormPage};
