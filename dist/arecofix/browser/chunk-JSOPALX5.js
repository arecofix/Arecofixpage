import{a as _}from"./chunk-AWQLWEOW.js";import{a as k}from"./chunk-6KLMDNRR.js";import{a as R}from"./chunk-EWVJVUFG.js";import{a as C}from"./chunk-MQUL3GSM.js";import{R as v,W as g,p as m}from"./chunk-NLTFPZ75.js";var S=class b{productRepo=g(C);brandRepo=g(k);categoryRepo=g(_);auth=g(R);supabase=this.auth.getSupabaseClient();async getProducts(){return m(this.productRepo.getAll())}async getProduct(t){return m(this.productRepo.getById(t))}async getBrands(){return m(this.brandRepo.getAll())}async getCategories(){return m(this.categoryRepo.getAll())}async createProduct(t){await m(this.productRepo.create(t))}async updateProduct(t,r){await m(this.productRepo.update(t,r))}async uploadImage(t){let r=`products/${Date.now()}-${t.name}`,{data:o,error:a}=await this.supabase.storage.from("public-assets").upload(r,t);if(a)throw a;let{data:e}=this.supabase.storage.from("public-assets").getPublicUrl(o.path);return e.publicUrl}slugify(t){return t.toString().toLowerCase().trim().replace(/\s+/g,"-").replace(/&/g,"-and-").replace(/[^a-z0-9-]/g,"").replace(/-+/g,"-")}async exportProductsToCSV(){let t=await this.getProducts();if(!t.length)return;let r=["id","name","slug","description","price","stock","category_id","brand_id","image_url","is_active","is_featured","sku","barcode"],o=[r.join(","),...t.map(i=>r.map(f=>{let n=i[f],u=n??"";return typeof u=="string"&&(u.includes(",")||u.includes('"')||u.includes(`
`))?`"${u.replace(/"/g,'""')}"`:u}).join(","))].join(`
`),a=new Blob([o],{type:"text/csv;charset=utf-8;"}),e=document.createElement("a"),d=URL.createObjectURL(a);e.setAttribute("href",d),e.setAttribute("download",`products_export_${new Date().toISOString().split("T")[0]}.csv`),e.style.visibility="hidden",document.body.appendChild(e),e.click(),document.body.removeChild(e)}async importProductsFromCSV(t){return new Promise((r,o)=>{let a=new FileReader;a.onload=async e=>{try{let d=e.target?.result;if(!d)throw new Error("Empty file");let i=d.split(/\r\n|\n/),f=i[0].split(",").map(l=>l.trim()),n=[],u=0;for(let l=1;l<i.length;l++){let w=i[l].trim();if(!w)continue;let h=[],y=!1,P="";for(let s of w)s==='"'?y=!y:s===","&&!y?(h.push(P),P=""):P+=s;if(h.push(P),h.length!==f.length){console.warn(`Skipping line ${l+1}: Column count mismatch`),u++;continue}let c={};f.forEach((s,A)=>{let p=h[A]?.trim();p?.startsWith('"')&&p?.endsWith('"')&&(p=p.substring(1,p.length-1).replace(/""/g,'"')),p===""?c[s]=null:s==="price"||s==="stock"||s==="min_stock_alert"?c[s]=Number(p):s==="is_active"||s==="is_featured"?c[s]=p.toLowerCase()==="true":c[s]=p}),(!c.id||c.id==="new")&&delete c.id,c.name&&(c.price===void 0||c.price>=0)?n.push(c):u++}if(n.length>0){let{error:l}=await this.supabase.from("products").upsert(n,{onConflict:"id"});if(l)throw l}r({success:n.length,errors:u})}catch(d){o(d)}},a.onerror=e=>o(e),a.readAsText(t)})}async bulkUpdate(t,r){let{error:o}=await this.supabase.from("products").update(r).in("id",t);if(o)throw o}async bulkIncreasePrice(t,r){let{data:o,error:a}=await this.supabase.from("products").select("id, price").in("id",t);if(a)throw a;if(!o||o.length===0)return;let e=o.map(i=>({id:i.id,price:Math.round(i.price*(1+r/100))})),d=5;for(let i=0;i<e.length;i+=d){let f=e.slice(i,i+d);await Promise.all(f.map(n=>this.supabase.from("products").update({price:n.price}).eq("id",n.id)))}}static \u0275fac=function(r){return new(r||b)};static \u0275prov=v({token:b,factory:b.\u0275fac,providedIn:"root"})};export{S as a};
