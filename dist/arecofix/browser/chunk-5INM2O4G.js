import{a as O}from"./chunk-ZT4MGTUK.js";import{B as f,Q as b,U as _,o as p,t as l}from"./chunk-VQO264VU.js";import{a,b as i}from"./chunk-VOSPIT4N.js";var w=class c{constructor(r){this.authService=r;this.supabase=this.authService.getSupabaseClient()}supabase;getOrders(){return p(this.supabase.from("orders").select("*").order("created_at",{ascending:!1})).pipe(l(({data:r,error:e})=>{if(e)throw e;return r||[]}),f(r=>{throw console.error("Error fetching orders:",r),r}))}getOrderById(r){return p(Promise.all([this.supabase.from("orders").select("*").eq("id",r).single(),this.supabase.from("order_items").select("*").eq("order_id",r)])).pipe(l(([e,t])=>{if(e.error)throw e.error;if(t.error)throw t.error;return i(a({},e.data),{items:t.data||[]})}),f(e=>{throw console.error("Error fetching order:",e),e}))}async createOrder(r,e){try{let t=`ORD-${Date.now()}`,{data:s,error:n}=await this.supabase.from("orders").insert(i(a({},r),{order_number:t,total_amount:r.total,customer_address:r.customer_address})).select().single();if(n)throw n;let u=e.map(m=>i(a({},m),{order_id:s.id})),{error:d}=await this.supabase.from("order_items").insert(u);if(d)throw d;return{data:s,error:null}}catch(t){return console.error("Error creating order:",t),{data:null,error:t}}}async updateOrderStatus(r,e){let{error:t}=await this.supabase.from("orders").update({status:e,updated_at:new Date().toISOString()}).eq("id",r);return{error:t}}async deleteOrder(r){let{error:e}=await this.supabase.from("orders").delete().eq("id",r);return{error:e}}async updateOrder(r,e,t){try{let{data:s,error:n}=await this.supabase.from("orders").update(i(a({},e),{total_amount:e.total,customer_address:e.customer_address,updated_at:new Date().toISOString()})).eq("id",r).select().maybeSingle();if(n)throw n;if(!s)throw new Error("Order not found or permission denied");let{data:u,error:d}=await this.supabase.from("order_items").select("id").eq("order_id",r);if(d)throw d;let m=u.map(o=>o.id),I=t.filter(o=>o.id).map(o=>o.id),h=m.filter(o=>!I.includes(o));if(h.length>0){let{error:o}=await this.supabase.from("order_items").delete().in("id",h);if(o)throw o}let y=t.map(o=>i(a({},o),{order_id:r})),{error:g}=await this.supabase.from("order_items").upsert(y);if(g)throw g;return{data:s,error:null}}catch(s){return console.error("Error updating order:",s),{data:null,error:s}}}static \u0275fac=function(e){return new(e||c)(_(O))};static \u0275prov=b({token:c,factory:c.\u0275fac,providedIn:"root"})};export{w as a};
