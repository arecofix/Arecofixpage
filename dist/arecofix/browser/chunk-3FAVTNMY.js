import{a as te}from"./chunk-MPI6IZTS.js";import{b as j,d as G,e as Q,f as $,g as U,h as z,i as H,l as J,m as K,n as X,o as Y,p as Z,r as ee}from"./chunk-67JN6MIM.js";import{a as R}from"./chunk-ETUYVYEI.js";import"./chunk-23BTM2IY.js";import{a as q,c as B,d as L}from"./chunk-ZWPO54DG.js";import"./chunk-SH266SLM.js";import"./chunk-Z5OW2DIK.js";import{p as D}from"./chunk-DTICAINP.js";import{$ as u,Bb as T,Fa as m,Fb as r,Gb as I,Hb as g,Ib as W,Jb as _,Kb as f,Lb as h,Ta as k,W as v,aa as c,eb as S,fb as C,gb as A,ib as P,ic as N,jb as O,kb as y,lb as t,ma as F,mb as i,nb as p,rb as V,vb as b,xb as x}from"./chunk-RGAVNK56.js";import{a as M,b as E}from"./chunk-VOSPIT4N.js";var re=(s,n)=>n.id;function oe(s,n){s&1&&(t(0,"div",24),p(1,"i",41),t(2,"p"),r(3,"No hay productos agregados"),i()())}function ae(s,n){if(s&1&&(t(0,"option",45),r(1),i()),s&2){let o=n.$implicit;y("value",o.id),m(),W(" ",o.name," (",o.sku,") ")}}function de(s,n){if(s&1){let o=V();t(0,"tr")(1,"td")(2,"select",43),b("change",function(a){let l=u(o).$index,d=x(2);return c(d.onProductSelect(l,a.target.value))}),t(3,"option",44),r(4,"Seleccionar producto..."),i(),P(5,ae,2,3,"option",45,re),i()(),t(7,"td")(8,"input",46),h("ngModelChange",function(a){let l=u(o).$implicit;return f(l.quantity,a)||(l.quantity=a),c(a)}),b("ngModelChange",function(){let a=u(o).$index,l=x(2);return c(l.onQuantityChange(a))}),i()(),t(9,"td",31),r(10),i(),t(11,"td",47),r(12),i(),t(13,"td")(14,"button",48),b("click",function(){let a=u(o).$index,l=x(2);return c(l.removeItem(a))}),p(15,"i",49),i()()()}if(s&2){let o=n.$implicit,e=n.$index,a=x(2);m(2),y("value",o.product_id),m(3),O(a.products),m(3),_("ngModel",o.quantity),y("name","quantity_"+e),m(2),g("$",o.unit_price.toFixed(2)),m(2),g("$",o.subtotal.toFixed(2))}}function le(s,n){if(s&1&&(t(0,"div",25)(1,"table",42)(2,"thead")(3,"tr")(4,"th"),r(5,"Producto"),i(),t(6,"th"),r(7,"Cantidad"),i(),t(8,"th"),r(9,"Precio Unit."),i(),t(10,"th"),r(11,"Subtotal"),i(),p(12,"th"),i()(),t(13,"tbody"),P(14,de,16,5,"tr",null,A),i()()()),s&2){let o=x();m(14),O(o.items())}}function me(s,n){if(s&1&&(t(0,"div",36),p(1,"i",50),t(2,"span"),r(3),i()()),s&2){let o=x();m(3),I(o.error)}}function se(s,n){s&1&&p(0,"span",40)}var ie=class s{route=v(q);router=v(B);orderService=v(te);authService=v(R);cdr=v(N);id=null;loading=!0;saving=!1;error=null;products=[];form=F({customer_name:"",customer_email:"",customer_phone:"",customer_address:"",status:"pending",subtotal:0,tax:0,discount:0,total:0,notes:""});items=F([]);async ngOnInit(){this.id=this.route.snapshot.paramMap.get("id"),await this.loadProducts(),this.id&&await this.loadOrder(),this.loading=!1,this.cdr.markForCheck()}async loadProducts(){let n=this.authService.getSupabaseClient(),{data:o,error:e}=await n.from("products").select("id, name, sku, price, stock").eq("is_active",!0).order("name");!e&&o&&(this.products=o)}async loadOrder(){this.id&&this.orderService.getOrderById(this.id).subscribe({next:n=>{this.form.set({customer_name:n.customer_name,customer_email:n.customer_email,customer_phone:n.customer_phone,customer_address:n.customer_address,status:n.status,subtotal:n.subtotal,tax:n.tax,discount:n.discount,total:n.total,notes:n.notes}),this.items.set(n.items),this.cdr.markForCheck()},error:n=>{this.error=n.message,this.cdr.markForCheck()}})}addItem(){this.items.update(n=>[...n,{product_name:"",quantity:1,unit_price:0,subtotal:0}]),this.cdr.markForCheck()}removeItem(n){this.items.update(o=>o.filter((e,a)=>a!==n)),this.calculateTotals()}onProductSelect(n,o){let e=this.products.find(a=>a.id===o);e&&(this.items.update(a=>{let l=[...a];return l[n]=E(M({},l[n]),{product_id:e.id,product_name:e.name,product_sku:e.sku,unit_price:e.price,subtotal:e.price*l[n].quantity}),l}),this.calculateTotals())}onQuantityChange(n){this.items.update(o=>{let e=[...o];return e[n].subtotal=e[n].unit_price*e[n].quantity,e}),this.calculateTotals()}calculateTotals(){let n=this.items().reduce((w,ne)=>w+ne.subtotal,0),o=this.form().discount||0,e=.21,a=n-o,l=a*e,d=a+l;this.form.update(w=>E(M({},w),{subtotal:n,tax:l,total:d})),this.cdr.markForCheck()}async save(){if(this.items().length===0){this.error="Debes agregar al menos un producto",this.cdr.markForCheck();return}this.saving=!0,this.error=null;try{let{data:n,error:o}=await this.orderService.createOrder(this.form(),this.items());if(o)throw o;this.router.navigate(["/admin/orders"])}catch(n){this.error=n.message||"Error al guardar pedido",this.saving=!1,this.cdr.markForCheck()}}static \u0275fac=function(o){return new(o||s)};static \u0275cmp=k({type:s,selectors:[["app-admin-order-form-page"]],decls:98,vars:17,consts:[["f","ngForm"],[1,"max-w-4xl","mx-auto"],[1,"text-2xl","font-bold","mb-6"],[1,"space-y-6",3,"ngSubmit"],[1,"card","bg-white","shadow"],[1,"card-body"],[1,"card-title","text-lg","mb-4"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4"],[1,"form-control"],[1,"label"],[1,"label-text"],["type","text","name","customer_name","required","",1,"input","input-bordered",3,"ngModelChange","ngModel"],["type","email","name","customer_email","required","",1,"input","input-bordered",3,"ngModelChange","ngModel"],["type","tel","name","customer_phone",1,"input","input-bordered",3,"ngModelChange","ngModel"],["type","text","name","customer_address",1,"input","input-bordered",3,"ngModelChange","ngModel"],["name","status",1,"select","select-bordered",3,"ngModelChange","ngModel"],["value","pending"],["value","processing"],["value","completed"],["value","cancelled"],[1,"flex","justify-between","items-center","mb-4"],[1,"card-title","text-lg"],["type","button",1,"btn","btn-sm","btn-primary",3,"click"],[1,"fas","fa-plus","mr-2"],[1,"text-center","py-8","text-gray-500"],[1,"overflow-x-auto"],["type","number","name","discount","min","0","step","0.01",1,"input","input-bordered",3,"ngModelChange","ngModel"],["name","notes","rows","2",1,"textarea","textarea-bordered",3,"ngModelChange","ngModel"],[1,"divider"],[1,"space-y-2"],[1,"flex","justify-between","text-lg"],[1,"font-mono"],[1,"font-mono","text-error"],[1,"divider","my-2"],[1,"flex","justify-between","text-2xl","font-bold"],[1,"font-mono","text-primary"],[1,"alert","alert-error"],[1,"flex","gap-2","justify-end"],["routerLink","/admin/orders",1,"btn","btn-ghost"],["type","submit",1,"btn","btn-primary",3,"disabled"],[1,"loading","loading-spinner"],[1,"fas","fa-box-open","text-4xl","mb-2"],[1,"table","w-full"],["required","",1,"select","select-bordered","select-sm","w-full",3,"change","value"],["value",""],[3,"value"],["type","number","min","1",1,"input","input-bordered","input-sm","w-20",3,"ngModelChange","ngModel","name"],[1,"font-mono","font-semibold"],["type","button",1,"btn","btn-ghost","btn-sm","btn-circle",3,"click"],[1,"fas","fa-trash","text-error"],[1,"fas","fa-exclamation-circle"]],template:function(o,e){if(o&1){let a=V();t(0,"div",1)(1,"h2",2),r(2),i(),t(3,"form",3,0),b("ngSubmit",function(){return u(a),c(e.save())}),t(5,"div",4)(6,"div",5)(7,"h3",6),r(8,"Informaci\xF3n del Cliente"),i(),t(9,"div",7)(10,"div",8)(11,"label",9)(12,"span",10),r(13,"Nombre *"),i()(),t(14,"input",11),h("ngModelChange",function(d){return u(a),f(e.form().customer_name,d)||(e.form().customer_name=d),c(d)}),i()(),t(15,"div",8)(16,"label",9)(17,"span",10),r(18,"Email *"),i()(),t(19,"input",12),h("ngModelChange",function(d){return u(a),f(e.form().customer_email,d)||(e.form().customer_email=d),c(d)}),i()(),t(20,"div",8)(21,"label",9)(22,"span",10),r(23,"Tel\xE9fono"),i()(),t(24,"input",13),h("ngModelChange",function(d){return u(a),f(e.form().customer_phone,d)||(e.form().customer_phone=d),c(d)}),i()(),t(25,"div",8)(26,"label",9)(27,"span",10),r(28,"Direcci\xF3n"),i()(),t(29,"input",14),h("ngModelChange",function(d){return u(a),f(e.form().customer_address,d)||(e.form().customer_address=d),c(d)}),i()(),t(30,"div",8)(31,"label",9)(32,"span",10),r(33,"Estado"),i()(),t(34,"select",15),h("ngModelChange",function(d){return u(a),f(e.form().status,d)||(e.form().status=d),c(d)}),t(35,"option",16),r(36,"Pendiente"),i(),t(37,"option",17),r(38,"Procesando"),i(),t(39,"option",18),r(40,"Completado"),i(),t(41,"option",19),r(42,"Cancelado"),i()()()()()(),t(43,"div",4)(44,"div",5)(45,"div",20)(46,"h3",21),r(47,"Productos"),i(),t(48,"button",22),b("click",function(){return u(a),c(e.addItem())}),p(49,"i",23),r(50," Agregar Producto "),i()(),S(51,oe,4,0,"div",24)(52,le,16,0,"div",25),i()(),t(53,"div",4)(54,"div",5)(55,"h3",6),r(56,"Totales"),i(),t(57,"div",7)(58,"div",8)(59,"label",9)(60,"span",10),r(61,"Descuento"),i()(),t(62,"input",26),h("ngModelChange",function(d){return u(a),f(e.form().discount,d)||(e.form().discount=d),c(d)}),b("ngModelChange",function(){return u(a),c(e.calculateTotals())}),i()(),t(63,"div",8)(64,"label",9)(65,"span",10),r(66,"Notas"),i()(),t(67,"textarea",27),h("ngModelChange",function(d){return u(a),f(e.form().notes,d)||(e.form().notes=d),c(d)}),i()()(),p(68,"div",28),t(69,"div",29)(70,"div",30)(71,"span"),r(72,"Subtotal:"),i(),t(73,"span",31),r(74),i()(),t(75,"div",30)(76,"span"),r(77,"Descuento:"),i(),t(78,"span",32),r(79),i()(),t(80,"div",30)(81,"span"),r(82,"IVA (21%):"),i(),t(83,"span",31),r(84),i()(),p(85,"div",33),t(86,"div",34)(87,"span"),r(88,"Total:"),i(),t(89,"span",35),r(90),i()()()()(),S(91,me,4,1,"div",36),t(92,"div",37)(93,"a",38),r(94,"Cancelar"),i(),t(95,"button",39),S(96,se,1,0,"span",40),r(97),i()()()()}if(o&2){let a=T(4);m(2),g("",e.id?"Editar":"Nuevo"," Pedido"),m(12),_("ngModel",e.form().customer_name),m(5),_("ngModel",e.form().customer_email),m(5),_("ngModel",e.form().customer_phone),m(5),_("ngModel",e.form().customer_address),m(5),_("ngModel",e.form().status),m(17),C(e.items().length===0?51:52),m(11),_("ngModel",e.form().discount),m(5),_("ngModel",e.form().notes),m(7),g("$",e.form().subtotal.toFixed(2)),m(5),g("-$",e.form().discount.toFixed(2)),m(5),g("$",e.form().tax.toFixed(2)),m(6),g("$",e.form().total.toFixed(2)),m(),C(e.error?91:-1),m(4),y("disabled",e.saving||a.invalid),m(),C(e.saving?96:-1),m(),g(" ",e.saving?"Guardando...":"Guardar Pedido"," ")}},dependencies:[ee,z,K,X,j,H,J,G,Q,Z,Y,U,$,L,D],encapsulation:2,changeDetection:0})};export{ie as AdminOrderFormPage};
