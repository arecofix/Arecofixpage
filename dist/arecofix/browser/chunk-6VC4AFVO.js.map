{
  "version": 3,
  "sources": ["src/app/core/services/order.service.ts"],
  "sourcesContent": ["import { Injectable, inject } from '@angular/core';\r\nimport { AuthService } from './auth.service';\r\nimport { SupabaseClient, PostgrestError } from '@supabase/supabase-js';\r\nimport { LoggerService } from './logger.service';\r\nimport { Observable, from } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\nimport { Order, OrderItem, OrderWithItems } from '@app/shared/interfaces/order.interface';\r\nimport { DbOrder, DbOrderItem } from '@app/shared/interfaces/db-models';\r\n\r\n@Injectable({\r\n    providedIn: 'root'\r\n})\r\nexport class OrderService {\r\n    private authService = inject(AuthService);\r\n    private logger = inject(LoggerService);\r\n    private supabase: SupabaseClient;\r\n\r\n    constructor() {\r\n        this.supabase = this.authService.getSupabaseClient();\r\n    }\r\n\r\n    getOrders(): Observable<OrderWithItems[]> {\r\n        return from(\r\n            this.supabase\r\n                .from('orders')\r\n                .select('*, order_items(*)')\r\n                .order('created_at', { ascending: false })\r\n                .returns<DbOrder[]>()\r\n        ).pipe(\r\n            map(({ data, error }) => {\r\n                if (error) throw error;\r\n                return (data || []).map(this.mapDbOrderToDomain);\r\n            }),\r\n            catchError((err: unknown) => {\r\n                this.handleError('Error fetching orders', err);\r\n                throw err;\r\n            })\r\n        );\r\n    }\r\n\r\n    getOrderById(id: string): Observable<OrderWithItems> {\r\n        return from(\r\n            Promise.all([\r\n                this.supabase.from('orders').select('*').eq('id', id).single(),\r\n                this.supabase.from('order_items').select('*').eq('order_id', id)\r\n            ])\r\n        ).pipe(\r\n            map(([orderResult, itemsResult]) => {\r\n                if (orderResult.error) throw orderResult.error;\r\n                if (itemsResult.error) throw itemsResult.error;\r\n\r\n                const dbOrder = orderResult.data as DbOrder;\r\n                dbOrder.order_items = itemsResult.data as DbOrderItem[];\r\n\r\n                return this.mapDbOrderToDomain(dbOrder);\r\n            }),\r\n            catchError((err: unknown) => {\r\n                this.handleError('Error fetching order', err);\r\n                throw err;\r\n            })\r\n        );\r\n    }\r\n\r\n    async createOrder(order: Order, items: OrderItem[]): Promise<{ data: Order | null; error: PostgrestError | null }> {\r\n        try {\r\n            const orderId = crypto.randomUUID();\r\n            const orderNumber = `ORD-${Date.now()}`;\r\n\r\n            const insertPayload: Partial<DbOrder> = {\r\n                id: orderId,\r\n                customer_name: order.customer_name,\r\n                customer_email: order.customer_email,\r\n                customer_phone: order.customer_phone || null,\r\n                customer_address: order.customer_address || null,\r\n                status: order.status || 'pending',\r\n                subtotal: order.subtotal,\r\n                tax: order.tax,\r\n                discount: order.discount,\r\n                total_amount: order.total,\r\n                notes: order.notes || null,\r\n                order_number: orderNumber,\r\n                customer_id: order.customer_id || null\r\n            };\r\n\r\n            const { error: orderError } = await this.supabase\r\n                .from('orders')\r\n                .insert(insertPayload);\r\n\r\n            if (orderError) throw orderError;\r\n\r\n            const itemsWithOrderId = items.map(item => ({\r\n                order_id: orderId,\r\n                product_id: item.product_id || null,\r\n                product_name: item.product_name,\r\n                quantity: item.quantity,\r\n                unit_price: item.unit_price,\r\n                subtotal: item.subtotal\r\n            }));\r\n\r\n            const { error: itemsError } = await this.supabase\r\n                .from('order_items')\r\n                .insert(itemsWithOrderId);\r\n\r\n            if (itemsError) throw itemsError;\r\n\r\n            const orderData: Order = { \r\n                ...order, \r\n                id: orderId, \r\n                order_number: orderNumber,\r\n                created_at: new Date().toISOString() \r\n            };\r\n            return { data: orderData, error: null };\r\n        } catch (error: unknown) {\r\n            this.handleError('Error creating order', error);\r\n            return { data: null, error: error as PostgrestError };\r\n        }\r\n    }\r\n\r\n    async updateOrderStatus(id: string, status: Order['status']): Promise<{ error: PostgrestError | Error | null }> {\r\n        const { error, data } = await this.supabase\r\n            .from('orders')\r\n            .update({ status, updated_at: new Date().toISOString() })\r\n            .eq('id', id)\r\n            .select();\r\n\r\n        if (error) this.handleError('Error updating order status', error);\r\n        \r\n        if (!error && (!data || data.length === 0)) {\r\n            return { error: new Error(\"Supabase RLS Error: No tienes permisos en la Base de Datos para cambiar el Estado de esta Orden. Ejecuta el SQL de ADMIN en Supabase.\") };\r\n        }\r\n        \r\n        return { error };\r\n    }\r\n\r\n    async deleteOrder(id: string): Promise<{ error: PostgrestError | null }> {\r\n        const { error } = await this.supabase\r\n            .from('orders')\r\n            .delete()\r\n            .eq('id', id);\r\n\r\n        if (error) this.handleError('Error deleting order', error);\r\n        return { error };\r\n    }\r\n    \r\n    async updateOrder(id: string, order: Order, items: OrderItem[]): Promise<{ data: Order | null; error: PostgrestError | Error | null }> {\r\n        try {\r\n            const updatePayload: Partial<DbOrder> = {\r\n                customer_name: order.customer_name,\r\n                customer_email: order.customer_email,\r\n                customer_phone: order.customer_phone || null,\r\n                customer_address: order.customer_address || null,\r\n                status: order.status,\r\n                subtotal: order.subtotal,\r\n                tax: order.tax,\r\n                discount: order.discount,\r\n                total_amount: order.total,\r\n                notes: order.notes || null,\r\n                updated_at: new Date().toISOString()\r\n            };\r\n\r\n            const { error: orderError, data: updatedOrdersData } = await this.supabase\r\n                .from('orders')\r\n                .update(updatePayload)\r\n                .eq('id', id)\r\n                .select();\r\n\r\n            if (orderError) throw orderError;\r\n            \r\n            if (!updatedOrdersData || updatedOrdersData.length === 0) {\r\n                throw new Error(\"Supabase RLS Error: El servidor bloqueó la actualización de la Orden. Activa los permisos de edición para 'orders' en Supabase.\");\r\n            }\r\n\r\n            // Handle items update (delete missing, upsert current)\r\n            await this.handleItemsUpdate(id, items);\r\n\r\n            // Refetch the updated order to properly construct the updatedDbOrder\r\n            const { data: fetchUpdatedData, error: fetchUpdatedError } = await this.supabase\r\n                .from('orders')\r\n                .select('*')\r\n                .eq('id', id)\r\n                .single();\r\n            \r\n            if (fetchUpdatedError) throw fetchUpdatedError;\r\n\r\n            const updatedDbOrder = fetchUpdatedData as DbOrder;\r\n            // Fetch fresh items to return complete object\r\n            const { data: freshItems } = await this.supabase.from('order_items').select('*').eq('order_id', id);\r\n            \r\n            updatedDbOrder.order_items = freshItems as DbOrderItem[];\r\n            \r\n            return { data: this.mapDbOrderToDomain(updatedDbOrder), error: null };\r\n        } catch (error: unknown) {\r\n            this.handleError('Error updating order', error);\r\n            return { data: null, error: error as PostgrestError };\r\n        }\r\n    }\r\n\r\n    // --- Private Helper Methods ---\r\n\r\n    private async handleItemsUpdate(orderId: string, items: OrderItem[]): Promise<void> {\r\n        const { data: existingItems, error: fetchError } = await this.supabase\r\n            .from('order_items')\r\n            .select('id')\r\n            .eq('order_id', orderId);\r\n\r\n        if (fetchError) throw fetchError;\r\n\r\n        const existingIds: string[] = (existingItems || []).map((i: { id: string }) => i.id);\r\n        const currentIds = items.filter(i => i.id).map(i => i.id);\r\n        const idsToDelete = existingIds.filter((eid: string) => !currentIds.includes(eid));\r\n\r\n        if (idsToDelete.length > 0) {\r\n            const { error: deleteError } = await this.supabase\r\n                .from('order_items')\r\n                .delete()\r\n                .in('id', idsToDelete);\r\n            if (deleteError) throw deleteError;\r\n        }\r\n\r\n        const itemsToUpsert = items.map(item => ({\r\n            ...(item.id ? { id: item.id } : {}),\r\n            order_id: orderId,\r\n            product_name: item.product_name,\r\n            quantity: item.quantity,\r\n            unit_price: item.unit_price,\r\n            subtotal: item.subtotal,\r\n            product_id: item.product_id || null\r\n        }));\r\n\r\n        const { error: upsertError } = await this.supabase\r\n            .from('order_items')\r\n            .upsert(itemsToUpsert);\r\n\r\n        if (upsertError) throw upsertError;\r\n    }\r\n\r\n    private mapDbOrderToDomain(o: DbOrder): OrderWithItems {\r\n        return {\r\n            id: o.id,\r\n            created_at: o.created_at,\r\n            updated_at: o.updated_at || undefined,\r\n            order_number: o.order_number,\r\n            customer_name: o.customer_name,\r\n            customer_email: o.customer_email,\r\n            customer_phone: o.customer_phone || undefined,\r\n            customer_address: o.customer_address || undefined,\r\n            customer_id: o.customer_id || undefined,\r\n            status: o.status,\r\n            subtotal: o.subtotal,\r\n            tax: o.tax,\r\n            discount: o.discount,\r\n            total: o.total_amount,\r\n            notes: o.notes || undefined,\r\n            items: (o.order_items || []).map((i) => ({\r\n                id: i.id,\r\n                order_id: i.order_id,\r\n                product_id: i.product_id || undefined,\r\n                product_name: i.product_name,\r\n                quantity: i.quantity,\r\n                unit_price: i.unit_price,\r\n                subtotal: i.subtotal,\r\n                created_at: i.created_at\r\n            }))\r\n        };\r\n    }\r\n\r\n    private handleError(msg: string, error: unknown) {\r\n        this.logger.error(`${msg}:`, error);\r\n    }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
