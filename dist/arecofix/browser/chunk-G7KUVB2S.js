import{a as D}from"./chunk-Y277GW3E.js";import{a as K}from"./chunk-6KLMDNRR.js";import{l as V}from"./chunk-ECZXGVFH.js";import{a as z}from"./chunk-MQUL3GSM.js";import{R as M,W as k,p as d}from"./chunk-DX2LKEMG.js";import{a as j}from"./chunk-C6Q5SG76.js";var T=class h{constructor(){}async parse(t,i){return new Promise((a,n)=>{let c=new FileReader;c.onload=o=>{try{let y=o.target?.result;if(!y){n(new Error("Empty file"));return}let _=y.split(/\r\n|\n/),v=_[0].split(",").map(m=>m.trim()),f=[],p=0;for(let m=1;m<_.length;m++){let w=_[m].trim();if(!w)continue;let P=this.parseLine(w);if(P.length!==v.length){console.warn(`Skipping line ${m+1}: Column count mismatch`),p++;continue}let R=i(P,v);R?f.push(R):p++}a({data:f,errors:p})}catch(y){n(y)}},c.onerror=o=>n(o),c.readAsText(t)})}exportToCsv(t,i,a){if(!t.length)return;let n=[a.join(","),...t.map(_=>a.map(v=>{let f=_[v],p=f??"";return typeof p=="string"&&(p.includes(",")||p.includes('"')||p.includes(`
`))?`"${p.replace(/"/g,'""')}"`:p}).join(","))].join(`
`),c=new Blob([n],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a"),y=URL.createObjectURL(c);o.setAttribute("href",y),o.setAttribute("download",`${i}_${new Date().toISOString().split("T")[0]}.csv`),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o)}parseLine(t){let i=[],a=!1,n="";for(let c of t)c==='"'?a=!a:c===","&&!a?(i.push(n),n=""):n+=c;return i.push(n),i}static \u0275fac=function(i){return new(i||h)};static \u0275prov=M({token:h,factory:h.\u0275fac,providedIn:"root"})};var C=class{static slugify(t){return t.toString().toLowerCase().trim().replace(/\s+/g,"-").replace(/&/g,"-and-").replace(/[^a-z0-9-]/g,"").replace(/-+/g,"-")}static capitalize(t){return t?t.charAt(0).toUpperCase()+t.slice(1):""}};var H=class h{productRepo=k(z);brandRepo=k(K);categoryRepo=k(D);csvService=k(T);auth=k(V);async getProducts(){let t=this.auth.getCurrentUser();if(t){let i=await this.auth.getUserProfile(t.id);return d(this.productRepo.getAll(i?.branch_id))}return d(this.productRepo.getAll())}async getProduct(t){return d(this.productRepo.getById(t))}async getBrands(){return d(this.brandRepo.getAll())}async getCategories(){return d(this.categoryRepo.getAll())}async createProduct(t){await d(this.productRepo.create(t))}async updateProduct(t,i){await d(this.productRepo.update(t,i))}async uploadImage(t){return this.productRepo.uploadImage(t)}slugify(t){return C.slugify(t)}async exportProductsToCSV(){let t=await this.getProducts();if(!t.length)return;let i=["id","name","slug","description","price","stock","category_id","brand_id","image_url","is_active","is_featured","sku","barcode"];this.csvService.exportToCsv(t,"products_export",i)}async importProductsFromCSV(t){let i=await this.csvService.parse(t,(e,s)=>{let r={};s.forEach((b,x)=>{let S=e[x]?.trim();S===""||S===void 0?r[b]=null:["price","stock","min_stock_alert"].includes(b)?r[b]=Number(S):["is_active","is_featured"].includes(b)?r[b]=S.toLowerCase()==="true":r[b]=S});let l=r.name?.trim(),u=r.price;return!l||u===null||u===void 0||isNaN(Number(u))?null:{id:r.id&&r.id!=="new"&&r.id!==""?r.id:void 0,name:l,price:Number(u),stock:r.stock!=null?Number(r.stock):void 0,sku:r.sku||void 0,barcode:r.barcode||void 0,description:r.description||void 0,category_id:r.category_id||void 0,brand_id:r.brand_id||void 0,image_url:r.image_url||void 0,slug:r.slug||void 0,is_active:r.is_active!=null?!!r.is_active:!0,is_featured:r.is_featured!=null?!!r.is_featured:!1}}),a=i.data,n=i.errors;if(a.length===0)return{inserted:0,priceUpdated:0,renamed:0,skipped:n,details:["No se encontraron filas v\xE1lidas en el CSV."]};let[c,o,y]=await Promise.all([d(this.productRepo.getAllForImport()),this.getBrands(),this.getCategories()]),_=new Map,v=new Map,f=new Map,p=new Set;for(let e of c)_.set(e.id,e),e.sku&&v.set(e.sku.trim().toLowerCase(),e),f.set(this._normaliseName(e.name),e),p.add(e.slug);let m=new Map,w=new Set;o.forEach(e=>{m.set(this._normaliseName(e.name),e.id),w.add(e.id)});let P=new Map,R=new Set;y.forEach(e=>{P.set(this._normaliseName(e.name),e.id),R.add(e.id)});let g=[],E=new Set,A=new Set;for(let e of a){if(e.brand_id)if(this._isUuid(e.brand_id))w.has(e.brand_id);else{let s=this._normaliseName(e.brand_id);m.has(s)||E.add(s)}if(e.category_id)if(this._isUuid(e.category_id))R.has(e.category_id);else{let s=this._normaliseName(e.category_id);P.has(s)||A.add(s)}}for(let e of E)try{let s=e.charAt(0).toUpperCase()+e.slice(1),r=await d(this.brandRepo.create({name:s,slug:C.slugify(e),is_active:!0}));m.set(e,r.id),w.add(r.id),g.push(`\u2139\uFE0F Marca creada autom\xE1ticamente: ${s}`)}catch(s){g.push(`\u26A0\uFE0F No se pudo crear la marca "${e}": ${s.message??s}`)}for(let e of A)try{let s=e.charAt(0).toUpperCase()+e.slice(1),r=await d(this.categoryRepo.create({name:s,slug:C.slugify(e),type:"product",is_active:!0}));P.set(e,r.id),R.add(r.id),g.push(`\u2139\uFE0F Categor\xEDa creada autom\xE1ticamente: ${s}`)}catch(s){g.push(`\u26A0\uFE0F No se pudo crear la categor\xEDa "${e}": ${s.message??s}`)}let I=[],U=[],F=new Set;for(let e of a){let s=this._findExisting(e,_,v,f);if(s){let r=Math.min(e.price,9999999999e-2),l={id:s.id,price:r};this._isGenericRepuesto(s.name)&&e.name&&!this._isGenericRepuesto(e.name)&&(l.newName=e.name),I.push(l)}else{let r;e.brand_id&&(this._isUuid(e.brand_id)&&w.has(e.brand_id)?r=e.brand_id:r=this._isUuid(e.brand_id)?void 0:m.get(this._normaliseName(e.brand_id)));let l;e.category_id&&(this._isUuid(e.category_id)&&R.has(e.category_id)?l=e.category_id:l=this._isUuid(e.category_id)?void 0:P.get(this._normaliseName(e.category_id)));let u=e.slug||C.slugify(e.name),N=u,b=1;for(;p.has(N)||F.has(N);)N=`${u}-${b++}`;F.add(N),U.push({name:e.name,slug:N,price:Math.min(e.price,9999999999e-2),stock:Math.min(e.stock??1,99999),sku:e.sku||void 0,barcode:e.barcode||void 0,description:e.description||"",category_id:l||void 0,brand_id:r||void 0,image_url:e.image_url||void 0,is_active:e.is_active??!0,is_featured:e.is_featured??!1})}}let L=0,$=0,B=0;if(I.length>0)try{let{updated:e,errors:s}=await d(this.productRepo.bulkUpdatePrices(I));L=I.filter(r=>!r.newName).length,$=I.filter(r=>!!r.newName).length,g.push(`\u2705 ${e} productos actualizados (precio${$>0?` + ${$} renombrados`:""}).`),s>0&&g.push(`\u26A0\uFE0F ${s} actualizaciones fallaron.`)}catch(e){g.push(`\u26A0\uFE0F Error cr\xEDtico en actualizaci\xF3n de precios: ${e.message}`)}if(U.length>0){for(let s=0;s<U.length;s+=100){let r=U.slice(s,s+100);try{let l=await d(this.productRepo.upsertMany(r));B+=(l||[]).length}catch(l){console.error("Batch error:",l);let u=l.message;u.includes("products_brand_id_fkey")?u="Marca no encontrada (el ID o nombre no coincide)":u.includes("numeric field overflow")?u="N\xFAmero demasiado grande (precio o stock excede el l\xEDmite)":u.includes("duplicate key")&&(u="Nombre o SKU ya existe"),g.push(`\u26A0\uFE0F Error lote ${Math.floor(s/100)+1}: ${u}`)}}g.push(`\u{1F195} ${B} productos nuevos insertados.`)}return n>0&&g.push(`\u26D4 ${n} filas omitidas (datos inv\xE1lidos o mal formateados).`),{inserted:B,priceUpdated:L,renamed:$,skipped:n,details:g}}_findExisting(t,i,a,n){if(t.id&&i.has(t.id))return i.get(t.id);if(t.sku){let o=a.get(t.sku.trim().toLowerCase());if(o)return o}let c=this._normaliseName(t.name);return n.get(c)??null}_normaliseName(t){return(t||"").toLowerCase().trim().replace(/\s+/g," ")}_isGenericRepuesto(t){let i=(t||"").trim().toLowerCase();return i==="repuesto"||i.startsWith("repuesto ")||i.endsWith(" repuesto")}_isUuid(t){return/^[0-9a-f]{8}-[0-9a-f]{4}-[0-5][0-9a-f]{3}-[089ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t)}async bulkCustomUpdate(t){let i=t.map(a=>j({id:a.id},a.payload));await d(this.productRepo.updateMany(i))}async bulkDelete(t){await d(this.productRepo.bulkDelete(t))}async bulkIncreasePrice(t,i){let n=(await d(this.productRepo.findWithFilters({ids:t}))).data;if(!n||n.length===0)return;let c=n.map(o=>({id:o.id,price:Math.round(o.price*(1+i/100))}));await d(this.productRepo.updateMany(c))}static \u0275fac=function(i){return new(i||h)};static \u0275prov=M({token:h,factory:h.\u0275fac,providedIn:"root"})};export{H as a};
