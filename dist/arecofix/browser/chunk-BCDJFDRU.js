import{a as G}from"./chunk-L2EDD4XH.js";import{a as $}from"./chunk-JYOT3LNB.js";import{b as L,d as U,g as K,s as R}from"./chunk-7KJYGRRN.js";import{a as B}from"./chunk-F5WBDNED.js";import"./chunk-F4YL3ILH.js";import{A as z,j as Q,l as O}from"./chunk-RVT6AV4G.js";import{$ as y,Ab as i,Bb as a,Cb as d,Ib as D,Mb as p,Ob as f,Pa as T,Ua as l,Vb as I,W as k,Xb as s,Yb as g,Zb as N,aa as v,gb as F,ma as u,nc as x,oa as V,oc as h,tb as C,ub as E,xb as A,xc as _,yb as q,zb as b}from"./chunk-G4WDTWI7.js";import{a as S,b as P}from"./chunk-7CGTOI24.js";var J=(o,t)=>t.id;function W(o,t){o&1&&(i(0,"div",9),d(1,"span",33),a())}function X(o,t){o&1&&(i(0,"div",10),d(1,"i",34),i(2,"p",35),s(3,"No se encontraron productos."),a()())}function Y(o,t){if(o&1){let e=D();i(0,"div",37),p("click",function(){let n=y(e).$implicit,m=f(2);return v(m.addToCart(n))}),i(1,"figure",38),d(2,"img",39),i(3,"div",40),s(4),a()(),i(5,"div",41)(6,"h3",42),s(7),a(),i(8,"div",43),s(9),x(10,"currency"),a(),i(11,"div",44),s(12),a()()()}if(o&2){let e=t.$implicit;l(2),b("src",e.image_url||"assets/img/no-image.png",T),l(),I("badge-warning",e.stock<5)("badge-primary",e.stock>=5),l(),N(" ",e.stock," "),l(3),g(e.name),l(2),N(" ",h(10,9,e.price)," "),l(3),g(e.sku)}}function Z(o,t){if(o&1&&(i(0,"div",11),A(1,Y,13,11,"div",36,J),a()),o&2){let e=f();l(),q(e.paginatedProducts())}}function ee(o,t){o&1&&(i(0,"div",10),d(1,"i",45),i(2,"p"),s(3,"Carrito Vac\xEDo"),a(),i(4,"p",46),s(5,"Selecciona productos para empezar."),a()())}function te(o,t){if(o&1){let e=D();i(0,"div",47),d(1,"img",48),i(2,"div",49)(3,"div",50),s(4),a(),i(5,"div",51)(6,"div",52),s(7),x(8,"currency"),a(),i(9,"div",53),s(10),x(11,"currency"),a()()(),i(12,"div",54)(13,"div",55)(14,"button",56),p("click",function(){let n=y(e).$implicit,m=f(2);return v(m.updateQuantity(n.id,1))}),d(15,"i",57),a(),i(16,"span",58),s(17),a(),i(18,"button",59),p("click",function(){let n=y(e).$implicit,m=f(2);return v(m.updateQuantity(n.id,-1))}),d(19,"i",60),a()()(),i(20,"button",61),p("click",function(){let n=y(e).$implicit,m=f(2);return v(m.removeFromCart(n.id))}),d(21,"i",62),a()()}if(o&2){let e=t.$implicit;l(),b("src",e.image_url||"assets/img/no-image.png",T),l(3),g(e.name),l(3),g(h(8,5,e.price)),l(3),g(h(11,7,e.price*e.quantity)),l(7),g(e.quantity)}}function ie(o,t){if(o&1&&A(0,te,22,9,"div",47,J),o&2){let e=f();q(e.cart())}}function re(o,t){o&1&&(d(0,"span",63),s(1," Procesando... "))}function ae(o,t){o&1&&(d(0,"i",64),s(1," Confirmar Venta "))}var H=class o{auth=k($);router=k(z);logger=k(B);products=u([]);cart=u([]);searchQuery=u("");loading=u(!1);processing=u(!1);isCartOpenMobile=u(!1);currentPage=u(1);itemsPerPage=u(12);filteredProducts=_(()=>{let t=this.searchQuery().toLowerCase();return this.products().filter(e=>e.name.toLowerCase().includes(t)||e.sku?.toLowerCase().includes(t)||e.barcode?.toLowerCase().includes(t))});paginatedProducts=_(()=>{let t=this.filteredProducts(),e=(this.currentPage()-1)*this.itemsPerPage();return t.slice(e,e+this.itemsPerPage())});totalPages=_(()=>Math.ceil(this.filteredProducts().length/this.itemsPerPage()));cartTotal=_(()=>this.cart().reduce((t,e)=>t+e.price*e.quantity,0));cartCount=_(()=>this.cart().reduce((t,e)=>t+e.quantity,0));constructor(){V(()=>{this.searchQuery(),this.currentPage.set(1)})}async ngOnInit(){await this.loadProducts()}async loadProducts(){this.loading.set(!0);let t=this.auth.getSupabaseClient(),{data:e}=await t.from("products").select("*").eq("is_active",!0).gt("stock",0).order("name");e&&this.products.set(e),this.loading.set(!1)}addToCart(t){this.cart.update(e=>{let r=e.find(n=>n.id===t.id);return r?r.quantity>=t.stock?e:e.map(n=>n.id===t.id?P(S({},n),{quantity:n.quantity+1}):n):[...e,P(S({},t),{quantity:1})]})}removeFromCart(t){this.cart.update(e=>e.filter(r=>r.id!==t))}updateQuantity(t,e){this.cart.update(r=>r.map(n=>{if(n.id===t){let w=this.products().find(M=>M.id===t)?.stock||0,c=n.quantity+e;return c>w?n:c>0?P(S({},n),{quantity:c}):n}return n}))}async checkout(){if(this.cart().length===0)return;this.processing.set(!0);let t=this.auth.getSupabaseClient(),e=this.auth.getCurrentUser();try{let{data:r,error:n}=await t.from("sales").insert({staff_id:e?.id,total_amount:this.cartTotal(),status:"completed",payment_method:"cash"}).select().single();if(n)throw n;let m=this.cart().map(c=>({sale_id:r.id,product_id:c.id,quantity:c.quantity,unit_price:c.price,subtotal:c.price*c.quantity})),{error:w}=await t.from("sale_items").insert(m);if(w)throw w;for(let c of this.cart()){let{error:M}=await t.rpc("decrement_stock",{row_id:c.id,amount:c.quantity});if(M){let{data:j}=await t.from("products").select("stock").eq("id",c.id).single();j&&await t.from("products").update({stock:j.stock-c.quantity}).eq("id",c.id)}}await t.from("invoices").insert({sale_id:r.id,total_amount:this.cartTotal(),type:"B",issued_at:new Date().toISOString()}),this.cart.set([]),this.router.navigate(["/admin/invoices"])}catch(r){this.logger.error("Checkout error",r),alert("Error al procesar la venta: "+r.message)}finally{this.processing.set(!1)}}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=F({type:o,selectors:[["app-admin-sales-page"]],decls:50,vars:19,consts:[[1,"h-[calc(100vh-4rem)]","flex","flex-col","md:flex-row","bg-gray-50","dark:bg-[#0f172a]","overflow-hidden"],[1,"flex-1","flex","flex-col","h-full","overflow-hidden","relative"],[1,"bg-white","dark:bg-[#1e293b]","p-4","border-b","border-gray-200","dark:border-gray-700","z-10","shadow-xs","flex","flex-col","sm:flex-row","justify-between","items-center","gap-4"],[1,"text-2xl","font-bold","bg-clip-text","text-transparent","bg-linear-to-r","from-blue-500","to-indigo-500","flex","items-center","gap-2"],[1,"fas","fa-cash-register","text-indigo-500"],[1,"w-full","sm:max-w-md","relative","group"],[1,"fas","fa-search","absolute","left-4","top-1/2","-translate-y-1/2","text-gray-400"],["type","text","placeholder","Buscar por nombre, SKU, c\xF3digo...",1,"input","input-bordered","w-full","pl-10","bg-gray-50","dark:bg-gray-800","transition-all","focus:ring-2","focus:ring-primary/20",3,"ngModelChange","ngModel"],[1,"flex-1","overflow-y-auto","p-4","md:p-6","custom-scrollbar"],[1,"flex","justify-center","py-20"],[1,"flex","flex-col","items-center","justify-center","h-64","text-gray-400"],[1,"grid","grid-cols-2","sm:grid-cols-3","lg:grid-cols-4","xl:grid-cols-5","gap-4"],[1,"mt-8","flex","justify-center","pb-8"],[3,"pages","currentPage"],[1,"md:hidden","fixed","bottom-6","right-6","btn","btn-circle","btn-primary","btn-lg","shadow-2xl","z-50",3,"click"],[1,"indicator"],[1,"indicator-item","badge","badge-secondary"],[1,"fas","fa-shopping-cart","text-2xl"],[1,"fixed","inset-y-0","right-0","z-40","w-full","md:relative","md:w-96","bg-white","dark:bg-[#1e293b]","shadow-2xl","md:shadow-none","border-l","border-gray-200","dark:border-gray-700","transform","transition-transform","duration-300","ease-in-out","flex","flex-col","h-full"],[1,"p-4","border-b","border-gray-200","dark:border-gray-700","bg-gray-50","dark:bg-gray-800","flex","justify-between","items-center"],[1,"text-xl","font-bold","flex","items-center","gap-2","text-gray-800","dark:text-white"],[1,"fas","fa-shopping-cart","text-primary"],[1,"badge","badge-neutral"],[1,"btn","btn-circle","btn-sm","btn-ghost","md:hidden",3,"click"],[1,"fas","fa-times"],[1,"flex-1","overflow-y-auto","p-4","space-y-3","custom-scrollbar"],[1,"p-6","border-t","border-gray-200","dark:border-gray-700","bg-white","dark:bg-[#1e293b]","shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]","z-20"],[1,"space-y-4","mb-6"],[1,"flex","justify-between","text-gray-500","text-sm"],[1,"flex","justify-between","items-end"],[1,"text-lg","font-bold","text-gray-800","dark:text-white"],[1,"text-3xl","font-bold","text-primary"],[1,"btn","btn-primary","w-full","btn-lg","shadow-lg","shadow-blue-500/30","text-lg","hover:scale-[1.02]","active:scale-[0.98]","transition-all",3,"click","disabled"],[1,"loading","loading-spinner","loading-lg","text-primary"],[1,"fas","fa-box-open","text-6xl","mb-4","opacity-50"],[1,"text-lg"],[1,"card","bg-white","dark:bg-gray-800","shadow-sm","border","border-gray-100","dark:border-gray-700","hover:shadow-xl","hover:border-primary/50","transition-all","duration-200","cursor-pointer","group","active:scale-95"],[1,"card","bg-white","dark:bg-gray-800","shadow-sm","border","border-gray-100","dark:border-gray-700","hover:shadow-xl","hover:border-primary/50","transition-all","duration-200","cursor-pointer","group","active:scale-95",3,"click"],[1,"px-4","pt-4","relative","aspect-square"],["alt","Product",1,"rounded-xl","object-contain","w-full","h-full","group-hover:scale-105","transition-transform",3,"src"],[1,"absolute","top-2","right-2","badge","badge-sm"],[1,"card-body","p-4","text-center"],[1,"font-bold","text-sm","line-clamp-2","text-gray-800","dark:text-gray-200","h-10","leading-tight"],[1,"mt-2","text-primary","font-bold","text-lg"],[1,"text-xs","text-gray-400","font-mono"],[1,"fas","fa-cart-arrow-down","text-6xl","mb-4","opacity-30"],[1,"text-sm"],[1,"flex","items-center","gap-3","bg-gray-50","dark:bg-gray-800/50","p-3","rounded-xl","border","border-gray-100","dark:border-gray-700","animate-fade-in","group","hover:bg-white","dark:hover:bg-gray-800","transition-colors","shadow-sm"],[1,"w-16","h-16","object-cover","rounded-lg","bg-white",3,"src"],[1,"flex-1","min-w-0"],[1,"font-bold","text-sm","text-gray-900","dark:text-gray-100","truncate","mb-1"],[1,"flex","justify-between","items-center"],[1,"text-xs","text-gray-500"],[1,"font-bold","text-gray-900","dark:text-white"],[1,"flex","flex-col","items-center","ml-2","gap-1"],[1,"join","join-vertical","shadow-sm"],[1,"btn","btn-xs","join-item","btn-ghost","text-success",3,"click"],[1,"fas","fa-plus"],[1,"join-item","bg-base-100","text-xs","font-bold","w-6","h-5","flex","items-center","justify-center","border-x","border-base-200"],[1,"btn","btn-xs","join-item","btn-ghost","text-warning",3,"click"],[1,"fas","fa-minus"],[1,"btn","btn-circle","btn-ghost","btn-xs","text-gray-400","hover:text-error","opacity-0","group-hover:opacity-100","transition-opacity",3,"click"],[1,"fas","fa-trash"],[1,"loading","loading-spinner"],[1,"fas","fa-check-circle","mr-2"]],template:function(e,r){e&1&&(i(0,"div",0)(1,"div",1)(2,"div",2)(3,"div")(4,"h1",3),d(5,"i",4),s(6," Punto de Venta "),a()(),i(7,"div",5),d(8,"i",6),i(9,"input",7),p("ngModelChange",function(m){return r.searchQuery.set(m)}),a()()(),i(10,"div",8),C(11,W,2,0,"div",9)(12,X,4,0,"div",10)(13,Z,3,0,"div",11),i(14,"div",12),d(15,"pagination",13),a()(),i(16,"button",14),p("click",function(){return r.isCartOpenMobile.set(!0)}),i(17,"div",15)(18,"span",16),s(19),a(),d(20,"i",17),a()()(),i(21,"div",18)(22,"div",19)(23,"h2",20),d(24,"i",21),s(25," Carrito "),i(26,"span",22),s(27),a()(),i(28,"button",23),p("click",function(){return r.isCartOpenMobile.set(!1)}),d(29,"i",24),a()(),i(30,"div",25),C(31,ee,6,0,"div",10)(32,ie,2,0),a(),i(33,"div",26)(34,"div",27)(35,"div",28)(36,"span"),s(37,"Subtotal"),a(),i(38,"span"),s(39),x(40,"currency"),a()(),i(41,"div",29)(42,"span",30),s(43,"Total a Pagar"),a(),i(44,"span",31),s(45),x(46,"currency"),a()()(),i(47,"button",32),p("click",function(){return r.checkout()}),C(48,re,2,0)(49,ae,2,0),a()()()()),e&2&&(l(9),b("ngModel",r.searchQuery()),l(2),E(r.loading()?11:r.paginatedProducts().length===0?12:13),l(4),b("pages",r.totalPages())("currentPage",r.currentPage()),l(4),g(r.cartCount()),l(2),I("translate-x-full",!r.isCartOpenMobile())("md:translate-x-0",!0),l(6),g(r.cartCount()),l(4),E(r.cart().length===0?31:32),l(8),g(h(40,15,r.cartTotal())),l(6),g(h(46,17,r.cartTotal())),l(2),b("disabled",r.cart().length===0||r.processing()),l(),E(r.processing()?48:49))},dependencies:[O,R,L,U,K,G,Q],encapsulation:2})};export{H as AdminSalesPage};
