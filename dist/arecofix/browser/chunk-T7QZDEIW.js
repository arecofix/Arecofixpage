import{a as T}from"./chunk-AWQLWEOW.js";import{a as R}from"./chunk-6KLMDNRR.js";import{a as w}from"./chunk-DJUFVP4V.js";import{a as C}from"./chunk-MQUL3GSM.js";import{R as h,W as g,p as f}from"./chunk-YEQHDEKA.js";var y=class p{constructor(){}async parse(t,r){return new Promise((s,o)=>{let i=new FileReader;i.onload=a=>{try{let n=a.target?.result;if(!n){o(new Error("Empty file"));return}let l=n.split(/\r\n|\n/),u=l[0].split(",").map(c=>c.trim()),d=[],e=0;for(let c=1;c<l.length;c++){let v=l[c].trim();if(!v)continue;let m=this.parseLine(v);if(m.length!==u.length){console.warn(`Skipping line ${c+1}: Column count mismatch`),e++;continue}let b=r(m,u);b?d.push(b):e++}s({data:d,errors:e})}catch(n){o(n)}},i.onerror=a=>o(a),i.readAsText(t)})}exportToCsv(t,r,s){if(!t.length)return;let o=[s.join(","),...t.map(l=>s.map(u=>{let d=l[u],e=d??"";return typeof e=="string"&&(e.includes(",")||e.includes('"')||e.includes(`
`))?`"${e.replace(/"/g,'""')}"`:e}).join(","))].join(`
`),i=new Blob([o],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a"),n=URL.createObjectURL(i);a.setAttribute("href",n),a.setAttribute("download",`${r}_${new Date().toISOString().split("T")[0]}.csv`),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)}parseLine(t){let r=[],s=!1,o="";for(let i of t)i==='"'?s=!s:i===","&&!s?(r.push(o),o=""):o+=i;return r.push(o),r}static \u0275fac=function(r){return new(r||p)};static \u0275prov=h({token:p,factory:p.\u0275fac,providedIn:"root"})};var P=class{static slugify(t){return t.toString().toLowerCase().trim().replace(/\s+/g,"-").replace(/&/g,"-and-").replace(/[^a-z0-9-]/g,"").replace(/-+/g,"-")}static capitalize(t){return t?t.charAt(0).toUpperCase()+t.slice(1):""}};var I=class p{productRepo=g(C);brandRepo=g(R);categoryRepo=g(T);csvService=g(y);auth=g(w);supabase=this.auth.getSupabaseClient();async getProducts(){return f(this.productRepo.getAll())}async getProduct(t){return f(this.productRepo.getById(t))}async getBrands(){return f(this.brandRepo.getAll())}async getCategories(){return f(this.categoryRepo.getAll())}async createProduct(t){await f(this.productRepo.create(t))}async updateProduct(t,r){await f(this.productRepo.update(t,r))}async uploadImage(t){let r=`products/${Date.now()}-${t.name}`,{data:s,error:o}=await this.supabase.storage.from("public-assets").upload(r,t);if(o)throw o;let{data:i}=this.supabase.storage.from("public-assets").getPublicUrl(s.path);return i.publicUrl}slugify(t){return P.slugify(t)}async exportProductsToCSV(){let t=await this.getProducts();if(!t.length)return;let r=["id","name","slug","description","price","stock","category_id","brand_id","image_url","is_active","is_featured","sku","barcode"];this.csvService.exportToCsv(t,"products_export",r)}async importProductsFromCSV(t){return new Promise((r,s)=>{let o=new FileReader;o.onload=async i=>{try{if(!i.target?.result)throw new Error("Empty file");let n=await this.csvService.parse(t,(u,d)=>{let e={};return d.forEach((c,v)=>{let m=u[v]?.trim();m===""||m===void 0?e[c]=null:c==="price"||c==="stock"||c==="min_stock_alert"?e[c]=Number(m):c==="is_active"||c==="is_featured"?e[c]=m.toLowerCase()==="true":e[c]=m}),(!e.id||e.id==="new")&&delete e.id,e.name&&(e.price===void 0||e.price>=0)?e:null}),l=n.data;if(l.length>0){let{error:u}=await this.supabase.from("products").upsert(l,{onConflict:"id"});if(u)throw u}r({success:l.length,errors:n.errors})}catch(a){s(a)}},o.onerror=i=>s(i),o.readAsText(t)})}async bulkUpdate(t,r){let{error:s}=await this.supabase.from("products").update(r).in("id",t);if(s)throw s}async bulkIncreasePrice(t,r){let{data:s,error:o}=await this.supabase.from("products").select("id, price").in("id",t);if(o)throw o;if(!s||s.length===0)return;let i=s.map(n=>({id:n.id,price:Math.round(n.price*(1+r/100))})),a=5;for(let n=0;n<i.length;n+=a){let l=i.slice(n,n+a);await Promise.all(l.map(u=>this.supabase.from("products").update({price:u.price}).eq("id",u.id)))}}static \u0275fac=function(r){return new(r||p)};static \u0275prov=h({token:p,factory:p.\u0275fac,providedIn:"root"})};export{I as a};
