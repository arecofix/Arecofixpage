import{a as E}from"./chunk-4HXPTVC3.js";import{a as I}from"./chunk-773BQMTG.js";import{C as f,T as y,X as O,Y as w,n as p,u as l}from"./chunk-OOA6GWW3.js";import{a as m,b as _}from"./chunk-7CGTOI24.js";var S=class c{constructor(e){this.authService=e;this.supabase=this.authService.getSupabaseClient()}supabase;logger=w(I);getOrders(){return p(this.supabase.from("orders").select("*, order_items(*)").order("created_at",{ascending:!1})).pipe(l(({data:e,error:a})=>{if(a)throw a;return(e||[]).map(r=>({id:r.id,created_at:r.created_at,updated_at:r.updated_at||void 0,order_number:r.order_number,customer_name:r.customer_name,customer_email:r.customer_email,customer_phone:r.customer_phone||void 0,customer_address:r.customer_address||void 0,customer_id:r.customer_id||void 0,status:r.status,subtotal:r.subtotal,tax:r.tax,discount:r.discount,total:r.total_amount,notes:r.notes||void 0,items:(r.order_items||[]).map(t=>({id:t.id,order_id:t.order_id,product_id:t.product_id,product_name:t.product_name,quantity:t.quantity,unit_price:t.unit_price,subtotal:t.subtotal,created_at:t.created_at}))}))}),f(e=>{throw this.logger.error("Error fetching orders:",e),e}))}getOrderById(e){return p(Promise.all([this.supabase.from("orders").select("*").eq("id",e).single(),this.supabase.from("order_items").select("*").eq("order_id",e)])).pipe(l(([a,r])=>{if(a.error)throw a.error;if(r.error)throw r.error;let t=a.data,s=r.data||[];return{id:t.id,created_at:t.created_at,updated_at:t.updated_at||void 0,order_number:t.order_number,customer_name:t.customer_name,customer_email:t.customer_email,customer_phone:t.customer_phone||void 0,customer_address:t.customer_address||void 0,customer_id:t.customer_id||void 0,status:t.status,subtotal:t.subtotal,tax:t.tax,discount:t.discount,total:t.total_amount,notes:t.notes||void 0,items:s.map(d=>({id:d.id,order_id:d.order_id,product_id:d.product_id||void 0,product_name:d.product_name,quantity:d.quantity,unit_price:d.unit_price,subtotal:d.subtotal,created_at:d.created_at}))}}),f(a=>{throw this.logger.error("Error fetching order:",a),a}))}async createOrder(e,a){try{let r=crypto.randomUUID(),t=`ORD-${Date.now()}`,s={id:r,customer_name:e.customer_name,customer_email:e.customer_email,customer_phone:e.customer_phone,customer_address:e.customer_address,status:e.status||"pending",subtotal:e.subtotal,tax:e.tax,discount:e.discount,total_amount:e.total,notes:e.notes,order_number:t,customer_id:e.customer_id},{error:u}=await this.supabase.from("orders").insert(s);if(u)throw u;let d=a.map(n=>({order_id:r,product_id:n.product_id,product_name:n.product_name,quantity:n.quantity,unit_price:n.unit_price,subtotal:n.subtotal})),{error:i}=await this.supabase.from("order_items").insert(d);if(i)throw i;return{data:_(m({},e),{id:r,order_number:t,created_at:new Date().toISOString()}),error:null}}catch(r){return this.logger.error("Error creating order:",r),{data:null,error:r}}}async updateOrderStatus(e,a){let{error:r}=await this.supabase.from("orders").update({status:a,updated_at:new Date().toISOString()}).eq("id",e);return{error:r}}async deleteOrder(e){let{error:a}=await this.supabase.from("orders").delete().eq("id",e);return{error:a}}async updateOrder(e,a,r){try{let t={customer_name:a.customer_name,customer_email:a.customer_email,customer_phone:a.customer_phone,customer_address:a.customer_address,status:a.status,subtotal:a.subtotal,tax:a.tax,discount:a.discount,total_amount:a.total,notes:a.notes,updated_at:new Date().toISOString()},{data:s,error:u}=await this.supabase.from("orders").update(t).eq("id",e).select().maybeSingle();if(u)throw u;if(!s)throw new Error("Order not found or permission denied");let{data:d,error:i}=await this.supabase.from("order_items").select("id").eq("order_id",e);if(i)throw i;let h=(d||[]).map(o=>o.id),n=r.filter(o=>o.id).map(o=>o.id),b=h.filter(o=>!n.includes(o));if(b.length>0){let{error:o}=await this.supabase.from("order_items").delete().in("id",b);if(o)throw o}let q=r.map(o=>_(m({},o.id?{id:o.id}:{}),{order_id:e,product_name:o.product_name,quantity:o.quantity,unit_price:o.unit_price,subtotal:o.subtotal,product_id:o.product_id})),{error:g}=await this.supabase.from("order_items").upsert(q);if(g)throw g;return{data:{id:s.id,order_number:s.order_number,customer_name:s.customer_name,customer_email:s.customer_email,customer_phone:s.customer_phone||void 0,customer_address:s.customer_address||void 0,status:s.status,subtotal:s.subtotal,tax:s.tax,discount:s.discount,total:s.total_amount,notes:s.notes||void 0,created_at:s.created_at,updated_at:s.updated_at||void 0},error:null}}catch(t){return this.logger.error("Error updating order:",t),{data:null,error:t}}}static \u0275fac=function(a){return new(a||c)(O(E))};static \u0275prov=y({token:c,factory:c.\u0275fac,providedIn:"root"})};export{S as a};
