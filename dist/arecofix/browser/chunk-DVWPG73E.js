import{a as te}from"./chunk-QNATMAKW.js";import{b as j,d as G,e as Q,f as $,g as U,h as z,i as H,l as J,m as K,n as X,o as Y,p as Z,s as ee}from"./chunk-JC43VCPH.js";import{a as R}from"./chunk-CPI2BPDE.js";import"./chunk-NR3BVOML.js";import{e as q,g as B,h as L}from"./chunk-Z245BGFQ.js";import"./chunk-IIPDUD2U.js";import"./chunk-T7AXESXA.js";import{r as D}from"./chunk-L5RZOCV7.js";import{$b as W,Ab as O,Bb as w,Cb as t,Cc as N,Db as i,Eb as f,Kb as V,Ob as h,Qb as x,Ub as T,Wa as l,Y as v,Yb as r,Zb as I,_b as g,ac as p,ba as u,bc as b,ca as c,cc as _,ib as k,oa as F,vb as y,wb as S,xb as A,zb as P}from"./chunk-SISNN44B.js";import{a as M,b as E}from"./chunk-VOSPIT4N.js";var re=(m,n)=>n.id;function oe(m,n){m&1&&(t(0,"div",22),f(1,"i",41),t(2,"p"),r(3,"No hay productos agregados"),i()())}function ae(m,n){if(m&1&&(t(0,"option",52),r(1),i()),m&2){let o=n.$implicit;w("value",o.id),l(),W(" ",o.name," (",o.sku,") ")}}function de(m,n){if(m&1){let o=V();t(0,"tr",48)(1,"td",49)(2,"select",50),h("change",function(a){let s=u(o).$index,d=x(2);return c(d.onProductSelect(s,a.target.value))}),t(3,"option",51),r(4,"Seleccionar producto..."),i(),P(5,ae,2,3,"option",52,re),i()(),t(7,"td")(8,"input",53),_("ngModelChange",function(a){let s=u(o).$implicit;return b(s.quantity,a)||(s.quantity=a),c(a)}),h("ngModelChange",function(){let a=u(o).$index,s=x(2);return c(s.onQuantityChange(a))}),i()(),t(9,"td",54),r(10),i(),t(11,"td",55),r(12),i(),t(13,"td",56)(14,"button",57),h("click",function(){let a=u(o).$index,s=x(2);return c(s.removeItem(a))}),f(15,"i",58),i()()()}if(m&2){let o=n.$implicit,e=n.$index,a=x(2);l(2),w("value",o.product_id),l(3),O(a.products),l(3),p("ngModel",o.quantity),w("name","quantity_"+e),l(2),g("$",o.unit_price.toFixed(2)),l(2),g("$",o.subtotal.toFixed(2)," ")}}function se(m,n){if(m&1&&(t(0,"div",23)(1,"table",42)(2,"thead")(3,"tr",43)(4,"th",44),r(5,"Producto"),i(),t(6,"th",45),r(7,"Cantidad"),i(),t(8,"th",46),r(9,"Precio Unit."),i(),t(10,"th",46),r(11,"Subtotal"),i(),f(12,"th",47),i()(),t(13,"tbody"),P(14,de,16,5,"tr",48,A),i()()()),m&2){let o=x();l(14),O(o.items())}}function le(m,n){if(m&1&&(t(0,"div",36),f(1,"i",59),t(2,"span"),r(3),i()()),m&2){let o=x();l(3),I(o.error)}}function me(m,n){m&1&&f(0,"span",40)}var ne=class m{route=v(q);router=v(B);orderService=v(te);authService=v(R);cdr=v(N);id=null;loading=!0;saving=!1;error=null;products=[];form=F({customer_name:"",customer_email:"",customer_phone:"",customer_address:"",status:"pending",subtotal:0,tax:0,discount:0,total:0,notes:""});items=F([]);async ngOnInit(){this.id=this.route.snapshot.paramMap.get("id"),await this.loadProducts(),this.id&&await this.loadOrder(),this.loading=!1,this.cdr.markForCheck()}async loadProducts(){let n=this.authService.getSupabaseClient(),{data:o,error:e}=await n.from("products").select("id, name, sku, price, stock").eq("is_active",!0).order("name");!e&&o&&(this.products=o)}async loadOrder(){this.id&&this.orderService.getOrderById(this.id).subscribe({next:n=>{this.form.set({customer_name:n.customer_name,customer_email:n.customer_email,customer_phone:n.customer_phone,customer_address:n.customer_address,status:n.status,subtotal:n.subtotal,tax:n.tax,discount:n.discount,total:n.total,notes:n.notes}),this.items.set(n.items),this.cdr.markForCheck()},error:n=>{this.error=n.message,this.cdr.markForCheck()}})}addItem(){this.items.update(n=>[...n,{product_name:"",quantity:1,unit_price:0,subtotal:0}]),this.cdr.markForCheck()}removeItem(n){this.items.update(o=>o.filter((e,a)=>a!==n)),this.calculateTotals()}onProductSelect(n,o){let e=this.products.find(a=>a.id===o);e&&(this.items.update(a=>{let s=[...a];return s[n]=E(M({},s[n]),{product_id:e.id,product_name:e.name,product_sku:e.sku,unit_price:e.price,subtotal:e.price*s[n].quantity}),s}),this.calculateTotals())}onQuantityChange(n){this.items.update(o=>{let e=[...o];return e[n].subtotal=e[n].unit_price*e[n].quantity,e}),this.calculateTotals()}calculateTotals(){let n=this.items().reduce((C,ie)=>C+ie.subtotal,0),o=this.form().discount||0,e=.21,a=n-o,s=a*e,d=a+s;this.form.update(C=>E(M({},C),{subtotal:n,tax:s,total:d})),this.cdr.markForCheck()}async save(){if(this.items().length===0){this.error="Debes agregar al menos un producto",this.cdr.markForCheck();return}this.saving=!0,this.error=null;try{let n;this.id?n=await this.orderService.updateOrder(this.id,this.form(),this.items()):n=await this.orderService.createOrder(this.form(),this.items());let{error:o}=n;if(o)throw o;this.router.navigate(["/admin/orders"])}catch(n){this.error=n.message||"Error al guardar pedido",this.saving=!1,this.cdr.markForCheck()}}static \u0275fac=function(o){return new(o||m)};static \u0275cmp=k({type:m,selectors:[["app-admin-order-form-page"]],decls:89,vars:17,consts:[["f","ngForm"],[1,"max-w-4xl","mx-auto","text-base-content"],[1,"text-2xl","font-bold","mb-6","text-green-600"],[3,"ngSubmit"],[1,"bg-base-100","p-6","rounded-xl","shadow-sm","border","border-base-200","mb-6","text-base-content"],[1,"text-lg","font-semibold","mb-4","text-base-content","border-b","border-base-200","pb-2"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-6"],[1,"block","text-sm","font-medium","text-base-content","mb-1.5"],["type","text","name","customer_name","required","",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["type","email","name","customer_email","required","",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["type","tel","name","customer_phone",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["type","text","name","customer_address",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],[1,"md:col-span-2"],["name","status",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["value","pending"],["value","processing"],["value","completed"],["value","cancelled"],[1,"flex","justify-between","items-center","mb-4","border-b","border-base-200","pb-2"],[1,"text-lg","font-semibold","text-base-content"],["type","button",1,"btn","btn-sm","btn-primary",3,"click"],[1,"fas","fa-plus","mr-2"],[1,"text-center","py-8","text-gray-500","bg-gray-50","rounded-lg","border","border-dashed","border-gray-300"],[1,"overflow-x-auto"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-8"],[1,"space-y-4"],["type","number","name","discount","min","0","step","0.01",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["name","notes","rows","3",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],[1,"bg-base-200","p-6","rounded-xl","border","border-base-300","h-fit"],[1,"space-y-3"],[1,"flex","justify-between","text-base-content/80"],[1,"font-mono","font-medium"],[1,"font-mono","font-medium","text-error"],[1,"divider","my-2"],[1,"flex","justify-between","text-xl","font-bold","text-base-content"],[1,"font-mono","text-primary"],[1,"alert","alert-error","mb-6"],[1,"flex","gap-4","justify-end","mb-8"],["routerLink","/admin/orders",1,"btn","btn-error","text-white"],["type","submit",1,"btn","btn-primary","px-8",3,"disabled"],[1,"loading","loading-spinner","loading-xs","mr-2"],[1,"fas","fa-box-open","text-4xl","mb-2","text-gray-400"],[1,"table","w-full"],[1,"text-base-content","border-b-2","border-base-200"],[1,"font-semibold"],[1,"font-semibold","w-24"],[1,"font-semibold","text-right"],[1,"w-10"],[1,"border-b","border-base-200","hover:bg-base-200/50"],[1,"min-w-[200px]"],["required","",1,"select","select-bordered","select-sm","w-full","bg-base-100","text-base-content","border-base-300",3,"change","value"],["value",""],[3,"value"],["type","number","min","1",1,"input","input-bordered","input-sm","w-full","bg-base-100","text-base-content","border-base-300",3,"ngModelChange","ngModel","name"],[1,"font-mono","text-right","text-base-content/80"],[1,"font-mono","font-semibold","text-right","text-base-content"],[1,"text-right"],["type","button",1,"btn","btn-ghost","btn-sm","btn-circle","text-error","hover:bg-red-50",3,"click"],[1,"fas","fa-trash"],[1,"fas","fa-exclamation-circle"]],template:function(o,e){if(o&1){let a=V();t(0,"div",1)(1,"h2",2),r(2),i(),t(3,"form",3,0),h("ngSubmit",function(){return u(a),c(e.save())}),t(5,"div",4)(6,"h3",5),r(7,"Informaci\xF3n del Cliente"),i(),t(8,"div",6)(9,"div")(10,"label",7),r(11,"Nombre *"),i(),t(12,"input",8),_("ngModelChange",function(d){return u(a),b(e.form().customer_name,d)||(e.form().customer_name=d),c(d)}),i()(),t(13,"div")(14,"label",7),r(15,"Email *"),i(),t(16,"input",9),_("ngModelChange",function(d){return u(a),b(e.form().customer_email,d)||(e.form().customer_email=d),c(d)}),i()(),t(17,"div")(18,"label",7),r(19,"Tel\xE9fono"),i(),t(20,"input",10),_("ngModelChange",function(d){return u(a),b(e.form().customer_phone,d)||(e.form().customer_phone=d),c(d)}),i()(),t(21,"div")(22,"label",7),r(23,"Direcci\xF3n"),i(),t(24,"input",11),_("ngModelChange",function(d){return u(a),b(e.form().customer_address,d)||(e.form().customer_address=d),c(d)}),i()(),t(25,"div",12)(26,"label",7),r(27,"Estado"),i(),t(28,"select",13),_("ngModelChange",function(d){return u(a),b(e.form().status,d)||(e.form().status=d),c(d)}),t(29,"option",14),r(30,"Pendiente"),i(),t(31,"option",15),r(32,"Procesando"),i(),t(33,"option",16),r(34,"Completado"),i(),t(35,"option",17),r(36,"Cancelado"),i()()()()(),t(37,"div",4)(38,"div",18)(39,"h3",19),r(40,"Productos"),i(),t(41,"button",20),h("click",function(){return u(a),c(e.addItem())}),f(42,"i",21),r(43," Agregar Producto "),i()(),y(44,oe,4,0,"div",22)(45,se,16,0,"div",23),i(),t(46,"div",4)(47,"h3",5),r(48,"Totales y Notas"),i(),t(49,"div",24)(50,"div",25)(51,"div")(52,"label",7),r(53,"Descuento"),i(),t(54,"input",26),_("ngModelChange",function(d){return u(a),b(e.form().discount,d)||(e.form().discount=d),c(d)}),h("ngModelChange",function(){return u(a),c(e.calculateTotals())}),i()(),t(55,"div")(56,"label",7),r(57,"Notas"),i(),t(58,"textarea",27),_("ngModelChange",function(d){return u(a),b(e.form().notes,d)||(e.form().notes=d),c(d)}),i()()(),t(59,"div",28)(60,"div",29)(61,"div",30)(62,"span"),r(63,"Subtotal:"),i(),t(64,"span",31),r(65),i()(),t(66,"div",30)(67,"span"),r(68,"Descuento:"),i(),t(69,"span",32),r(70),i()(),t(71,"div",30)(72,"span"),r(73,"IVA (21%):"),i(),t(74,"span",31),r(75),i()(),f(76,"div",33),t(77,"div",34)(78,"span"),r(79,"Total:"),i(),t(80,"span",35),r(81),i()()()()()(),y(82,le,4,1,"div",36),t(83,"div",37)(84,"a",38),r(85,"Cancelar"),i(),t(86,"button",39),y(87,me,1,0,"span",40),r(88),i()()()()}if(o&2){let a=T(4);l(2),g("",e.id?"Editar":"Nuevo"," Pedido"),l(10),p("ngModel",e.form().customer_name),l(4),p("ngModel",e.form().customer_email),l(4),p("ngModel",e.form().customer_phone),l(4),p("ngModel",e.form().customer_address),l(4),p("ngModel",e.form().status),l(16),S(e.items().length===0?44:45),l(10),p("ngModel",e.form().discount),l(4),p("ngModel",e.form().notes),l(7),g("$",e.form().subtotal.toFixed(2)),l(5),g("-$",e.form().discount.toFixed(2)),l(5),g("$",e.form().tax.toFixed(2)),l(6),g("$",e.form().total.toFixed(2)),l(),S(e.error?82:-1),l(4),w("disabled",e.saving||a.invalid),l(),S(e.saving?87:-1),l(),g(" ",e.saving?"Guardando...":"Guardar Pedido"," ")}},dependencies:[ee,z,K,X,j,H,J,G,Q,Z,Y,U,$,L,D],encapsulation:2,changeDetection:0})};export{ne as AdminOrderFormPage};
