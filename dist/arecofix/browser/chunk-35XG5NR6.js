import{a as te}from"./chunk-A363VAN6.js";import{b as j,d as G,e as Q,f as $,g as U,h as z,i as H,l as J,m as K,n as X,o as Y,p as Z,r as ee}from"./chunk-MW2RIO7S.js";import{a as R}from"./chunk-EZQXAHE6.js";import{a as q,c as B,d as L}from"./chunk-VU7SKD6P.js";import"./chunk-FR6EAD4C.js";import"./chunk-X77PN5FN.js";import{n as D}from"./chunk-GLDAN37X.js";import{$ as c,Bb as r,Cb as I,Da as l,Db as g,Eb as W,Fb as p,Gb as _,Hb as f,Qa as k,V as y,_ as u,ab as S,bb as w,cb as A,eb as P,ec as N,fb as O,gb as v,hb as t,ib as n,jb as h,la as F,nb as V,rb as b,tb as x,xb as T}from"./chunk-VQO264VU.js";import{a as M,b as E}from"./chunk-VOSPIT4N.js";var re=(s,i)=>i.id;function oe(s,i){s&1&&(t(0,"div",22),h(1,"i",41),t(2,"p"),r(3,"No hay productos agregados"),n()())}function ae(s,i){if(s&1&&(t(0,"option",52),r(1),n()),s&2){let o=i.$implicit;v("value",o.id),l(),W(" ",o.name," (",o.sku,") ")}}function de(s,i){if(s&1){let o=V();t(0,"tr",48)(1,"td",49)(2,"select",50),b("change",function(a){let m=u(o).$index,d=x(2);return c(d.onProductSelect(m,a.target.value))}),t(3,"option",51),r(4,"Seleccionar producto..."),n(),P(5,ae,2,3,"option",52,re),n()(),t(7,"td")(8,"input",53),f("ngModelChange",function(a){let m=u(o).$implicit;return _(m.quantity,a)||(m.quantity=a),c(a)}),b("ngModelChange",function(){let a=u(o).$index,m=x(2);return c(m.onQuantityChange(a))}),n()(),t(9,"td",54),r(10),n(),t(11,"td",55),r(12),n(),t(13,"td",56)(14,"button",57),b("click",function(){let a=u(o).$index,m=x(2);return c(m.removeItem(a))}),h(15,"i",58),n()()()}if(s&2){let o=i.$implicit,e=i.$index,a=x(2);l(2),v("value",o.product_id),l(3),O(a.products),l(3),p("ngModel",o.quantity),v("name","quantity_"+e),l(2),g("$",o.unit_price.toFixed(2)),l(2),g("$",o.subtotal.toFixed(2)," ")}}function me(s,i){if(s&1&&(t(0,"div",23)(1,"table",42)(2,"thead")(3,"tr",43)(4,"th",44),r(5,"Producto"),n(),t(6,"th",45),r(7,"Cantidad"),n(),t(8,"th",46),r(9,"Precio Unit."),n(),t(10,"th",46),r(11,"Subtotal"),n(),h(12,"th",47),n()(),t(13,"tbody"),P(14,de,16,5,"tr",48,A),n()()()),s&2){let o=x();l(14),O(o.items())}}function le(s,i){if(s&1&&(t(0,"div",36),h(1,"i",59),t(2,"span"),r(3),n()()),s&2){let o=x();l(3),I(o.error)}}function se(s,i){s&1&&h(0,"span",40)}var ie=class s{route=y(q);router=y(B);orderService=y(te);authService=y(R);cdr=y(N);id=null;loading=!0;saving=!1;error=null;products=[];form=F({customer_name:"",customer_email:"",customer_phone:"",customer_address:"",status:"pending",subtotal:0,tax:0,discount:0,total:0,notes:""},{});items=F([],{});async ngOnInit(){this.id=this.route.snapshot.paramMap.get("id"),await this.loadProducts(),this.id&&await this.loadOrder(),this.loading=!1,this.cdr.markForCheck()}async loadProducts(){let i=this.authService.getSupabaseClient(),{data:o,error:e}=await i.from("products").select("id, name, sku, price, stock").eq("is_active",!0).order("name");!e&&o&&(this.products=o)}async loadOrder(){this.id&&this.orderService.getOrderById(this.id).subscribe({next:i=>{this.form.set({customer_name:i.customer_name,customer_email:i.customer_email,customer_phone:i.customer_phone,customer_address:i.customer_address,status:i.status,subtotal:i.subtotal,tax:i.tax,discount:i.discount,total:i.total,notes:i.notes}),this.items.set(i.items),this.cdr.markForCheck()},error:i=>{this.error=i.message,this.cdr.markForCheck()}})}addItem(){this.items.update(i=>[...i,{product_name:"",quantity:1,unit_price:0,subtotal:0}]),this.cdr.markForCheck()}removeItem(i){this.items.update(o=>o.filter((e,a)=>a!==i)),this.calculateTotals()}onProductSelect(i,o){let e=this.products.find(a=>a.id===o);e&&(this.items.update(a=>{let m=[...a];return m[i]=E(M({},m[i]),{product_id:e.id,product_name:e.name,product_sku:e.sku,unit_price:e.price,subtotal:e.price*m[i].quantity}),m}),this.calculateTotals())}onQuantityChange(i){this.items.update(o=>{let e=[...o];return e[i].subtotal=e[i].unit_price*e[i].quantity,e}),this.calculateTotals()}calculateTotals(){let i=this.items().reduce((C,ne)=>C+ne.subtotal,0),o=this.form().discount||0,e=.21,a=i-o,m=a*e,d=a+m;this.form.update(C=>E(M({},C),{subtotal:i,tax:m,total:d})),this.cdr.markForCheck()}async save(){if(this.items().length===0){this.error="Debes agregar al menos un producto",this.cdr.markForCheck();return}this.saving=!0,this.error=null;try{let i;this.id?i=await this.orderService.updateOrder(this.id,this.form(),this.items()):i=await this.orderService.createOrder(this.form(),this.items());let{error:o}=i;if(o)throw o;this.router.navigate(["/admin/orders"])}catch(i){this.error=i.message||"Error al guardar pedido",this.saving=!1,this.cdr.markForCheck()}}static \u0275fac=function(o){return new(o||s)};static \u0275cmp=k({type:s,selectors:[["app-admin-order-form-page"]],decls:89,vars:17,consts:[["f","ngForm"],[1,"max-w-4xl","mx-auto","text-gray-800"],[1,"text-2xl","font-bold","mb-6","text-gray-800"],[3,"ngSubmit"],[1,"admin-form-section"],[1,"text-lg","font-semibold","mb-4","text-gray-800","border-b","pb-2"],[1,"admin-form-grid"],[1,"admin-form-label"],["type","text","name","customer_name","required","",1,"admin-form-input",3,"ngModelChange","ngModel"],["type","email","name","customer_email","required","",1,"admin-form-input",3,"ngModelChange","ngModel"],["type","tel","name","customer_phone",1,"admin-form-input",3,"ngModelChange","ngModel"],["type","text","name","customer_address",1,"admin-form-input",3,"ngModelChange","ngModel"],[1,"md:col-span-2"],["name","status",1,"admin-form-select",3,"ngModelChange","ngModel"],["value","pending"],["value","processing"],["value","completed"],["value","cancelled"],[1,"flex","justify-between","items-center","mb-4","border-b","pb-2"],[1,"text-lg","font-semibold","text-gray-800"],["type","button",1,"btn","btn-sm","btn-primary",3,"click"],[1,"fas","fa-plus","mr-2"],[1,"text-center","py-8","text-gray-500","bg-gray-50","rounded-lg","border","border-dashed","border-gray-300"],[1,"overflow-x-auto"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-8"],[1,"space-y-4"],["type","number","name","discount","min","0","step","0.01",1,"admin-form-input",3,"ngModelChange","ngModel"],["name","notes","rows","3",1,"admin-form-textarea",3,"ngModelChange","ngModel"],[1,"bg-gray-50","p-6","rounded-xl","border","border-gray-100","h-fit"],[1,"space-y-3"],[1,"flex","justify-between","text-gray-600"],[1,"font-mono","font-medium"],[1,"font-mono","font-medium","text-error"],[1,"divider","my-2"],[1,"flex","justify-between","text-xl","font-bold","text-gray-800"],[1,"font-mono","text-primary"],[1,"alert","alert-error","mb-6"],[1,"flex","gap-4","justify-end","mb-8"],["routerLink","/admin/orders",1,"btn","btn-ghost"],["type","submit",1,"btn","btn-primary","px-8",3,"disabled"],[1,"loading","loading-spinner","loading-xs","mr-2"],[1,"fas","fa-box-open","text-4xl","mb-2","text-gray-400"],[1,"table","w-full"],[1,"text-gray-700","border-b-2","border-gray-100"],[1,"font-semibold"],[1,"font-semibold","w-24"],[1,"font-semibold","text-right"],[1,"w-10"],[1,"border-b","border-gray-50"],[1,"min-w-[200px]"],["required","",1,"select","select-bordered","select-sm","w-full","bg-white",3,"change","value"],["value",""],[3,"value"],["type","number","min","1",1,"input","input-bordered","input-sm","w-full","bg-white",3,"ngModelChange","ngModel","name"],[1,"font-mono","text-right","text-gray-600"],[1,"font-mono","font-semibold","text-right","text-gray-800"],[1,"text-right"],["type","button",1,"btn","btn-ghost","btn-sm","btn-circle","text-error","hover:bg-red-50",3,"click"],[1,"fas","fa-trash"],[1,"fas","fa-exclamation-circle"]],template:function(o,e){if(o&1){let a=V();t(0,"div",1)(1,"h2",2),r(2),n(),t(3,"form",3,0),b("ngSubmit",function(){return u(a),c(e.save())}),t(5,"div",4)(6,"h3",5),r(7,"Informaci\xF3n del Cliente"),n(),t(8,"div",6)(9,"div")(10,"label",7),r(11,"Nombre *"),n(),t(12,"input",8),f("ngModelChange",function(d){return u(a),_(e.form().customer_name,d)||(e.form().customer_name=d),c(d)}),n()(),t(13,"div")(14,"label",7),r(15,"Email *"),n(),t(16,"input",9),f("ngModelChange",function(d){return u(a),_(e.form().customer_email,d)||(e.form().customer_email=d),c(d)}),n()(),t(17,"div")(18,"label",7),r(19,"Tel\xE9fono"),n(),t(20,"input",10),f("ngModelChange",function(d){return u(a),_(e.form().customer_phone,d)||(e.form().customer_phone=d),c(d)}),n()(),t(21,"div")(22,"label",7),r(23,"Direcci\xF3n"),n(),t(24,"input",11),f("ngModelChange",function(d){return u(a),_(e.form().customer_address,d)||(e.form().customer_address=d),c(d)}),n()(),t(25,"div",12)(26,"label",7),r(27,"Estado"),n(),t(28,"select",13),f("ngModelChange",function(d){return u(a),_(e.form().status,d)||(e.form().status=d),c(d)}),t(29,"option",14),r(30,"Pendiente"),n(),t(31,"option",15),r(32,"Procesando"),n(),t(33,"option",16),r(34,"Completado"),n(),t(35,"option",17),r(36,"Cancelado"),n()()()()(),t(37,"div",4)(38,"div",18)(39,"h3",19),r(40,"Productos"),n(),t(41,"button",20),b("click",function(){return u(a),c(e.addItem())}),h(42,"i",21),r(43," Agregar Producto "),n()(),S(44,oe,4,0,"div",22)(45,me,16,0,"div",23),n(),t(46,"div",4)(47,"h3",5),r(48,"Totales y Notas"),n(),t(49,"div",24)(50,"div",25)(51,"div")(52,"label",7),r(53,"Descuento"),n(),t(54,"input",26),f("ngModelChange",function(d){return u(a),_(e.form().discount,d)||(e.form().discount=d),c(d)}),b("ngModelChange",function(){return u(a),c(e.calculateTotals())}),n()(),t(55,"div")(56,"label",7),r(57,"Notas"),n(),t(58,"textarea",27),f("ngModelChange",function(d){return u(a),_(e.form().notes,d)||(e.form().notes=d),c(d)}),n()()(),t(59,"div",28)(60,"div",29)(61,"div",30)(62,"span"),r(63,"Subtotal:"),n(),t(64,"span",31),r(65),n()(),t(66,"div",30)(67,"span"),r(68,"Descuento:"),n(),t(69,"span",32),r(70),n()(),t(71,"div",30)(72,"span"),r(73,"IVA (21%):"),n(),t(74,"span",31),r(75),n()(),h(76,"div",33),t(77,"div",34)(78,"span"),r(79,"Total:"),n(),t(80,"span",35),r(81),n()()()()()(),S(82,le,4,1,"div",36),t(83,"div",37)(84,"a",38),r(85,"Cancelar"),n(),t(86,"button",39),S(87,se,1,0,"span",40),r(88),n()()()()}if(o&2){let a=T(4);l(2),g("",e.id?"Editar":"Nuevo"," Pedido"),l(10),p("ngModel",e.form().customer_name),l(4),p("ngModel",e.form().customer_email),l(4),p("ngModel",e.form().customer_phone),l(4),p("ngModel",e.form().customer_address),l(4),p("ngModel",e.form().status),l(16),w(e.items().length===0?44:45),l(10),p("ngModel",e.form().discount),l(4),p("ngModel",e.form().notes),l(7),g("$",e.form().subtotal.toFixed(2)),l(5),g("-$",e.form().discount.toFixed(2)),l(5),g("$",e.form().tax.toFixed(2)),l(6),g("$",e.form().total.toFixed(2)),l(),w(e.error?82:-1),l(4),v("disabled",e.saving||a.invalid),l(),w(e.saving?87:-1),l(),g(" ",e.saving?"Guardando...":"Guardar Pedido"," ")}},dependencies:[ee,z,K,X,j,H,J,G,Q,Z,Y,U,$,L,D],encapsulation:2,changeDetection:0})};export{ie as AdminOrderFormPage};
