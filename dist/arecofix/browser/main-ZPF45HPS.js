import{a as X}from"./chunk-FBYEXMDY.js";import{a as Ct}from"./chunk-J4Q5NFZK.js";import{a as xt,b as wt}from"./chunk-XECWOO46.js";import{a as St}from"./chunk-AWQLWEOW.js";import{a as bt}from"./chunk-T3F2WVBP.js";import{a as _t}from"./chunk-LESHTFLR.js";import{a as vt}from"./chunk-6KLMDNRR.js";import{a as yt}from"./chunk-U236D7L5.js";import{a as U,b as ct,d as dt,e as pt,f as ut,g as mt,h as ft,i as E,j as gt,k as N,l as q}from"./chunk-GBGIQ7VE.js";import{a as ht}from"./chunk-TZSKIM7F.js";import{a as K}from"./chunk-MQUL3GSM.js";import{b as tt,d as rt,e as it,f as at,g as nt,h as ot,t as st}from"./chunk-63CMMPDH.js";import{a as C}from"./chunk-IP3FEPB3.js";import{a as lt}from"./chunk-SFLZ64DJ.js";import{a as Z}from"./chunk-FEKWCP2W.js";import{a as ze,b as Ge,d as Qe,e as Ye,i as Je,j as Ze,m as Ke,q as Xe,r as et}from"./chunk-YNFFGNY6.js";import{j as Q,q as Y,u as J}from"./chunk-Q44XB7TV.js";import{$ as I,$b as Be,Ab as p,Bb as u,Cb as h,Db as z,Eb as he,Fb as Oe,Gb as B,Hb as De,Kb as R,Kc as We,L as ge,Mb as S,Ob as Re,Pa as Ae,Pb as Fe,Qb as Ne,R as y,Ua as g,Ub as qe,Vb as b,W as l,Wb as G,Xb as Le,Zb as je,_b as Ue,aa as O,ba as Se,ca as ke,ea as Te,gb as F,hc as $e,ja as Pe,jc as be,k as m,l as fe,la as Ee,ma as D,r as f,ra as $,rc as Ve,sb as Me,tb as x,ub as w,uc as He,vb as Ie,xa as V,xb as H,yb as W,zb as P}from"./chunk-DX2LKEMG.js";import{a as v,b as T,c as M}from"./chunk-C6Q5SG76.js";var kt=[{title:"Home",path:"",loadChildren:()=>import("./chunk-ZHVQAC4R.js")},{title:"Admin",path:"admin",loadChildren:()=>import("./chunk-V5LL5D6F.js")},{path:"**",redirectTo:""}];var ee=class a{logger=l(C);notification=l(_t);handleError(e){this.logger.error("Unhandled error occurred",e),e instanceof Ge?this.handleHttpError(e):e instanceof dt?this.handleApplicationError(e):this.handleUnknownError(e)}handleHttpError(e){let t;switch(e.status){case 0:t="No se pudo conectar al servidor. Verifica tu conexi\xF3n a internet.";break;case 400:t="Solicitud inv\xE1lida. Por favor verifica los datos ingresados.";break;case 401:t="Sesi\xF3n expirada. Por favor inicia sesi\xF3n nuevamente.";break;case 403:t="No tienes permisos para realizar esta acci\xF3n.";break;case 404:t="El recurso solicitado no fue encontrado.";break;case 500:t="Error del servidor. Por favor intenta nuevamente m\xE1s tarde.";break;case 503:t="Servicio no disponible. Por favor intenta m\xE1s tarde.";break;default:t=`Error inesperado (${e.status}). Por favor intenta nuevamente.`}this.notification.showError(t)}handleApplicationError(e){let t;e instanceof pt?t=e.message||"Los datos ingresados no son v\xE1lidos.":e instanceof ut?t="Error de autenticaci\xF3n. Por favor inicia sesi\xF3n nuevamente.":e instanceof mt?t="No tienes permisos para realizar esta acci\xF3n.":e instanceof ft?t=e.message:e instanceof E?t="Error al acceder a la base de datos. Por favor intenta nuevamente.":e instanceof gt?t="Error de conexi\xF3n. Verifica tu internet e intenta nuevamente.":t=e.message||"Ocurri\xF3 un error inesperado.",this.notification.showError(t)}handleUnknownError(e){this.notification.showError("Ocurri\xF3 un error inesperado. Por favor intenta nuevamente.")}static \u0275fac=function(t){return new(t||a)};static \u0275prov=y({token:a,factory:a.\u0275fac})};var te=class a extends K{authService=l(q);logger=l(C);tenantService=l(N);supabase=this.authService.getSupabaseClient();useSoftDeletes=!0;applyTenantFilter(e){let t=e.eq("tenant_id",this.tenantService.getTenantId());return this.useSoftDeletes&&(t=t.is("deleted_at",null)),t}findWithFilters(e={}){let{_page:t=1,_per_page:r=10,category_id:i,brand_id:n,description:o,featured:s,id:c,name:_,price:A,slug:j,min_price:_e,max_price:ve}=e,xe=(t-1)*r,Pt=xe+r-1,Et=this.supabase.from("products").select(`
        id, name, slug, description, price, currency, image_url, gallery_urls, category_id, brand_id, 
        is_active, is_featured, sku, barcode, stock, created_at, updated_at,
        branch_stock:product_stock_per_branch(quantity, branch_id, min_stock_alert)
      `,{count:"exact"}).eq("is_active",!0),d=this.applyTenantFilter(Et);return e.category_ids&&e.category_ids.length>0?d=d.in("category_id",e.category_ids):i&&(d=d.eq("category_id",i)),n&&(d=d.eq("brand_id",n)),o&&(d=d.ilike("description",`%${o}%`)),s!=null&&(d=d.eq("is_featured",s)),c&&(d=d.eq("id",c)),e.ids&&e.ids.length>0&&(d=d.in("id",e.ids)),_&&(d=d.ilike("name",`%${_}%`)),A&&(d=d.eq("price",A)),j&&(d=d.eq("slug",j)),_e!==void 0&&(d=d.gte("price",_e)),ve!==void 0&&(d=d.lte("price",ve)),e.q&&(d=d.or(`name.ilike.%${e.q}%,description.ilike.%${e.q}%`)),e._sort?d=d.order(e._sort,{ascending:e._order==="asc"}):d=d.order("created_at",{ascending:!1}),d=d.range(xe,Pt),m(d).pipe(f(At=>{let{data:Mt,count:It,error:we}=At;if(we)throw we;let Ce=It||0,me=Math.max(1,Math.ceil(Ce/r)),Ot=(Mt||[]).map(Dt=>this._mapToEntity(Dt));return{first:1,prev:t>1?t-1:void 0,next:t<me?t+1:void 0,last:me,pages:me,items:Ce,data:Ot}}))}findLowStock(e=5){let t=this.supabase.from("products").select(`
          id, name, slug, description, price, currency, image_url, gallery_urls, category_id, brand_id, 
          is_active, is_featured, sku, barcode, stock, created_at, updated_at,
          branch_stock:product_stock_per_branch(quantity, branch_id)
        `);return m(this.applyTenantFilter(t)).pipe(f(r=>{let{data:i,error:n}=r;if(n)throw n;return(i||[]).map(o=>this._mapToEntity(o)).filter(o=>o.stock<e)}))}findAvailable(){let e=this.supabase.from("products").select(`
          id, name, slug, description, price, currency, image_url, gallery_urls, category_id, brand_id, 
          is_active, is_featured, sku, barcode, stock, created_at, updated_at,
          branch_stock:product_stock_per_branch(quantity, branch_id)
        `).eq("is_active",!0);return m(this.applyTenantFilter(e)).pipe(f(t=>{let{data:r,error:i}=t;if(i)throw i;return(r||[]).map(n=>this._mapToEntity(n)).filter(n=>n.stock>0)}))}getAll(e){let r=this.applyTenantFilter(this.supabase.from("products").select(`
          id, name, slug, description, price, currency, image_url, gallery_urls, category_id, brand_id, 
          is_active, is_featured, sku, barcode, stock, created_at, updated_at,
          branch_stock:product_stock_per_branch(quantity, branch_id)
     `));return m(r.order("created_at",{ascending:!1})).pipe(f(i=>{let{data:n,error:o}=i;if(o)throw o;return(n||[]).map(s=>this._mapToEntity(s,e))}))}getById(e){let t=this.supabase.from("products").select(`
          id, name, slug, description, price, currency, image_url, gallery_urls, category_id, brand_id, 
          is_active, is_featured, sku, barcode, stock, created_at, updated_at,
          branch_stock:product_stock_per_branch(quantity, branch_id, min_stock_alert)
        `).eq("id",e),r=this.applyTenantFilter(t).single();return m(r).pipe(f(i=>{let{data:n,error:o}=i;if(o)throw o;return this._mapToEntity(n)}))}async uploadImage(e){let t=`products/${Date.now()}-${e.name}`,{data:r,error:i}=await this.supabase.storage.from("public-assets").upload(t,e);if(i)throw i;let{data:n}=this.supabase.storage.from("public-assets").getPublicUrl(r.path);return n.publicUrl}async syncBranchStock(e,t){let r=this.authService.getCurrentUser();if(!r)return;let i=await this.authService.getUserProfile(r.id);!i||!i.branch_id||await this.supabase.from("product_stock_per_branch").upsert({product_id:e,branch_id:i.branch_id,quantity:t,updated_at:new Date().toISOString()},{onConflict:"product_id,branch_id"})}create(e){let n=e,{stock:t}=n,r=M(n,["stock"]),i=T(v({},r),{tenant_id:this.tenantService.getTenantId(),created_at:new Date().toISOString(),updated_at:new Date().toISOString()});return m(this.supabase.from("products").insert(i).select("*").single()).pipe(f(o=>{let{data:s,error:c}=o;if(c)throw c;return t!==void 0&&this.syncBranchStock(s.id,t),this._mapToEntity(s)}))}update(e,t){let c=t,{stock:r}=c,i=M(c,["stock"]);delete i.tenant_id,delete i.id;let n=T(v({},i),{updated_at:new Date().toISOString()}),o=this.supabase.from("products").update(n).eq("id",e),s=this.applyTenantFilter(o).select("*").single();return m(s).pipe(f(_=>{let{data:A,error:j}=_;if(j)throw j;return r!==void 0&&this.syncBranchStock(e,r),this._mapToEntity(A)}))}delete(e){let t=this.supabase.from("products").delete().eq("id",e),r=this.applyTenantFilter(t);return m(r).pipe(f(i=>{let{error:n}=i;if(n)throw n}))}upsertMany(e){if(!e.length)return fe([]);let t=e.map(r=>{let o=r,{stock:i}=o,n=M(o,["stock"]);return T(v({},n),{tenant_id:this.tenantService.getTenantId(),updated_at:new Date().toISOString()})});return m(this.supabase.from("products").upsert(t).select()).pipe(f(r=>{let{data:i,error:n}=r;if(n)throw n;return(i||[]).map(o=>this._mapToEntity(o))}))}updateMany(e){if(!e.length)return fe(void 0);let t=e.map(r=>{if(!r.id)return Promise.resolve({error:{message:"Missing ID"}});let c=r,{id:i,tenant_id:n}=c,o=M(c,["id","tenant_id"]),s=this.supabase.from("products").update(T(v({},o),{updated_at:new Date().toISOString()})).eq("id",i);return this.applyTenantFilter(s)});return m(Promise.all(t)).pipe(f(r=>{let i=r.filter(n=>n&&n.error);if(i.length>0)throw new Error(`Failed to update ${i.length} products`)}))}_mapToEntity(e,t){let r=!!(e.featured??e.is_featured??!1),i=0,n=e.branch_stock&&Array.isArray(e.branch_stock)?e.branch_stock:[];if(t){let o=n.find(s=>s.branch_id===t);i=o?Number(o.quantity):0}else n.length>0?i=n.reduce((o,s)=>o+(Number(s.quantity)||0),0):i=Number(e.stock||0);return{id:e.id,name:e.name,slug:e.slug,description:e.description,price:Number(e.price),image_url:e.image_url,gallery_urls:e.gallery_urls||(e.image_url?[e.image_url]:[]),category_id:e.category_id,brand_id:e.brand_id,stock:i,is_active:!!e.is_active,is_featured:r,sku:e.sku||"",barcode:e.barcode||"",currency:e.currency||"ARS",condition:e.condition,warranty:e.warranty,min_stock_alert:e.min_stock_alert?Number(e.min_stock_alert):void 0,created_at:e.created_at,updated_at:e.updated_at,branch_stock:e.branch_stock}}static \u0275fac=(()=>{let e;return function(r){return(e||(e=$(a)))(r||a)}})();static \u0275prov=y({token:a,factory:a.\u0275fac,providedIn:"root"})};var L=class{constructor(e,t){this.supabase=e;this.logger=t}isGlobalTable=!1;useSoftDeletes=!1;tenantService=l(N);applyTenantFilter(e){let t=e;if(!this.isGlobalTable){let r=this.tenantService.getTenantId();t=t.eq("tenant_id",r)}return this.useSoftDeletes&&(t=t.is("deleted_at",null)),t}getAll(e){let t=this.supabase.from(this.tableName).select("*");return t=this.applyTenantFilter(t),e&&(t=t.order(e.column,{ascending:e.ascending??!0})),m(t).pipe(f(({data:r,error:i})=>{if(i)throw this.logger.error(`Error fetching all ${this.tableName}`,i),new E(i.message,i);return r||[]}))}getById(e){let t=this.supabase.from(this.tableName).select("*").eq("id",e);return t=this.applyTenantFilter(t),m(t.single()).pipe(f(({data:r,error:i})=>{if(i)throw i.code==="PGRST116"?new Error("Not found"):(this.logger.error(`Error fetching ${this.tableName} by ID`,i),new E(i.message,i));return r}))}create(e){let t=this.isGlobalTable?e:T(v({},e),{tenant_id:this.tenantService.getTenantId()});return m(this.supabase.from(this.tableName).insert(t).select().single()).pipe(f(({data:r,error:i})=>{if(i)throw this.logger.error(`Error creating ${this.tableName}`,i),new E(i.message,i);return r}))}update(e,t){let r=v({},t);delete r.tenant_id,delete r.id;let i=this.supabase.from(this.tableName).update(r).eq("id",e);return i=this.applyTenantFilter(i),m(i.select().single()).pipe(f(({data:n,error:o})=>{if(o)throw this.logger.error(`Error updating ${this.tableName}`,o),new E(o.message,o);return n}))}delete(e){let t=this.supabase.from(this.tableName).delete().eq("id",e);return t=this.applyTenantFilter(t),m(t).pipe(f(({error:r})=>{if(r)throw this.logger.error(`Error deleting ${this.tableName}`,r),new E(r.message,r)}))}getWhere(e,t,r){let i=this.supabase.from(this.tableName).select("*").eq(e,t);return i=this.applyTenantFilter(i),r&&(i=i.order(r.column,{ascending:r.ascending??!0})),m(i).pipe(f(({data:n,error:o})=>{if(o)throw this.logger.error(`Error fetching ${this.tableName} with filter`,o),new E(o.message,o);return n||[]}))}count(){let e=this.supabase.from(this.tableName).select("*",{count:"exact",head:!0});return e=this.applyTenantFilter(e),m(e).pipe(f(({count:t,error:r})=>{if(r)throw this.logger.error(`Error counting ${this.tableName}`,r),new E(r.message,r);return t||0}))}};var re=class a extends L{tableName="categories";constructor(){let e=l(q),t=l(C);super(e.getSupabaseClient(),t)}static \u0275fac=function(t){return new(t||a)};static \u0275prov=y({token:a,factory:a.\u0275fac,providedIn:"root"})};var ie=class a extends L{tableName="brands";constructor(){let e=l(q),t=l(C);super(e.getSupabaseClient(),t)}static \u0275fac=function(t){return new(t||a)};static \u0275prov=y({token:a,factory:a.\u0275fac,providedIn:"root"})};var ae=class a extends X{auth=l(q);tenantService=l(N);supabase=this.auth.getSupabaseClient();useSoftDeletes=!0;applyTenantFilter(e){let t=e.eq("tenant_id",this.tenantService.getTenantId());return this.useSoftDeletes&&(t=t.is("deleted_at",null)),t}getById(e){let t=this.supabase.from("repairs").select("*, parts:repair_parts_used(*), images:repair_images(image_url)").eq("id",e);return m(this.applyTenantFilter(t).single()).pipe(f(r=>{let{data:i,error:n}=r;if(n)throw n;return this.mapFromDb(i)}))}getAll(e=50,t=0){let r=this.supabase.from("repairs").select("*").range(t,t+e-1),i=this.applyTenantFilter(r).order("created_at",{ascending:!1});return m(i).pipe(f(n=>{let{data:o,error:s}=n;if(s)throw s;return(o||[]).map(c=>this.mapFromDb(c))}))}create(e){let o=e,{parts:t,images:r}=o,i=M(o,["parts","images"]),n=this.mapToDb(i);return n.tenant_id=this.tenantService.getTenantId(),m(this.supabase.from("repairs").insert(n).select().single()).pipe(f(s=>{let{data:c,error:_}=s;if(_)throw _;return c}),ge(async s=>{t&&t.length>0&&await this.syncParts(s.id,t),r&&r.length>0&&await this.syncImages(s.id,r);let c=T(v({},s),{parts:t||[],images:r||[]});return this.mapFromDb(c)}))}update(e,t){let c=t,{parts:r,images:i}=c,n=M(c,["parts","images"]),o=this.mapToDb(n),s=this.supabase.from("repairs").update(o).eq("id",e).select();return m(this.applyTenantFilter(s)).pipe(f(_=>{let{error:A,data:j}=_;if(A)throw A;return j}),ge(async()=>{r&&await this.syncParts(e,r),i&&await this.syncImages(e,i)}))}async syncParts(e,t){let r=this.tenantService.getTenantId();if(await this.supabase.from("repair_parts_used").delete().eq("repair_id",e).eq("tenant_id",r),t.length>0){let i=t.map(n=>({repair_id:e,product_id:n.product_id,quantity:n.quantity,unit_price_at_time:n.unit_price_at_time,cost_at_time:n.cost_at_time,tenant_id:r}));await this.supabase.from("repair_parts_used").insert(i)}}async syncImages(e,t){let r=this.tenantService.getTenantId();if(await this.supabase.from("repair_images").delete().eq("repair_id",e).eq("tenant_id",r),t&&t.length>0){let i=t.map(n=>({repair_id:e,image_url:typeof n=="string"?n:n.image_url,tenant_id:r}));await this.supabase.from("repair_images").insert(i)}}delete(e){let t=this.supabase.from("repairs").delete().eq("id",e);return m(this.applyTenantFilter(t)).pipe(f(r=>{let{error:i}=r;if(i)throw i}))}getByTrackingCode(e){let t=this.supabase.from("repairs").select("*, parts:repair_parts_used(*), images:repair_images(image_url)").eq("tracking_code",e);return m(this.applyTenantFilter(t).single()).pipe(f(r=>{let{data:i,error:n}=r;if(n)throw n;return this.mapFromDb(i)}))}async uploadImage(e){let t=e.name.split(".").pop(),n=`${`${this.tenantService.getTenantId()}_${Math.random().toString(36).substring(2,15)}_${Date.now()}.${t}`}`,{error:o}=await this.supabase.storage.from("repair-images").upload(n,e);if(o)throw o;let{data:s}=this.supabase.storage.from("repair-images").getPublicUrl(n);return s.publicUrl}getAdminList(e){let{branch_id:t,limit:r=50,offset:i=0}=e,n=this.supabase.from("repairs").select("*").range(i,i+r-1);t&&(n=n.eq("branch_id",t));let o=this.applyTenantFilter(n).order("received_at",{ascending:!1});return m(o).pipe(f(s=>{let{data:c,error:_}=s;if(_)throw _;return(c||[]).map(A=>this.mapFromDb(A))}))}mapFromDb(e){return T(v({},e),{device_brand:e.device_brand||"generic",images:e.images?e.images.map(t=>typeof t=="string"?t:t.image_url):[]})}mapToDb(e){let s=e,{device_brand:t,device_type:r,images:i}=s,n=M(s,["device_brand","device_type","images"]),o=v({},n);if(t||r){let c=o.device_model||"";t&&t.toLowerCase()!=="generic"&&(c=`${t} ${c}`),r&&r!=="smartphone"&&(c=`${c} (${r})`),o.device_model=c.trim()}return o}static \u0275fac=(()=>{let e;return function(r){return(e||(e=$(a)))(r||a)}})();static \u0275prov=y({token:a,factory:a.\u0275fac,providedIn:"root"})};var ne=class a{supabase=l(U);getDashboardStats(){return m(this.supabase.rpc("get_dashboard_stats")).pipe(f(({data:e,error:t})=>{if(t)throw t;return{users:e?.users||0,products:e?.products||0,sales:e?.sales||0,revenue:e?.revenue||0,repairs_month:e?.repairs_month||0,repairs_revenue:e?.repairs_revenue||0,devices_fixed:e?.devices_fixed||0,sales_chart:e?.sales_chart||[],products_chart:e?.products_chart||[],category_chart:e?.category_chart||[]}}))}static \u0275fac=function(t){return new(t||a)};static \u0275prov=y({token:a,factory:a.\u0275fac,providedIn:"root"})};var oe=class{};var se=class a extends L{tableName="profiles";constructor(){let e=l(U),t=l(C);super(e,t)}getProfile(e){return this.getById(e)}updateProfile(e,t){return this.update(e,t)}static \u0275fac=function(t){return new(t||a)};static \u0275prov=y({token:a,factory:a.\u0275fac,providedIn:"root"})};var Tt={providers:[{provide:Pe,useClass:ee},{provide:U,useFactory:a=>a.getClient(),deps:[ct]},Ee(),Ve(),Ze(Je()),Xe(kt,et({anchorScrolling:"enabled",scrollPositionRestoration:"enabled"})),Qe(Ye()),{provide:K,useClass:te},{provide:St,useClass:re},{provide:vt,useClass:ie},{provide:X,useClass:ae},{provide:Ct,useClass:ne},{provide:oe,useClass:se}]};var le=class a{platformId=l(V);engine=null;isLoadingModel=D(!1);isGenerating=D(!1);loadingProgress=D("");modelLoaded=D(!1);messages=D([]);visibleMessages=He(()=>this.messages().filter(e=>e.role!=="system"));selectedModel="Phi-3-mini-4k-instruct-q4f16_1-MLC";constructor(){}async initModel(){if(!J(this.platformId)){console.warn("AI Model cannot be initialized on server");return}if(!this.modelLoaded()){this.isLoadingModel.set(!0);try{if(!navigator.gpu)throw new Error("WebGPU not supported in this browser");let{CreateMLCEngine:e}=await import("./chunk-HDZ74XN4.js"),t=r=>{this.loadingProgress.set(r.text)};this.engine=await e(this.selectedModel,{initProgressCallback:t}),this.modelLoaded.set(!0),this.isLoadingModel.set(!1),this.initializeSystemPrompt()}catch(e){console.error("Failed to load model",e),this.isLoadingModel.set(!1),e instanceof Error&&e.message.includes("WebGPU")?this.loadingProgress.set("WebGPU no disponible. Usa Chrome/Edge para acceder a la IA."):this.loadingProgress.set("Error loading model: "+e)}}}initializeSystemPrompt(){this.messages.set([{role:"system",content:`You are Arecofix AI Assistant. You help users with IT support, phone repairs, and website quotes.
        
        You have access to the following tools (simulated MCP):
        - get_repair_status(trackingId): Check repair status.
        - list_services(): Show available services.
        - book_appointment(serviceType, date): Schedule a repair.
        
        When a user asks something that requires a tool, reply with a JSON object strictly in this format:
        {"tool": "tool_name", "args": { ... }}
        
        Answer normally if no tool is needed. Keep responses concise and helpful.`}])}async sendMessage(e){if(!this.engine&&(await this.initModel(),!this.engine)){this.messages.update(r=>[...r,{role:"assistant",content:"Error cr\xEDtico: El modelo IA no pudo cargarse. Verifica que tu navegador soporte WebGPU."}]);return}this.isGenerating.set(!0);let t={role:"user",content:e};this.messages.update(r=>this.limitHistory([...r,t]));try{let i=(await this.generateResponse()).choices[0].message.content||"";this.handleResponse(i)}catch(r){console.error("Chat error",r);let i=r instanceof Error?r.message:String(r);this.messages.update(n=>[...n,{role:"assistant",content:`Lo siento, hubo un error t\xE9cnico: ${i}. Por favor intenta de nuevo.`}])}finally{this.isGenerating.set(!1)}}async generateResponse(){let e=this.messages().map(t=>({role:t.role,content:t.content}));return await this.engine.chat.completions.create({messages:e})}async handleResponse(e){let t=this.extractJson(e);if(t&&t.tool)try{await this.handleToolCall(t)}catch(r){console.error("Tool execution error",r),this.messages.update(i=>[...i,{role:"assistant",content:e}])}else this.messages.update(r=>[...r,{role:"assistant",content:e}])}extractJson(e){let t=e.replace(/```json\s*|```/g,"").trim(),r=t.indexOf("{");if(r===-1)return null;let i=t.substring(r);try{return JSON.parse(i)}catch{let o=0,s=-1;for(let c=0;c<i.length;c++)if(i[c]==="{")o++;else if(i[c]==="}"&&(o--,o===0)){s=c;break}if(s!==-1)try{return JSON.parse(i.substring(0,s+1))}catch{}}return null}async handleToolCall(e){console.log("Executing Tool:",e);let t="";switch(e.tool){case"list_services":t="Available Services: iPhone Screen Repair, Android Battery Replacement, PC Optimization, Custom Web Development, SEO Consulting.";break;case"get_repair_status":t=`Repair ${e.args?.trackingId||"Unknown"} is currently In Progress (Phase 2: Component Testing). ETA: 24hrs.`;break;case"book_appointment":t=`Appointment request received for ${e.args?.serviceType} on ${e.args?.date}. Please confirm via WhatsApp.`;break;default:t="Tool not found or not supported."}this.messages.update(n=>[...n,{role:"assistant",content:`Checking... (Tool: ${e.tool})`},{role:"user",content:`[Tool Output]: ${t}`}]);let i=(await this.generateResponse()).choices[0].message.content||"";this.messages.update(n=>[...n,{role:"assistant",content:i}])}limitHistory(e){if(e.length<=20)return e;let r=e[0],i=e.slice(e.length-19);return[r,...i]}static \u0275fac=function(t){return new(t||a)};static \u0275prov=y({token:a,factory:a.\u0275fac,providedIn:"root"})};var Ft=["scrollContainer"],Nt=a=>({"flex-row-reverse":a});function qt(a,e){a&1&&h(0,"div",2)}function Lt(a,e){a&1&&h(0,"i",3)}function jt(a,e){a&1&&h(0,"i",4)}function Ut(a,e){a&1&&(p(0,"span",10),b(1,"Iniciando Motor..."),u())}function Bt(a,e){if(a&1&&(p(0,"div",14)(1,"p",27),b(2),u(),p(3,"div",28),h(4,"div",29),u(),p(5,"p",30),b(6,"Descargando modelo IA (solo la primera vez)..."),u()()),a&2){let t=S(2);g(2),G(t.aiService.loadingProgress())}}function $t(a,e){if(a&1&&(p(0,"div",20)(1,"div",31),h(2,"i",32),u(),p(3,"div",33),b(4),u()()),a&2){let t=e.$implicit;P("ngClass",$e(6,Nt,t.role==="user")),g(),P("ngClass",t.role==="user"?"bg-gray-700":"bg-linear-to-br from-blue-500 to-purple-600"),g(),qe(t.role==="user"?"fas fa-user":"fas fa-robot"),g(),P("ngClass",t.role==="user"?"bg-blue-600 text-white rounded-tr-sm":"bg-white/10 text-gray-200 rounded-tl-sm"),g(),Le(" ",t.content," ")}}function Vt(a,e){a&1&&(p(0,"div",16)(1,"div",17),h(2,"i",18),u(),p(3,"div",34),h(4,"span",35)(5,"span",36)(6,"span",37),u()())}function Ht(a,e){if(a&1){let t=B();p(0,"div",21)(1,"button",38),R("click",function(){I(t);let i=S(2);return i.userInput.set("Estado de mi reparaci\xF3n"),O(i.sendMessage())}),b(2," \u{1F527} Estado Reparaci\xF3n "),u(),p(3,"button",39),R("click",function(){I(t);let i=S(2);return i.userInput.set("Quiero un presupuesto web"),O(i.sendMessage())}),b(4," \u{1F4BB} Presupuesto Web "),u(),p(5,"button",40),R("click",function(){I(t);let i=S(2);return i.userInput.set("Cambio de pantalla iPhone"),O(i.sendMessage())}),b(6," \u{1F4F1} Reparar Celular "),u()()}}function Wt(a,e){if(a&1){let t=B();p(0,"div",5)(1,"div",6)(2,"div",7),h(3,"div",8),p(4,"h3",9),b(5,"Arecofix AI "),x(6,Ut,2,0,"span",10),u()(),p(7,"div",7)(8,"div",11),b(9,"WebLLM / MCP"),u(),p(10,"button",12),R("click",function(){I(t);let i=S();return O(i.toggleChat())}),h(11,"i",13),u()()(),x(12,Bt,7,1,"div",14),p(13,"div",15,0)(15,"div",16)(16,"div",17),h(17,"i",18),u(),p(18,"div",19),b(19," Hola! Soy tu asistente de Arecofix potenciado con IA local (WebLLM). Puedo ayudarte a consultar reparaciones, servicios o agendar citas. \xBFEn qu\xE9 te ayudo? "),u()(),H(20,$t,5,8,"div",20,Ie),x(22,Vt,7,0,"div",16),u(),x(23,Ht,7,0,"div",21),p(24,"div",22)(25,"form",23),R("submit",function(){I(t);let i=S();return O(i.sendMessage())}),p(26,"input",24),Be("ngModelChange",function(i){I(t);let n=S();return Ue(n.userInput,i)||(n.userInput=i),O(i)}),u(),p(27,"button",25),h(28,"i",26),u()()()()}if(a&2){let t=S();g(3),P("ngClass",t.aiService.modelLoaded()?"bg-green-500 animate-pulse":"bg-yellow-500"),g(3),w(t.aiService.isLoadingModel()?6:-1),g(6),w(t.aiService.isLoadingModel()?12:-1),g(8),W(t.aiService.visibleMessages()),g(2),w(t.aiService.isGenerating()?22:-1),g(),w(t.aiService.messages().length<2?23:-1),g(3),P("disabled",t.aiService.isLoadingModel()||t.aiService.isGenerating()),je("ngModel",t.userInput),g(),P("disabled",!t.userInput()||t.aiService.isLoadingModel())}}var ce=class a{aiService=l(le);isOpen=D(!1);userInput=D("");scrollContainer;toggleChat(){this.isOpen.update(e=>!e),this.isOpen()&&!this.aiService.modelLoaded()&&this.aiService.initModel()}sendMessage(){let e=this.userInput().trim();e&&(this.aiService.sendMessage(e),this.userInput.set(""))}ngAfterViewChecked(){this.scrollToBottom()}scrollToBottom(){try{typeof window<"u"&&this.scrollContainer&&this.scrollContainer.nativeElement&&(this.scrollContainer.nativeElement.scrollTop=this.scrollContainer.nativeElement.scrollHeight)}catch{}}static \u0275fac=function(t){return new(t||a)};static \u0275cmp=F({type:a,selectors:[["app-ai-assistant"]],viewQuery:function(t,r){if(t&1&&Re(Ft,5),t&2){let i;Fe(i=Ne())&&(r.scrollContainer=i.first)}},decls:5,vars:5,consts:[["scrollContainer",""],["aria-haspopup","dialog",1,"fixed","bottom-6","left-6","z-9999","w-14","h-14","md:w-16","md:h-16","rounded-full","bg-linear-to-r","from-blue-600","to-purple-600","text-white","shadow-lg","shadow-purple-500/30","flex","items-center","justify-center","hover:scale-110","transition-transform","active:scale-95","group",3,"click"],[1,"absolute","inset-0","rounded-full","border","border-white/20","animate-ping","opacity-20"],[1,"fas","fa-microchip","text-2xl","group-hover:rotate-12","transition-transform"],[1,"fas","fa-times","text-xl"],[1,"fixed","bottom-0","right-0","md:bottom-24","md:right-6","w-full","md:w-[400px]","h-dvh","md:h-[600px]","md:max-h-[80vh]","z-9999","md:rounded-2xl","glass-panel","border-t","md:border","border-white/10","shadow-2xl","flex","flex-col","overflow-hidden","animate-slide-up","bg-surface-dark/95","backdrop-blur-xl"],[1,"p-4","border-b","border-white/10","flex","items-center","justify-between","bg-white/5","shrink-0"],[1,"flex","items-center","gap-3"],[1,"w-2","h-2","rounded-full",3,"ngClass"],[1,"font-bold","text-white","text-sm"],[1,"text-xs","font-normal","text-gray-400","block"],[1,"text-[10px]","text-gray-500","font-mono","hidden","sm:block"],[1,"md:hidden","w-8","h-8","flex","items-center","justify-center","bg-white/10","rounded-full","text-white",3,"click"],[1,"fas","fa-times"],[1,"p-4","bg-blue-900/20","text-center","shrink-0"],[1,"grow","overflow-y-auto","p-4","space-y-4","scrollbar-thin","scrollbar-thumb-gray-700","scrollbar-track-transparent"],[1,"flex","gap-3"],[1,"w-8","h-8","rounded-full","bg-linear-to-br","from-blue-500","to-purple-600","flex","items-center","justify-center","shrink-0"],[1,"fas","fa-robot","text-xs","text-white"],[1,"bg-white/10","p-3","rounded-2xl","rounded-tl-sm","text-sm","text-gray-200","shadow-md"],[1,"flex","gap-3",3,"ngClass"],[1,"px-4","py-2","flex","gap-2","overflow-x-auto","no-scrollbar","shrink-0"],[1,"p-3","bg-white/5","border-t","border-white/10","shrink-0","pb-6","md:pb-3"],[1,"relative",3,"submit"],["type","text","name","userInput","placeholder","Escribe tu mensaje...",1,"w-full","bg-black/30","border","border-white/10","rounded-xl","py-3","pl-4","pr-12","text-white","placeholder-gray-500","focus:outline-hidden","focus:border-blue-500/50","transition-colors","disabled:opacity-50","text-sm",3,"ngModelChange","disabled","ngModel"],["type","submit",1,"absolute","right-2","top-1/2","-translate-y-1/2","w-8","h-8","bg-blue-600","hover:bg-blue-500","rounded-lg","flex","items-center","justify-center","text-white","transition-colors","disabled:opacity-50","disabled:cursor-not-allowed",3,"disabled"],[1,"fas","fa-paper-plane","text-xs"],[1,"text-xs","text-blue-300","mb-2"],[1,"w-full","h-1","bg-gray-700","rounded-full","overflow-hidden"],[1,"h-full","bg-blue-500","animate-pulse-width"],[1,"text-[10px]","text-gray-400","mt-2"],[1,"w-8","h-8","rounded-full","flex","items-center","justify-center","shrink-0",3,"ngClass"],[1,"text-xs","text-white"],[1,"p-3","rounded-2xl","text-sm","max-w-[80%]","shadow-md","whitespace-pre-wrap",3,"ngClass"],[1,"bg-white/5","p-3","rounded-2xl","rounded-tl-sm","flex","gap-1","items-center","h-10"],[1,"w-2","h-2","bg-gray-400","rounded-full","animate-bounce"],[1,"w-2","h-2","bg-gray-400","rounded-full","animate-bounce","delay-100"],[1,"w-2","h-2","bg-gray-400","rounded-full","animate-bounce","delay-200"],[1,"whitespace-nowrap","px-3","py-1","rounded-full","bg-white/5","border","border-white/10","text-xs","text-blue-300","hover:bg-white/10","transition-colors",3,"click"],[1,"whitespace-nowrap","px-3","py-1","rounded-full","bg-white/5","border","border-white/10","text-xs","text-purple-300","hover:bg-white/10","transition-colors",3,"click"],[1,"whitespace-nowrap","px-3","py-1","rounded-full","bg-white/5","border","border-white/10","text-xs","text-green-300","hover:bg-white/10","transition-colors",3,"click"]],template:function(t,r){t&1&&(p(0,"button",1),R("click",function(){return r.toggleChat()}),x(1,qt,1,0,"div",2),x(2,Lt,1,0,"i",3),x(3,jt,1,0,"i",4),u(),x(4,Wt,29,8,"div",5)),t&2&&(Me("aria-label",r.isOpen()?"Cerrar asistente de IA":"Abrir asistente de IA"),g(),w(r.isOpen()?-1:1),g(),w(r.isOpen()?-1:2),g(),w(r.isOpen()?3:-1),g(),w(r.isOpen()?4:-1))},dependencies:[Y,Q,st,ot,tt,rt,it,nt,at],styles:["@keyframes _ngcontent-%COMP%_slide-up{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.animate-slide-up[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_slide-up .3s ease-out forwards}@keyframes _ngcontent-%COMP%_pulse-width{0%{width:0%}50%{width:60%}to{width:100%}}.animate-pulse-width[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_pulse-width 2s infinite ease-in-out}.glass-panel[_ngcontent-%COMP%]{background:#ffffff0d;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}.scrollbar-thin[_ngcontent-%COMP%]::-webkit-scrollbar{width:6px}.scrollbar-thin[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:transparent}.scrollbar-thin[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background-color:#9ca3af80;border-radius:20px}"]})};var de=class a{phoneNumber=Z.contact.whatsappNumber;defaultMessage="Hola, necesito informaci\xF3n";get encodedMessage(){return encodeURIComponent(this.defaultMessage)}static \u0275fac=function(t){return new(t||a)};static \u0275cmp=F({type:a,selectors:[["app-whatsapp-button"]],inputs:{phoneNumber:"phoneNumber",defaultMessage:"defaultMessage"},decls:6,vars:1,consts:[[1,"whatsapp-btn-container"],["target","_blank","rel","noopener noreferrer","aria-label","Contactar por WhatsApp",1,"whatsapp-btn",3,"href"],["xmlns","http://www.w3.org/2000/svg","viewBox","0 0 24 24"],["d","M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"],[1,"tooltip"]],template:function(t,r){t&1&&(z(0,"div",0)(1,"a",1),Se(),z(2,"svg",2),Oe(3,"path",3),he()(),ke(),z(4,"span",4),b(5,"\xA1Escr\xEDbenos!"),he()()),t&2&&(g(),De("href","https://wa.me/"+r.phoneNumber+"?text="+r.encodedMessage,Ae))},styles:['.whatsapp-btn-container[_ngcontent-%COMP%]{position:fixed;bottom:25px;right:25px;z-index:99999;backface-visibility:hidden;transform:translateZ(0);font-family:sans-serif}.whatsapp-btn[_ngcontent-%COMP%]{width:60px;height:60px;background-color:#25d366;border-radius:50%;display:flex;align-items:center;justify-content:center;text-decoration:none;position:relative;transition:all .3s ease;box-shadow:0 4px 14px #00000026;z-index:2}.whatsapp-btn[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:35px;height:35px;fill:#fff;position:relative;z-index:3}.whatsapp-btn[_ngcontent-%COMP%]:hover{background-color:#128c7e;transform:scale(1.05);box-shadow:0 8px 25px #128c7e80}.tooltip[_ngcontent-%COMP%]{visibility:hidden;opacity:0;width:160px;background-color:#075e54;color:#fff;text-align:center;border-radius:8px;padding:8px 10px;position:absolute;bottom:100%;right:0;margin-bottom:15px;font-size:14px;line-height:1.4;box-shadow:0 4px 12px #00000026;transform:translateY(10px);transition:all .3s ease;pointer-events:none}.tooltip[_ngcontent-%COMP%]:after{content:"";position:absolute;top:100%;right:25px;border-width:8px;border-style:solid;border-color:#075e54 transparent transparent transparent}.whatsapp-btn-container[_ngcontent-%COMP%]:hover   .tooltip[_ngcontent-%COMP%]{visibility:visible;opacity:1;transform:translateY(0)}']})};var zt=(a,e,t)=>({"border-l-green-500":a,"border-l-red-500":e,"border-l-blue-500":t}),Gt=(a,e,t)=>({"text-green-700 dark:text-green-400":a,"text-red-700 dark:text-red-400":e,"text-blue-700 dark:text-blue-400":t}),Qt=(a,e)=>e.id;function Yt(a,e){a&1&&(p(0,"div",5),h(1,"i",13),u())}function Jt(a,e){a&1&&(p(0,"div",6),h(1,"i",14),u())}function Zt(a,e){a&1&&(p(0,"div",7),h(1,"i",15),u())}function Kt(a,e){a&1&&b(0," Producto Agregado ")}function Xt(a,e){a&1&&b(0," Error ")}function er(a,e){a&1&&b(0," Aviso ")}function tr(a,e){if(a&1){let t=B();p(0,"div",2),R("click",function(){let i=I(t).$implicit,n=S();return O(n.onToastClick(i))}),p(1,"div",3)(2,"div",4),x(3,Yt,2,0,"div",5)(4,Jt,2,0,"div",6)(5,Zt,2,0,"div",7),u(),p(6,"div",8)(7,"span",9),x(8,Kt,1,0)(9,Xt,1,0)(10,er,1,0),u(),p(11,"span",10),b(12),u()(),p(13,"button",11),h(14,"i",12),u()()()}if(a&2){let t=e.$implicit;g(),P("ngClass",be(5,zt,t.type==="success",t.type==="error",t.type==="info")),g(2),w(t.type==="success"?3:t.type==="error"?4:5),g(4),P("ngClass",be(9,Gt,t.type==="success",t.type==="error",t.type==="info")),g(),w(t.type==="success"?8:t.type==="error"?9:10),g(4),G(t.message)}}var pe=class a{toastService=l(ht);onToastClick(e){e.action&&e.action(),this.toastService.remove(e.id)}static \u0275fac=function(t){return new(t||a)};static \u0275cmp=F({type:a,selectors:[["app-toast"]],decls:3,vars:0,consts:[[1,"fixed","top-20","right-2","z-9999","flex","flex-col","gap-2","pointer-events-none","max-w-[85vw]","sm:max-w-sm","w-auto","items-end"],[1,"pointer-events-auto","transform","transition-all","duration-300","animate-slide-in-down","cursor-pointer"],[1,"pointer-events-auto","transform","transition-all","duration-300","animate-slide-in-down","cursor-pointer",3,"click"],[1,"flex","items-center","gap-2","px-3","py-2","rounded-lg","shadow-lg","border-l-4","overflow-hidden","bg-white","dark:bg-gray-900","border-gray-200","dark:border-gray-700","ring-1","ring-black/5",3,"ngClass"],[1,"shrink-0"],[1,"w-8","h-8","rounded-full","bg-green-100","dark:bg-green-900/30","flex","items-center","justify-center","text-green-600","dark:text-green-400"],[1,"w-8","h-8","rounded-full","bg-red-100","dark:bg-red-900/30","flex","items-center","justify-center","text-red-600","dark:text-red-400"],[1,"w-8","h-8","rounded-full","bg-blue-100","dark:bg-blue-900/30","flex","items-center","justify-center","text-blue-600","dark:text-blue-400"],[1,"flex","flex-col","flex-1","min-w-0"],[1,"font-bold","text-xs","uppercase","tracking-wider",3,"ngClass"],[1,"text-sm","font-medium","text-gray-800","dark:text-gray-100","leading-tight"],[1,"shrink-0","text-gray-400","hover:text-gray-600","dark:hover:text-gray-200","transition-colors"],[1,"fas","fa-times","text-sm"],[1,"fas","fa-check","text-sm"],[1,"fas","fa-exclamation","text-sm"],[1,"fas","fa-info","text-sm"]],template:function(t,r){t&1&&(p(0,"div",0),H(1,tr,15,13,"div",1,Qt),u()),t&2&&(g(),W(r.toastService.toasts()))},dependencies:[Y,Q],styles:["@keyframes _ngcontent-%COMP%_slideInDown{0%{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}.animate-slide-in-down[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_slideInDown .3s cubic-bezier(.175,.885,.32,1.275) forwards}"]})};var ue=class a{analytics=l(lt);logger=l(C);seoService=l(yt);themeService=l(bt);tenantService=l(N);platformId=l(V);document=l(Te);ngOnInit(){if(this.seoService.initialize(),J(this.platformId)){let e=this.document.location.hostname;if(this.tenantService.resolveTenantByHostname(e).then(t=>{t||this.logger.warn("No SaaS Tenant context found for this domain!")}),e==="celulares.arecofix.com.ar"){this.document.location.href="https://arecofix.com.ar/celular";return}}}static \u0275fac=function(t){return new(t||a)};static \u0275cmp=F({type:a,selectors:[["app-root"]],decls:4,vars:0,template:function(t,r){t&1&&h(0,"router-outlet")(1,"app-whatsapp-button")(2,"app-toast")(3,"app-ai-assistant")},dependencies:[Ke,de,pe,ce],encapsulation:2})};Z.production&&void 0;var rr={providers:[wt(xt())]};ze(ue,We(Tt,rr)).catch(a=>console.error(a));
