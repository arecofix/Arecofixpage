import{a as oe}from"./chunk-U7GCOFF5.js";import{l as ie}from"./chunk-ECZXGVFH.js";import{a as re}from"./chunk-MQUL3GSM.js";import{b as U,d as z,e as G,f as H,g as Q,h as J,i as K,m as X,n as Y,o as Z,p as ee,q as te,t as ne}from"./chunk-63CMMPDH.js";import"./chunk-P2JKZEUE.js";import"./chunk-XIH5YEDL.js";import"./chunk-M7RWEG4P.js";import{l as $,n as R,o as j}from"./chunk-YNFFGNY6.js";import"./chunk-Q44XB7TV.js";import{$ as u,$b as b,Ab as i,Bb as r,Cb as v,Ec as B,Gb as k,Kb as h,Mb as w,R as W,Rb as q,Ua as l,Vb as s,W as x,Wb as A,Xb as C,Yb as D,Zb as p,_b as g,aa as c,gb as I,ma as T,sb as N,tb as M,ub as E,vb as L,xb as P,yb as F,zb as _}from"./chunk-DX2LKEMG.js";import{a as f,b as y}from"./chunk-C6Q5SG76.js";var O=class m{statusTranslations={pending:"Pendiente",processing:"Procesando env\xEDo/retiro",completed:"Completado",cancelled:"Cancelado"};getStatusLabel(t){return this.statusTranslations[t]||t}generateWhatsAppLink(t,n,e,a,d){if(!t)return null;let o=t.replace(/\D/g,"");o.length===10&&(o="549"+o),o.startsWith("0")&&(o=o.substring(1),o.length===10&&(o="549"+o));let S="";if(e==="completed")S=`Hola ${n}, te contactamos de Arecofix. Tu pedido #${a} por [${d}] ya ha llegado y est\xE1 listo. \xA1Muchas gracias por tu compra!`;else{let de=this.getStatusLabel(e);S=`Hola ${n}, te contactamos de Arecofix. 

El estado de tu compra (Pedido #${a}) se ha actualizado a: *${de}*. 

Cualquier consulta estamos a tu disposici\xF3n.`}let V=encodeURIComponent(S);return`https://wa.me/${o}?text=${V}`}static \u0275fac=function(n){return new(n||m)};static \u0275prov=W({token:m,factory:m.\u0275fac,providedIn:"root"})};var se=(m,t)=>t.id;function me(m,t){if(m&1&&(i(0,"option",10),s(1),r()),m&2){let n=t.$implicit;_("value",n.displayName),l(),A(n.email)}}function ue(m,t){m&1&&(i(0,"div",28),v(1,"i",53),i(2,"p"),s(3,"No hay productos agregados"),r()())}function ce(m,t){if(m&1&&(i(0,"option",10),s(1),r()),m&2){let n=t.$implicit;_("value",n.name),l(),D("",n.sku," - $",n.price)}}function pe(m,t){if(m&1){let n=k();i(0,"tr",60)(1,"td",61)(2,"input",62),h("ngModelChange",function(a){let d=u(n).$index,o=w(2);return c(o.onSearchProduct(d,a))}),r(),i(3,"datalist",63),P(4,ce,2,3,"option",10,se),r()(),i(6,"td")(7,"input",64),b("ngModelChange",function(a){let d=u(n).$implicit;return g(d.quantity,a)||(d.quantity=a),c(a)}),h("ngModelChange",function(){let a=u(n).$index,d=w(2);return c(d.onQuantityChange(a))}),r()(),i(8,"td",65)(9,"input",66),b("ngModelChange",function(a){let d=u(n).$implicit;return g(d.unit_price,a)||(d.unit_price=a),c(a)}),h("ngModelChange",function(){let a=u(n).$index,d=w(2);return c(d.onUnitPriceChange(a))}),r()(),i(10,"td",67),s(11),r(),i(12,"td",68)(13,"button",69),h("click",function(){let a=u(n).$index,d=w(2);return c(d.removeItem(a))}),v(14,"i",70),r()()()}if(m&2){let n=t.$implicit,e=t.$index,a=w(2);l(2),_("ngModel",n.product_name)("name","product_"+e),N("list","products-list-"+e),l(),_("id","products-list-"+e),l(),F(a.products),l(3),p("ngModel",n.quantity),_("name","quantity_"+e),l(2),p("ngModel",n.unit_price),_("name","price_"+e),l(2),C("$",n.subtotal.toFixed(2)," ")}}function ge(m,t){if(m&1&&(i(0,"div",29)(1,"table",54)(2,"thead")(3,"tr",55)(4,"th",56),s(5,"Producto"),r(),i(6,"th",57),s(7,"Cantidad"),r(),i(8,"th",58),s(9,"Precio Unit."),r(),i(10,"th",58),s(11,"Subtotal"),r(),v(12,"th",59),r()(),i(13,"tbody"),P(14,pe,15,9,"tr",60,L),r()()()),m&2){let n=w();l(14),F(n.items())}}function be(m,t){if(m&1&&(i(0,"div",48),v(1,"i",71),i(2,"span"),s(3),r()()),m&2){let n=w();l(3),A(n.error)}}function _e(m,t){m&1&&v(0,"span",52)}var ae=class m{route=x($);router=x(R);orderService=x(oe);authService=x(ie);orderNotificationService=x(O);productRepository=x(re);cdr=x(B);id=null;loading=!0;saving=!1;error=null;originalStatus=null;products=[];clients=[];form=T({customer_name:"",customer_email:"",customer_phone:"",shipping_address:{street:"",number:"",city:"Marcos Paz",neighborhood:""},status:"pending",subtotal:0,tax:0,discount:0,total:0,payment_method:"efectivo",notes:""});items=T([]);async ngOnInit(){this.id=this.route.snapshot.paramMap.get("id"),await Promise.all([this.loadProducts(),this.loadClients(),this.id?this.loadOrder():Promise.resolve()]),this.loading=!1,this.cdr.markForCheck()}async loadClients(){try{let{data:t,error:n}=await this.authService.getSupabaseClient().from("profiles").select("id, full_name, first_name, last_name, email, phone, address").eq("role","user").limit(50);t&&(this.clients=t.map(e=>y(f({},e),{displayName:e.full_name||`${e.first_name||""} ${e.last_name||""}`.trim()||e.email})))}catch(t){console.error("Error loading clients",t)}}onSelectClient(t){let n=this.clients.find(e=>e.displayName===t);n?this.form.update(e=>y(f({},e),{user_id:n.id,customer_name:n.displayName,customer_email:n.email||e.customer_email,customer_phone:n.phone||e.customer_phone,shipping_address:typeof n.address=="string"?y(f({},e.shipping_address),{street:n.address}):n.address||e.shipping_address})):this.form.update(e=>y(f({},e),{customer_name:t}))}async loadProducts(){return new Promise(t=>{this.productRepository.findAvailable().subscribe({next:n=>{this.products=n.map(e=>({id:e.id,name:e.name,sku:e.sku||"",price:e.price,stock:e.stock||0})),t()},error:n=>{console.error("Error loading products",n),t()}})})}async loadOrder(){this.id&&this.orderService.getOrderById(this.id).subscribe({next:t=>{let n=t.shipping_address;typeof n=="string"&&(n={street:n,number:"",city:"Marcos Paz",neighborhood:""}),this.form.set({customer_name:t.customer_name,customer_email:t.customer_email,customer_phone:t.customer_phone,shipping_address:n||{street:"",number:"",city:"",neighborhood:""},status:t.status,subtotal:t.subtotal,tax:t.tax,discount:t.discount,total:t.total,payment_method:t.payment_method||"efectivo",notes:t.notes}),this.items.set(t.items),this.originalStatus=t.status,this.cdr.markForCheck()},error:t=>{this.error=t.message||"Error desconocido",this.cdr.markForCheck()}})}addItem(){this.items.update(t=>[...t,{product_name:"",quantity:1,unit_price:0,subtotal:0}]),this.cdr.markForCheck()}removeItem(t){this.items.update(n=>n.filter((e,a)=>a!==t)),this.calculateTotals()}onSearchProduct(t,n){let e=this.products.find(a=>a.name===n);this.items.update(a=>{let d=[...a];return e?d[t]=y(f({},d[t]),{product_id:e.id,product_name:e.name,product_sku:e.sku,unit_price:e.price,subtotal:e.price*d[t].quantity}):d[t]=y(f({},d[t]),{product_id:void 0,product_name:n,product_sku:void 0}),d}),this.calculateTotals()}onUnitPriceChange(t){this.items.update(n=>{let e=[...n];return e[t].subtotal=e[t].unit_price*e[t].quantity,e}),this.calculateTotals()}onQuantityChange(t){this.items.update(n=>{let e=[...n];return e[t].subtotal=e[t].unit_price*e[t].quantity,e}),this.calculateTotals()}calculateTotals(){let t=this.items().reduce((S,V)=>S+V.subtotal,0),n=this.form().discount||0,e=.21,a=t-n,d=a*e,o=a+d;this.form.update(S=>y(f({},S),{subtotal:t,tax:d,total:o})),this.cdr.markForCheck()}updateStatus(t){this.form.update(n=>y(f({},n),{status:t})),this.cdr.markForCheck()}async save(){if(this.items().length===0){this.error="Debes agregar al menos un producto",this.cdr.markForCheck();return}this.saving=!0,this.error=null;try{let t;this.id?t=await this.orderService.updateOrder(this.id,this.form(),this.items()):t=await this.orderService.createOrder(this.form(),this.items());let{error:n}=t;if(n)throw n;if(this.id&&this.originalStatus&&this.form().status!==this.originalStatus){let e=this.form(),a=this.items().map(o=>`${o.quantity}x ${o.product_name}`).join(", "),d=this.orderNotificationService.generateWhatsAppLink(e.customer_phone||"",e.customer_name,e.status,t.data?.order_number||this.id.substring(0,8).toUpperCase(),a);d&&window.open(d,"_blank")}this.router.navigate(["/admin/orders"])}catch(t){this.error=t.message||"Error al guardar pedido",this.saving=!1,this.cdr.markForCheck()}}static \u0275fac=function(n){return new(n||m)};static \u0275cmp=I({type:m,selectors:[["app-admin-order-form-page"]],decls:117,vars:20,consts:[["f","ngForm"],[1,"max-w-4xl","mx-auto","text-base-content"],[1,"text-2xl","font-bold","mb-6","text-green-600"],[3,"ngSubmit"],[1,"bg-base-100","p-6","rounded-xl","shadow-sm","border","border-base-200","mb-6","text-base-content"],[1,"text-lg","font-semibold","mb-4","text-base-content","border-b","border-base-200","pb-2"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-6"],[1,"block","text-sm","font-medium","text-base-content","mb-1.5"],["type","text","name","customer_name","list","clients-list","placeholder","Buscar cliente...","required","",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["id","clients-list"],[3,"value"],["type","email","name","customer_email","required","",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["type","tel","name","customer_phone",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],[1,"md:col-span-2","grid","grid-cols-1","md:grid-cols-4","gap-4"],[1,"md:col-span-2"],["type","text","name","address_street",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["type","text","name","address_number",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["type","text","name","address_city",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["name","status",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["value","pending"],["value","paid"],["value","shipped"],["value","completed"],["value","cancelled"],[1,"flex","justify-between","items-center","mb-4","border-b","border-base-200","pb-2"],[1,"text-lg","font-semibold","text-base-content"],["type","button",1,"btn","btn-sm","btn-primary",3,"click"],[1,"fas","fa-plus","mr-2"],[1,"text-center","py-8","text-gray-500","bg-gray-50","rounded-lg","border","border-dashed","border-gray-300"],[1,"overflow-x-auto"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-8"],[1,"space-y-4"],["name","payment_method",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["value","efectivo"],["value","transferencia"],["value","tarjeta"],["value","mercadopago"],["value","otro"],["type","number","name","discount","min","0","step","0.01",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],["name","notes","rows","3",1,"w-full","bg-base-100","text-base-content","border","border-base-300","rounded-lg","px-4","py-2","focus:outline-none","focus:ring-2","transition-all","duration-200","ease-in-out","shadow-sm","hover:border-base-content/40",3,"ngModelChange","ngModel"],[1,"bg-base-200","p-6","rounded-xl","border","border-base-300","h-fit"],[1,"space-y-3"],[1,"flex","justify-between","text-base-content/80"],[1,"font-mono","font-medium"],[1,"font-mono","font-medium","text-error"],[1,"divider","my-2"],[1,"flex","justify-between","text-xl","font-bold","text-base-content"],[1,"font-mono","text-primary"],[1,"alert","alert-error","mb-6"],[1,"flex","gap-4","justify-end","mb-8"],["routerLink","/admin/orders",1,"btn","btn-error","text-white"],["type","submit",1,"btn","btn-primary","px-8",3,"disabled"],[1,"loading","loading-spinner","loading-xs","mr-2"],[1,"fas","fa-box-open","text-4xl","mb-2","text-gray-400"],[1,"table","w-full"],[1,"text-base-content","border-b-2","border-base-200"],[1,"font-semibold"],[1,"font-semibold","w-24"],[1,"font-semibold","text-right"],[1,"w-10"],[1,"border-b","border-base-200","hover:bg-base-200/50"],[1,"min-w-[200px]"],["type","text","placeholder","Buscar producto o escribir uno...","required","","autocomplete","off",1,"input","input-bordered","input-sm","w-full","bg-base-100","text-base-content","border-base-300",3,"ngModelChange","ngModel","name"],[3,"id"],["type","number","min","1",1,"input","input-bordered","input-sm","w-full","bg-base-100","text-base-content","border-base-300",3,"ngModelChange","ngModel","name"],[1,"font-mono","text-right","text-base-content/80"],["type","number","min","0","step","0.01",1,"input","input-bordered","input-sm","w-full","bg-base-100","text-base-content","border-base-300","text-right",3,"ngModelChange","ngModel","name"],[1,"font-mono","font-semibold","text-right","text-base-content"],[1,"text-right"],["type","button",1,"btn","btn-ghost","btn-sm","btn-circle","text-error","hover:bg-red-50",3,"click"],[1,"fas","fa-trash"],[1,"fas","fa-exclamation-circle"]],template:function(n,e){if(n&1){let a=k();i(0,"div",1)(1,"h2",2),s(2),r(),i(3,"form",3,0),h("ngSubmit",function(){return u(a),c(e.save())}),i(5,"div",4)(6,"h3",5),s(7,"Informaci\xF3n del Cliente"),r(),i(8,"div",6)(9,"div")(10,"label",7),s(11,"Nombre *"),r(),i(12,"input",8),h("ngModelChange",function(o){return u(a),c(e.onSelectClient(o))}),r(),i(13,"datalist",9),P(14,me,2,2,"option",10,se),r()(),i(16,"div")(17,"label",7),s(18,"Email *"),r(),i(19,"input",11),b("ngModelChange",function(o){return u(a),g(e.form().customer_email,o)||(e.form().customer_email=o),c(o)}),r()(),i(20,"div")(21,"label",7),s(22,"Tel\xE9fono"),r(),i(23,"input",12),b("ngModelChange",function(o){return u(a),g(e.form().customer_phone,o)||(e.form().customer_phone=o),c(o)}),r()(),i(24,"div",13)(25,"div",14)(26,"label",7),s(27,"Calle"),r(),i(28,"input",15),b("ngModelChange",function(o){return u(a),g(e.form().shipping_address.street,o)||(e.form().shipping_address.street=o),c(o)}),r()(),i(29,"div")(30,"label",7),s(31,"Nro"),r(),i(32,"input",16),b("ngModelChange",function(o){return u(a),g(e.form().shipping_address.number,o)||(e.form().shipping_address.number=o),c(o)}),r()(),i(33,"div")(34,"label",7),s(35,"Ciudad"),r(),i(36,"input",17),b("ngModelChange",function(o){return u(a),g(e.form().shipping_address.city,o)||(e.form().shipping_address.city=o),c(o)}),r()()(),i(37,"div",14)(38,"label",7),s(39,"Estado"),r(),i(40,"select",18),h("ngModelChange",function(o){return u(a),c(e.updateStatus(o))}),i(41,"option",19),s(42,"Pendiente"),r(),i(43,"option",20),s(44,"Pagado"),r(),i(45,"option",21),s(46,"Enviado"),r(),i(47,"option",22),s(48,"Completado"),r(),i(49,"option",23),s(50,"Cancelado"),r()()()()(),i(51,"div",4)(52,"div",24)(53,"h3",25),s(54,"Productos"),r(),i(55,"button",26),h("click",function(){return u(a),c(e.addItem())}),v(56,"i",27),s(57," Agregar Producto "),r()(),M(58,ue,4,0,"div",28)(59,ge,16,0,"div",29),r(),i(60,"div",4)(61,"h3",5),s(62,"Totales y Notas"),r(),i(63,"div",30)(64,"div",31)(65,"div")(66,"label",7),s(67,"M\xE9todo de Pago"),r(),i(68,"select",32),b("ngModelChange",function(o){return u(a),g(e.form().payment_method,o)||(e.form().payment_method=o),c(o)}),i(69,"option",33),s(70,"Efectivo"),r(),i(71,"option",34),s(72,"Transferencia"),r(),i(73,"option",35),s(74,"Tarjeta"),r(),i(75,"option",36),s(76,"Mercado Pago"),r(),i(77,"option",37),s(78,"Otro"),r()()(),i(79,"div")(80,"label",7),s(81,"Descuento"),r(),i(82,"input",38),b("ngModelChange",function(o){return u(a),g(e.form().discount,o)||(e.form().discount=o),c(o)}),h("ngModelChange",function(){return u(a),c(e.calculateTotals())}),r()(),i(83,"div")(84,"label",7),s(85,"Notas"),r(),i(86,"textarea",39),b("ngModelChange",function(o){return u(a),g(e.form().notes,o)||(e.form().notes=o),c(o)}),r()()(),i(87,"div",40)(88,"div",41)(89,"div",42)(90,"span"),s(91,"Subtotal:"),r(),i(92,"span",43),s(93),r()(),i(94,"div",42)(95,"span"),s(96,"Descuento:"),r(),i(97,"span",44),s(98),r()(),i(99,"div",42)(100,"span"),s(101,"IVA (21%):"),r(),i(102,"span",43),s(103),r()(),v(104,"div",45),i(105,"div",46)(106,"span"),s(107,"Total:"),r(),i(108,"span",47),s(109),r()()()()()(),M(110,be,4,1,"div",48),i(111,"div",49)(112,"a",50),s(113,"Cancelar"),r(),i(114,"button",51),M(115,_e,1,0,"span",52),s(116),r()()()()}if(n&2){let a=q(4);l(2),C("",e.id?"Editar":"Nuevo"," Pedido"),l(10),_("ngModel",e.form().customer_name),l(2),F(e.clients),l(5),p("ngModel",e.form().customer_email),l(4),p("ngModel",e.form().customer_phone),l(5),p("ngModel",e.form().shipping_address.street),l(4),p("ngModel",e.form().shipping_address.number),l(4),p("ngModel",e.form().shipping_address.city),l(4),_("ngModel",e.form().status),l(18),E(e.items().length===0?58:59),l(10),p("ngModel",e.form().payment_method),l(14),p("ngModel",e.form().discount),l(4),p("ngModel",e.form().notes),l(7),C("$",e.form().subtotal.toFixed(2)),l(5),C("-$",e.form().discount.toFixed(2)),l(5),C("$",e.form().tax.toFixed(2)),l(6),C("$",e.form().total.toFixed(2)),l(),E(e.error?110:-1),l(4),_("disabled",e.saving||a.invalid),l(),E(e.saving?115:-1),l(),C(" ",e.saving?"Guardando...":"Guardar Pedido"," ")}},dependencies:[ne,J,Y,Z,U,K,X,z,G,te,ee,Q,H,j],encapsulation:2,changeDetection:0})};export{ae as AdminOrderFormPage};
