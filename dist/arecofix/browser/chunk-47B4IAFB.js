import{a as O,k as E,l as I}from"./chunk-GBGIQ7VE.js";import{a as w}from"./chunk-IP3FEPB3.js";import{C as b,R as y,W as p,k as f,r as g}from"./chunk-DX2LKEMG.js";import{a as _,b as h}from"./chunk-C6Q5SG76.js";var D=class m{supabase=p(O);logger=p(w);auth=p(I);tenantService=p(E);useSoftDeletes=!0;applyTenantFilter(r){let t=r.eq("tenant_id",this.tenantService.getTenantId());return this.useSoftDeletes&&(t=t.is("deleted_at",null)),t}getOrders(){let r=this.supabase.from("orders").select("*, order_items(*)"),t=this.applyTenantFilter(r).order("created_at",{ascending:!1});return f(t).pipe(g(e=>{let{data:n,error:s}=e;if(s)throw s;return(n||[]).map(o=>this.mapDbOrderToDomain(o))}),b(e=>{throw this.handleError("Error fetching orders",e),e}))}getOrderById(r){return f(Promise.all([this.applyTenantFilter(this.supabase.from("orders").select("*").eq("id",r)).single(),this.supabase.from("order_items").select("*").eq("order_id",r).eq("tenant_id",this.tenantService.getTenantId())])).pipe(g(([t,e])=>{if(t.error)throw t.error;if(e.error)throw e.error;let n=t.data;return n.order_items=e.data,this.mapDbOrderToDomain(n)}),b(t=>{throw this.handleError("Error fetching order",t),t}))}async createOrder(r,t){try{let e=this.auth.getCurrentUser(),n;e&&(n=(await this.auth.getUserProfile(e.id))?.branch_id);let s=crypto.randomUUID(),o=`ORD-${Date.now().toString(36).toUpperCase()}`,i=this.tenantService.getTenantId(),l={id:s,customer_name:r.customer_name,customer_email:r.customer_email,customer_phone:r.customer_phone||null,shipping_address:r.shipping_address||null,status:r.status||"pending",subtotal:r.subtotal,tax:r.tax,discount:r.discount,total_amount:r.total||r.total_amount,notes:r.notes||null,order_number:o,user_id:r.user_id||null,branch_id:n||null,tenant_id:i},{error:c}=await this.supabase.from("orders").insert(l);if(c)throw c;let d=t.map(u=>({order_id:s,product_id:u.product_id||null,course_id:u.course_id||null,product_name:u.product_name,quantity:u.quantity,unit_price:u.unit_price,subtotal:u.subtotal,tenant_id:i})),{error:a}=await this.supabase.from("order_items").insert(d);if(a)throw a;return{data:h(_({},r),{id:s,order_number:o,created_at:new Date().toISOString(),tenant_id:i}),error:null}}catch(e){return this.handleError("Critical error creating order",e),{data:null,error:e}}}async updateOrderStatus(r,t){let e=this.supabase.from("orders").update({status:t,updated_at:new Date().toISOString()}).eq("id",r),{error:n,data:s}=await this.applyTenantFilter(e).select();return n&&this.handleError("Error updating order status",n),!n&&(!s||s.length===0)?{error:new Error("Supabase RLS Error: Permission denied or Record filtered out.")}:{error:n}}async deleteOrder(r){let t=this.supabase.from("orders").delete().eq("id",r),{error:e}=await this.applyTenantFilter(t);return e&&this.handleError("Error deleting order",e),{error:e}}async updateOrder(r,t,e){try{let n={customer_name:t.customer_name,customer_email:t.customer_email,customer_phone:t.customer_phone||null,shipping_address:t.shipping_address||null,status:t.status,subtotal:t.subtotal,tax:t.tax,discount:t.discount,total_amount:t.total||t.total_amount,notes:t.notes||null,updated_at:new Date().toISOString()},s=this.supabase.from("orders").update(n).eq("id",r),{error:o,data:i}=await this.applyTenantFilter(s).select();if(o)throw o;if(!i||i.length===0)throw new Error("Supabase RLS Error: Permission denied or Record filtered out.");await this.handleItemsUpdate(r,e);let l=this.supabase.from("orders").select("*, order_items(*)").eq("id",r),{data:c,error:d}=await this.applyTenantFilter(l).single();if(d)throw d;return{data:this.mapDbOrderToDomain(c),error:null}}catch(n){return this.handleError("Error updating order",n),{data:null,error:n}}}async handleItemsUpdate(r,t){let e=this.tenantService.getTenantId(),{data:n,error:s}=await this.supabase.from("order_items").select("id").eq("order_id",r).eq("tenant_id",e);if(s)throw s;let o=(n||[]).map(a=>a.id),i=t.filter(a=>a.id).map(a=>a.id),l=o.filter(a=>!i.includes(a));if(l.length>0){let{error:a}=await this.supabase.from("order_items").delete().in("id",l).eq("tenant_id",e);if(a)throw a}let c=t.map(a=>h(_({},a.id?{id:a.id}:{}),{order_id:r,product_name:a.product_name,quantity:a.quantity,unit_price:a.unit_price,subtotal:a.subtotal,product_id:a.product_id||null,course_id:a.course_id||null,tenant_id:e})),{error:d}=await this.supabase.from("order_items").upsert(c);if(d)throw d}mapDbOrderToDomain(r){return{id:r.id,created_at:r.created_at,updated_at:r.updated_at||void 0,order_number:r.order_number,customer_name:r.customer_name,customer_email:r.customer_email,customer_phone:r.customer_phone||void 0,shipping_address:r.shipping_address||r.customer_address||void 0,user_id:r.user_id||r.customer_id||void 0,status:r.status,subtotal:r.subtotal,tax:r.tax,discount:r.discount,total:r.total_amount,notes:r.notes||void 0,items:(r.order_items||[]).map(t=>({id:t.id,order_id:t.order_id,product_id:t.product_id||void 0,product_name:t.product_name,quantity:t.quantity,unit_price:t.unit_price,subtotal:t.subtotal,created_at:t.created_at}))}}handleError(r,t){this.logger.error(`${r}:`,t)}static \u0275fac=function(t){return new(t||m)};static \u0275prov=y({token:m,factory:m.\u0275fac,providedIn:"root"})};export{D as a};
