{
  "version": 3,
  "sources": ["src/app/core/services/order.service.ts"],
  "sourcesContent": ["import { Injectable, inject } from '@angular/core';\r\nimport { PostgrestError } from '@supabase/supabase-js';\r\nimport { LoggerService } from './logger.service';\r\nimport { Observable, from } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\nimport { Order, OrderItem, OrderWithItems } from '@app/shared/interfaces/order.interface';\r\nimport { DbOrder, DbOrderItem } from '@app/shared/interfaces/db-models';\r\nimport { SUPABASE_CLIENT } from '../di/supabase-token';\r\nimport { AuthService } from './auth.service';\r\nimport { TenantService } from './tenant.service';\r\n\r\n@Injectable({\r\n    providedIn: 'root'\r\n})\r\nexport class OrderService {\r\n    private supabase = inject(SUPABASE_CLIENT);\r\n    private logger = inject(LoggerService);\r\n    private auth = inject(AuthService);\r\n    private tenantService = inject(TenantService);\r\n\r\n    protected useSoftDeletes = true;\r\n\r\n    private applyTenantFilter(query: any) {\r\n        let enhancedQuery = query.eq('tenant_id', this.tenantService.getTenantId());\r\n        if (this.useSoftDeletes) {\r\n            enhancedQuery = enhancedQuery.is('deleted_at', null);\r\n        }\r\n        return enhancedQuery;\r\n    }\r\n\r\n    getOrders(): Observable<OrderWithItems[]> {\r\n        let query = this.supabase\r\n            .from('orders')\r\n            .select('id, order_number, customer_name, customer_email, customer_phone, shipping_address, status, subtotal, tax, discount, total_amount, notes, user_id, tenant_id, created_at, updated_at, deleted_at, payment_method, order_items(id, order_id, product_id, course_id, product_name, quantity, unit_price, subtotal, tenant_id, created_at)');\r\n            \r\n        let filteredQuery = this.applyTenantFilter(query)\r\n            .order('created_at', { ascending: false });\r\n\r\n        return from(filteredQuery as any).pipe(\r\n            map((res: any) => {\r\n                const { data, error } = res;\r\n                if (error) throw error;\r\n                return (data || []).map((o: any) => this.mapDbOrderToDomain(o));\r\n            }),\r\n            catchError((err: unknown) => {\r\n                this.handleError('Error fetching orders', err);\r\n                throw err;\r\n            })\r\n        );\r\n    }\r\n\r\n    getOrderById(id: string): Observable<OrderWithItems> {\r\n        return from(\r\n            Promise.all([\r\n                this.applyTenantFilter(this.supabase.from('orders').select('id, order_number, customer_name, customer_email, customer_phone, shipping_address, status, subtotal, tax, discount, total_amount, notes, user_id, tenant_id, created_at, updated_at, deleted_at, payment_method').eq('id', id)).single(),\r\n                this.supabase.from('order_items').select('id, order_id, product_id, course_id, product_name, quantity, unit_price, subtotal, tenant_id, created_at').eq('order_id', id).eq('tenant_id', this.tenantService.getTenantId())\r\n            ])\r\n        ).pipe(\r\n            map(([orderResult, itemsResult]) => {\r\n                if (orderResult.error) throw orderResult.error;\r\n                if (itemsResult.error) throw itemsResult.error;\r\n\r\n                const dbOrder = orderResult.data as DbOrder;\r\n                dbOrder.order_items = itemsResult.data as DbOrderItem[];\r\n\r\n                return this.mapDbOrderToDomain(dbOrder);\r\n            }),\r\n            catchError((err: unknown) => {\r\n                this.handleError('Error fetching order', err);\r\n                throw err;\r\n            })\r\n        );\r\n    }\r\n\r\n    async createOrder(order: Order, items: OrderItem[]): Promise<{ data: Order | null; error: Error | PostgrestError | null }> {\r\n        try {\r\n            const user = this.auth.getCurrentUser();\r\n            const orderId = crypto.randomUUID();\r\n            const orderNumber = `ORD-${Date.now().toString(36).toUpperCase()}`;\r\n            const tenantId = this.tenantService.getTenantId();\r\n\r\n            const insertPayload: any = {\r\n                id: orderId,\r\n                customer_name: order.customer_name,\r\n                customer_email: order.customer_email,\r\n                customer_phone: order.customer_phone || null,\r\n                shipping_address: order.shipping_address || null,\r\n                status: order.status || 'pending',\r\n                subtotal: order.subtotal,\r\n                tax: order.tax,\r\n                discount: order.discount,\r\n                total: order.total || order.total_amount,\r\n                total_amount: order.total || order.total_amount,\r\n                notes: order.notes || null,\r\n                payment_method: order.payment_method || null,\r\n                order_number: orderNumber,\r\n                user_id: order.user_id || null,\r\n                tenant_id: tenantId\r\n            };\r\n\r\n            const { error: orderError } = await this.supabase\r\n                .from('orders')\r\n                .insert(insertPayload);\r\n\r\n            if (orderError) throw orderError;\r\n\r\n            const itemsWithOrderId = items.map(item => ({\r\n                order_id: orderId,\r\n                product_id: item.product_id || null,\r\n                course_id: item.course_id || null,\r\n                product_name: item.product_name,\r\n                quantity: item.quantity,\r\n                unit_price: item.unit_price,\r\n                subtotal: item.subtotal,\r\n                tenant_id: tenantId\r\n            }));\r\n\r\n            const { error: itemsError } = await this.supabase\r\n                .from('order_items')\r\n                .insert(itemsWithOrderId);\r\n\r\n            if (itemsError) throw itemsError;\r\n\r\n            const orderData: Order = { \r\n                ...order, \r\n                id: orderId, \r\n                order_number: orderNumber,\r\n                created_at: new Date().toISOString(),\r\n                tenant_id: tenantId\r\n            };\r\n            return { data: orderData, error: null };\r\n        } catch (error: any) {\r\n            this.handleError('Critical error creating order', error);\r\n            return { data: null, error: error };\r\n        }\r\n    }\r\n\r\n    async updateOrderStatus(id: string, status: Order['status']): Promise<{ error: PostgrestError | Error | null }> {\r\n        let query = this.supabase\r\n            .from('orders')\r\n            .update({ status, updated_at: new Date().toISOString() })\r\n            .eq('id', id);\r\n            \r\n        const { error, data } = await this.applyTenantFilter(query).select('id, status');\r\n\r\n        if (error) this.handleError('Error updating order status', error);\r\n        \r\n        if (!error && (!data || data.length === 0)) {\r\n            return { error: new Error(\"Supabase RLS Error: Permission denied or Record filtered out.\") };\r\n        }\r\n        \r\n        return { error };\r\n    }\r\n\r\n    async deleteOrder(id: string): Promise<{ error: PostgrestError | null }> {\r\n        let query = this.supabase\r\n            .from('orders')\r\n            .delete()\r\n            .eq('id', id);\r\n            \r\n        const { error } = await this.applyTenantFilter(query);\r\n\r\n        if (error) this.handleError('Error deleting order', error);\r\n        return { error };\r\n    }\r\n    \r\n    async updateOrder(id: string, order: Order, items: OrderItem[]): Promise<{ data: Order | null; error: PostgrestError | Error | null }> {\r\n        try {\r\n            const updatePayload: any = {\r\n                customer_name: order.customer_name,\r\n                customer_email: order.customer_email,\r\n                customer_phone: order.customer_phone || null,\r\n                shipping_address: order.shipping_address || null,\r\n                status: order.status,\r\n                subtotal: order.subtotal,\r\n                tax: order.tax,\r\n                discount: order.discount,\r\n                total: order.total || order.total_amount,\r\n                total_amount: order.total || order.total_amount,\r\n                notes: order.notes || null,\r\n                payment_method: order.payment_method || null,\r\n                updated_at: new Date().toISOString()\r\n            };\r\n\r\n            let query = this.supabase\r\n                .from('orders')\r\n                .update(updatePayload)\r\n                .eq('id', id);\r\n\r\n            const { error: orderError, data: updatedOrdersData } = await this.applyTenantFilter(query).select('id');\r\n\r\n            if (orderError) throw orderError;\r\n            \r\n            if (!updatedOrdersData || updatedOrdersData.length === 0) {\r\n                throw new Error(\"Supabase RLS Error: Permission denied or Record filtered out.\");\r\n            }\r\n\r\n            await this.handleItemsUpdate(id, items);\r\n\r\n            // Fetching updated data is expensive and usually not needed on redirect\r\n            // Let's return the basic order info we have\r\n            return { data: { ...order, id }, error: null };\r\n        } catch (error: unknown) {\r\n            this.handleError('Error updating order', error);\r\n            return { data: null, error: error as PostgrestError };\r\n        }\r\n    }\r\n\r\n    private async handleItemsUpdate(orderId: string, items: OrderItem[]): Promise<void> {\r\n        const tenantId = this.tenantService.getTenantId();\r\n        \r\n        // 1. Delete all existing items for this order (1 round trip)\r\n        const { error: deleteError } = await this.supabase\r\n            .from('order_items')\r\n            .delete()\r\n            .eq('order_id', orderId)\r\n            .eq('tenant_id', tenantId);\r\n\r\n        if (deleteError) throw deleteError;\r\n\r\n        // 2. Insert new items (1 round trip)\r\n        const itemsToInsert = items.map(item => ({\r\n            order_id: orderId,\r\n            product_name: item.product_name,\r\n            quantity: item.quantity,\r\n            unit_price: item.unit_price,\r\n            subtotal: item.subtotal,\r\n            product_id: item.product_id || null,\r\n            course_id: item.course_id || null,\r\n            tenant_id: tenantId\r\n        }));\r\n\r\n        if (itemsToInsert.length > 0) {\r\n            const { error: insertError } = await this.supabase\r\n                .from('order_items')\r\n                .insert(itemsToInsert);\r\n\r\n            if (insertError) throw insertError;\r\n        }\r\n    }\r\n\r\n    private mapDbOrderToDomain(o: any): OrderWithItems {\r\n        return {\r\n            id: o.id,\r\n            created_at: o.created_at,\r\n            updated_at: o.updated_at || undefined,\r\n            order_number: o.order_number,\r\n            customer_name: o.customer_name,\r\n            customer_email: o.customer_email,\r\n            customer_phone: o.customer_phone || undefined,\r\n            shipping_address: o.shipping_address || o.customer_address || undefined,\r\n            user_id: o.user_id || o.customer_id || undefined,\r\n            status: o.status,\r\n            subtotal: o.subtotal,\r\n            tax: o.tax,\r\n            discount: o.discount,\r\n            total: o.total_amount,\r\n            notes: o.notes || undefined,\r\n            items: (o.order_items || []).map((i: any) => ({\r\n                id: i.id,\r\n                order_id: i.order_id,\r\n                product_id: i.product_id || undefined,\r\n                course_id: i.course_id || undefined,\r\n                product_name: i.product_name,\r\n                quantity: i.quantity,\r\n                unit_price: i.unit_price,\r\n                subtotal: i.subtotal,\r\n                created_at: i.created_at\r\n            }))\r\n        };\r\n    }\r\n\r\n    private handleError(msg: string, error: unknown) {\r\n        this.logger.error(`${msg}:`, error);\r\n    }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
