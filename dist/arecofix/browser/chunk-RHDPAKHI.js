import{a as W}from"./chunk-MMX2KHFQ.js";import{a as J}from"./chunk-A7HSRCHR.js";import{h as H}from"./chunk-BGHZUC77.js";import{d as K}from"./chunk-6WWONRBM.js";import{a as G}from"./chunk-MQUL3GSM.js";import{b as B,d as $,g as L,t as R}from"./chunk-63CMMPDH.js";import{a as U}from"./chunk-6MFU4D2Y.js";import"./chunk-YTQUIG7T.js";import"./chunk-QBOH7QZY.js";import{n as z}from"./chunk-YNFFGNY6.js";import{o as F,q as Q}from"./chunk-Q44XB7TV.js";import{$ as w,Ab as i,Bb as a,Cb as s,Gb as I,Kb as p,Mb as b,Pa as M,Tb as D,Ua as l,Vb as d,W as f,Wb as g,Xb as N,aa as S,gb as V,lc as v,ma as u,mc as _,oa as O,tb as E,ub as T,uc as y,xb as A,yb as q,zb as h}from"./chunk-DX2LKEMG.js";import{a as k,b as C}from"./chunk-C6Q5SG76.js";var Y=(o,t)=>t.id;function ee(o,t){o&1&&(i(0,"div",9),s(1,"span",33),a())}function te(o,t){o&1&&(i(0,"div",10),s(1,"i",34),i(2,"p",35),d(3,"No se encontraron productos."),a()())}function ie(o,t){if(o&1){let e=I();i(0,"div",37),p("click",function(){let n=w(e).$implicit,m=b(2);return S(m.addToCart(n))}),i(1,"figure",38),s(2,"img",39),i(3,"div",40),d(4),a()(),i(5,"div",41)(6,"h3",42),d(7),a(),i(8,"div",43),d(9),v(10,"currency"),a(),i(11,"div",44),d(12),a()()()}if(o&2){let e=t.$implicit;l(2),h("src",e.image_url||"assets/img/no-image.png",M),l(),D("badge-warning",e.stock<5)("badge-primary",e.stock>=5),l(),N(" ",e.stock," "),l(3),g(e.name),l(2),N(" ",_(10,9,e.price)," "),l(3),g(e.sku)}}function re(o,t){if(o&1&&(i(0,"div",11),A(1,ie,13,11,"div",36,Y),a()),o&2){let e=b();l(),q(e.paginatedProducts())}}function ae(o,t){o&1&&(i(0,"div",10),s(1,"i",45),i(2,"p"),d(3,"Carrito Vac\xEDo"),a(),i(4,"p",46),d(5,"Selecciona productos para empezar."),a()())}function ne(o,t){if(o&1){let e=I();i(0,"div",47),s(1,"img",48),i(2,"div",49)(3,"div",50),d(4),a(),i(5,"div",51)(6,"div",52),d(7),v(8,"currency"),a(),i(9,"div",53),d(10),v(11,"currency"),a()()(),i(12,"div",54)(13,"div",55)(14,"button",56),p("click",function(){let n=w(e).$implicit,m=b(2);return S(m.updateQuantity(n.id,1))}),s(15,"i",57),a(),i(16,"span",58),d(17),a(),i(18,"button",59),p("click",function(){let n=w(e).$implicit,m=b(2);return S(m.updateQuantity(n.id,-1))}),s(19,"i",60),a()()(),i(20,"button",61),p("click",function(){let n=w(e).$implicit,m=b(2);return S(m.removeFromCart(n.id))}),s(21,"i",62),a()()}if(o&2){let e=t.$implicit;l(),h("src",e.image_url||"assets/img/no-image.png",M),l(3),g(e.name),l(3),g(_(8,5,e.price)),l(3),g(_(11,7,e.price*e.quantity)),l(7),g(e.quantity)}}function oe(o,t){if(o&1&&A(0,ne,22,9,"div",47,Y),o&2){let e=b();q(e.cart())}}function le(o,t){o&1&&(s(0,"span",63),d(1," Procesando... "))}function de(o,t){o&1&&(s(0,"i",64),d(1," Confirmar Venta "))}var X=class o{auth=f(K);router=f(z);logger=f(U);tenantService=f(H);productRepository=f(G);orderService=f(W);products=u([]);cart=u([]);searchQuery=u("");loading=u(!1);processing=u(!1);isCartOpenMobile=u(!1);currentPage=u(1);itemsPerPage=u(12);filteredProducts=y(()=>{let t=this.searchQuery().toLowerCase();return this.products().filter(e=>e.name.toLowerCase().includes(t)||e.sku?.toLowerCase().includes(t)||e.barcode?.toLowerCase().includes(t))});paginatedProducts=y(()=>{let t=this.filteredProducts(),e=(this.currentPage()-1)*this.itemsPerPage();return t.slice(e,e+this.itemsPerPage())});totalPages=y(()=>Math.ceil(this.filteredProducts().length/this.itemsPerPage()));cartTotal=y(()=>this.cart().reduce((t,e)=>t+e.price*e.quantity,0));cartCount=y(()=>this.cart().reduce((t,e)=>t+e.quantity,0));constructor(){O(()=>{this.searchQuery(),this.currentPage.set(1)})}async ngOnInit(){await this.loadProducts()}async loadProducts(){this.loading.set(!0),this.productRepository.findAvailable().subscribe({next:t=>{this.products.set(t),this.loading.set(!1)},error:t=>{this.logger.error("Error loading products",t),this.loading.set(!1)}})}addToCart(t){this.cart.update(e=>{let r=e.find(n=>n.id===t.id);return r?r.quantity>=t.stock?e:e.map(n=>n.id===t.id?C(k({},n),{quantity:n.quantity+1}):n):[...e,C(k({},t),{quantity:1})]})}removeFromCart(t){this.cart.update(e=>e.filter(r=>r.id!==t))}updateQuantity(t,e){this.cart.update(r=>r.map(n=>{if(n.id===t){let P=this.products().find(c=>c.id===t)?.stock||0,x=n.quantity+e;return x>P?n:x>0?C(k({},n),{quantity:x}):n}return n}))}async checkout(){if(this.cart().length===0)return;this.processing.set(!0);let t=this.auth.getSupabaseClient(),e=this.auth.getCurrentUser();try{let r=this.tenantService.getTenantId(),n={customer_name:"Venta Mostrador",customer_email:"mostrador@arecofix.com",status:"completed",subtotal:this.cartTotal(),tax:0,discount:0,total:this.cartTotal()},m=this.cart().map(c=>({product_id:c.id,product_name:c.name,unit_price:c.price,quantity:c.quantity,subtotal:c.price*c.quantity})),{data:P,error:x}=await this.orderService.createOrder(n,m);if(x||!P)throw x||new Error("Order creation failed");for(let c of this.cart()){let{error:Z}=await t.rpc("decrement_stock_tenant",{row_id:c.id,amount:c.quantity,t_id:r});if(Z){let{data:j}=await t.from("products").select("stock").eq("id",c.id).eq("tenant_id",r).single();j&&await t.from("products").update({stock:j.stock-c.quantity}).eq("id",c.id).eq("tenant_id",r)}}await t.from("invoices").insert({order_id:P.id,tenant_id:r,total_amount:this.cartTotal(),type:"B",issued_at:new Date().toISOString()}),this.cart.set([]),this.router.navigate(["/admin/invoices"])}catch(r){this.logger.error("Checkout error",r),alert("Error al procesar la venta: "+r.message)}finally{this.processing.set(!1)}}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=V({type:o,selectors:[["app-admin-sales-page"]],decls:50,vars:19,consts:[[1,"h-[calc(100vh-4rem)]","flex","flex-col","md:flex-row","bg-gray-50","dark:bg-[#0f172a]","overflow-hidden"],[1,"flex-1","flex","flex-col","h-full","overflow-hidden","relative"],[1,"bg-white","dark:bg-[#1e293b]","p-4","border-b","border-gray-200","dark:border-gray-700","z-10","shadow-xs","flex","flex-col","sm:flex-row","justify-between","items-center","gap-4"],[1,"text-2xl","font-bold","bg-clip-text","text-transparent","bg-linear-to-r","from-blue-500","to-indigo-500","flex","items-center","gap-2"],[1,"fas","fa-cash-register","text-indigo-500"],[1,"w-full","sm:max-w-md","relative","group"],[1,"fas","fa-search","absolute","left-4","top-1/2","-translate-y-1/2","text-gray-400"],["type","text","placeholder","Buscar por nombre, SKU, c\xF3digo...",1,"input","input-bordered","w-full","pl-10","bg-gray-50","dark:bg-gray-800","transition-all","focus:ring-2","focus:ring-primary/20",3,"ngModelChange","ngModel"],[1,"flex-1","overflow-y-auto","p-4","md:p-6","custom-scrollbar"],[1,"flex","justify-center","py-20"],[1,"flex","flex-col","items-center","justify-center","h-64","text-gray-400"],[1,"grid","grid-cols-2","sm:grid-cols-3","lg:grid-cols-4","xl:grid-cols-5","gap-4"],[1,"mt-8","flex","justify-center","pb-8"],[3,"pages","currentPage"],[1,"md:hidden","fixed","bottom-6","right-6","btn","btn-circle","btn-primary","btn-lg","shadow-2xl","z-50",3,"click"],[1,"indicator"],[1,"indicator-item","badge","badge-secondary"],[1,"fas","fa-shopping-cart","text-2xl"],[1,"fixed","inset-y-0","right-0","z-40","w-full","md:relative","md:w-96","bg-white","dark:bg-[#1e293b]","shadow-2xl","md:shadow-none","border-l","border-gray-200","dark:border-gray-700","transform","transition-transform","duration-300","ease-in-out","flex","flex-col","h-full"],[1,"p-4","border-b","border-gray-200","dark:border-gray-700","bg-gray-50","dark:bg-gray-800","flex","justify-between","items-center"],[1,"text-xl","font-bold","flex","items-center","gap-2","text-gray-800","dark:text-white"],[1,"fas","fa-shopping-cart","text-primary"],[1,"badge","badge-neutral"],[1,"btn","btn-circle","btn-sm","btn-ghost","md:hidden",3,"click"],[1,"fas","fa-times"],[1,"flex-1","overflow-y-auto","p-4","space-y-3","custom-scrollbar"],[1,"p-6","border-t","border-gray-200","dark:border-gray-700","bg-white","dark:bg-[#1e293b]","shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]","z-20"],[1,"space-y-4","mb-6"],[1,"flex","justify-between","text-gray-500","text-sm"],[1,"flex","justify-between","items-end"],[1,"text-lg","font-bold","text-gray-800","dark:text-white"],[1,"text-3xl","font-bold","text-primary"],[1,"btn","btn-primary","w-full","btn-lg","shadow-lg","shadow-blue-500/30","text-lg","hover:scale-[1.02]","active:scale-[0.98]","transition-all",3,"click","disabled"],[1,"loading","loading-spinner","loading-lg","text-primary"],[1,"fas","fa-box-open","text-6xl","mb-4","opacity-50"],[1,"text-lg"],[1,"card","bg-white","dark:bg-gray-800","shadow-sm","border","border-gray-100","dark:border-gray-700","hover:shadow-xl","hover:border-primary/50","transition-all","duration-200","cursor-pointer","group","active:scale-95"],[1,"card","bg-white","dark:bg-gray-800","shadow-sm","border","border-gray-100","dark:border-gray-700","hover:shadow-xl","hover:border-primary/50","transition-all","duration-200","cursor-pointer","group","active:scale-95",3,"click"],[1,"px-4","pt-4","relative","aspect-square"],["alt","Product",1,"rounded-xl","object-contain","w-full","h-full","group-hover:scale-105","transition-transform",3,"src"],[1,"absolute","top-2","right-2","badge","badge-sm"],[1,"card-body","p-4","text-center"],[1,"font-bold","text-sm","line-clamp-2","text-gray-800","dark:text-gray-200","h-10","leading-tight"],[1,"mt-2","text-primary","font-bold","text-lg"],[1,"text-xs","text-gray-400","font-mono"],[1,"fas","fa-cart-arrow-down","text-6xl","mb-4","opacity-30"],[1,"text-sm"],[1,"flex","items-center","gap-3","bg-gray-50","dark:bg-gray-800/50","p-3","rounded-xl","border","border-gray-100","dark:border-gray-700","animate-fade-in","group","hover:bg-white","dark:hover:bg-gray-800","transition-colors","shadow-sm"],[1,"w-16","h-16","object-cover","rounded-lg","bg-white",3,"src"],[1,"flex-1","min-w-0"],[1,"font-bold","text-sm","text-gray-900","dark:text-gray-100","truncate","mb-1"],[1,"flex","justify-between","items-center"],[1,"text-xs","text-gray-500"],[1,"font-bold","text-gray-900","dark:text-white"],[1,"flex","flex-col","items-center","ml-2","gap-1"],[1,"join","join-vertical","shadow-sm"],[1,"btn","btn-xs","join-item","btn-ghost","text-success",3,"click"],[1,"fas","fa-plus"],[1,"join-item","bg-base-100","text-xs","font-bold","w-6","h-5","flex","items-center","justify-center","border-x","border-base-200"],[1,"btn","btn-xs","join-item","btn-ghost","text-warning",3,"click"],[1,"fas","fa-minus"],[1,"btn","btn-circle","btn-ghost","btn-xs","text-gray-400","hover:text-error","opacity-0","group-hover:opacity-100","transition-opacity",3,"click"],[1,"fas","fa-trash"],[1,"loading","loading-spinner"],[1,"fas","fa-check-circle","mr-2"]],template:function(e,r){e&1&&(i(0,"div",0)(1,"div",1)(2,"div",2)(3,"div")(4,"h1",3),s(5,"i",4),d(6," Punto de Venta "),a()(),i(7,"div",5),s(8,"i",6),i(9,"input",7),p("ngModelChange",function(m){return r.searchQuery.set(m)}),a()()(),i(10,"div",8),E(11,ee,2,0,"div",9)(12,te,4,0,"div",10)(13,re,3,0,"div",11),i(14,"div",12),s(15,"pagination",13),a()(),i(16,"button",14),p("click",function(){return r.isCartOpenMobile.set(!0)}),i(17,"div",15)(18,"span",16),d(19),a(),s(20,"i",17),a()()(),i(21,"div",18)(22,"div",19)(23,"h2",20),s(24,"i",21),d(25," Carrito "),i(26,"span",22),d(27),a()(),i(28,"button",23),p("click",function(){return r.isCartOpenMobile.set(!1)}),s(29,"i",24),a()(),i(30,"div",25),E(31,ae,6,0,"div",10)(32,oe,2,0),a(),i(33,"div",26)(34,"div",27)(35,"div",28)(36,"span"),d(37,"Subtotal"),a(),i(38,"span"),d(39),v(40,"currency"),a()(),i(41,"div",29)(42,"span",30),d(43,"Total a Pagar"),a(),i(44,"span",31),d(45),v(46,"currency"),a()()(),i(47,"button",32),p("click",function(){return r.checkout()}),E(48,le,2,0)(49,de,2,0),a()()()()),e&2&&(l(9),h("ngModel",r.searchQuery()),l(2),T(r.loading()?11:r.paginatedProducts().length===0?12:13),l(4),h("pages",r.totalPages())("currentPage",r.currentPage()),l(4),g(r.cartCount()),l(2),D("translate-x-full",!r.isCartOpenMobile())("md:translate-x-0",!0),l(6),g(r.cartCount()),l(4),T(r.cart().length===0?31:32),l(8),g(_(40,15,r.cartTotal())),l(6),g(_(46,17,r.cartTotal())),l(2),h("disabled",r.cart().length===0||r.processing()),l(),T(r.processing()?48:49))},dependencies:[Q,R,B,$,L,J,F],encapsulation:2})};export{X as AdminSalesPage};
