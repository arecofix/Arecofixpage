{
  "version": 3,
  "sources": ["src/app/core/services/notification.service.ts"],
  "sourcesContent": ["import { Injectable, signal, inject } from '@angular/core';\r\nimport { SUPABASE_CLIENT } from '../di/supabase-token';\r\nimport { AuthService } from './auth.service';\r\nimport { TenantService } from './tenant.service';\r\n\r\nexport interface AppNotification {\r\n  id: string;\r\n  title: string;\r\n  message: string;\r\n  type: string;\r\n  link?: string;\r\n  is_read: boolean;\r\n  created_at: string;\r\n}\r\n\r\nexport type NotificationType = 'success' | 'error' | 'warning' | 'info';\r\n\r\nexport interface Notification {\r\n    id: string;\r\n    type: NotificationType;\r\n    message: string;\r\n    duration?: number;\r\n}\r\n\r\n/**\r\n * Notification Service\r\n * Provides user feedback for operations\r\n */\r\n@Injectable({\r\n    providedIn: 'root'\r\n})\r\nexport class NotificationService {\r\n    // ---- Toast Notifications (Existing) ----\r\n    private notifications = signal<Notification[]>([]);\r\n    public notifications$ = this.notifications.asReadonly();\r\n\r\n    // ---- DB Bell Notifications (New) ----\r\n    private supabase = inject(SUPABASE_CLIENT);\r\n    private auth = inject(AuthService);\r\n    private tenantService = inject(TenantService);\r\n\r\n    private _dbNotifications = signal<AppNotification[]>([]);\r\n    public dbNotifications = this._dbNotifications.asReadonly();\r\n\r\n    private _unreadCount = signal<number>(0);\r\n    public unreadCount = this._unreadCount.asReadonly();\r\n\r\n    private realtimeChannel: any;\r\n\r\n    /**\r\n     * Show success notification\r\n     */\r\n    showSuccess(message: string, duration: number = 3000): void {\r\n        this.show('success', message, duration);\r\n    }\r\n\r\n    /**\r\n     * Show error notification\r\n     */\r\n    showError(message: string, duration: number = 5000): void {\r\n        this.show('error', message, duration);\r\n    }\r\n\r\n    /**\r\n     * Show warning notification\r\n     */\r\n    showWarning(message: string, duration: number = 4000): void {\r\n        this.show('warning', message, duration);\r\n    }\r\n\r\n    /**\r\n     * Show info notification\r\n     */\r\n    showInfo(message: string, duration: number = 3000): void {\r\n        this.show('info', message, duration);\r\n    }\r\n\r\n    /**\r\n     * Show notification\r\n     */\r\n    private show(type: NotificationType, message: string, duration: number): void {\r\n        const notification: Notification = {\r\n            id: this.generateId(),\r\n            type,\r\n            message,\r\n            duration\r\n        };\r\n\r\n        this.notifications.update(notifications => [...notifications, notification]);\r\n\r\n        // Auto-remove after duration\r\n        if (duration > 0) {\r\n            setTimeout(() => this.remove(notification.id), duration);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Remove notification by ID\r\n     */\r\n    remove(id: string): void {\r\n        this.notifications.update(notifications =>\r\n            notifications.filter(n => n.id !== id)\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Clear all notifications\r\n     */\r\n    clearAll(): void {\r\n        this.notifications.set([]);\r\n    }\r\n\r\n    /**\r\n     * Generate unique ID\r\n     */\r\n    private generateId(): string {\r\n        return `notification-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\r\n    }\r\n\r\n    // ============================================\r\n    //         DB BELL NOTIFICATIONS METHODS\r\n    // ============================================\r\n    async loadNotifications() {\r\n        const user = this.auth.getCurrentUser();\r\n        if (!user) return;\r\n\r\n        const { data, error } = await this.supabase\r\n            .from('notifications')\r\n            .select('*')\r\n            .eq('user_id', user.id)\r\n            .eq('tenant_id', this.tenantService.getTenantId())\r\n            .order('created_at', { ascending: false })\r\n            .limit(50);\r\n\r\n        if (!error && data) {\r\n            this._dbNotifications.set(data as AppNotification[]);\r\n            this._unreadCount.set(data.filter(n => !n.is_read).length);\r\n        }\r\n    }\r\n\r\n    async markAsRead(notificationId: string) {\r\n        const { error } = await this.supabase\r\n            .from('notifications')\r\n            .update({ is_read: true })\r\n            .eq('id', notificationId);\r\n\r\n        if (!error) {\r\n            this._dbNotifications.update(nots => \r\n                nots.map(n => n.id === notificationId ? { ...n, is_read: true } : n)\r\n            );\r\n            this._unreadCount.update(count => Math.max(0, count - 1));\r\n        }\r\n    }\r\n\r\n    async markAllAsRead() {\r\n        const user = this.auth.getCurrentUser();\r\n        if (!user) return;\r\n\r\n        const { error } = await this.supabase\r\n            .from('notifications')\r\n            .update({ is_read: true })\r\n            .eq('user_id', user.id)\r\n            .eq('is_read', false);\r\n\r\n        if (!error) {\r\n            this._dbNotifications.update(nots => \r\n                nots.map(n => ({ ...n, is_read: true }))\r\n            );\r\n            this._unreadCount.set(0);\r\n        }\r\n    }\r\n\r\n    subscribeToRealtime() {\r\n        const user = this.auth.getCurrentUser();\r\n        if (!user) return;\r\n\r\n        this.realtimeChannel = this.supabase\r\n            .channel('public:notifications')\r\n            .on('postgres_changes', \r\n                { \r\n                    event: 'INSERT', \r\n                    schema: 'public', \r\n                    table: 'notifications',\r\n                    filter: `user_id=eq.${user.id}`\r\n                }, \r\n                (payload: any) => {\r\n                    const newNotif = payload.new as AppNotification;\r\n                    this._dbNotifications.update(nots => [newNotif, ...nots]);\r\n                    this._unreadCount.update(count => count + 1);\r\n                    \r\n                    // Show a toast when a new DB notification triggers!\r\n                    this.showInfo(newNotif.title + ' - ' + newNotif.message);\r\n                }\r\n            )\r\n            .subscribe();\r\n    }\r\n\r\n    unsubscribe() {\r\n        if (this.realtimeChannel) {\r\n            this.supabase.removeChannel(this.realtimeChannel);\r\n        }\r\n    }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
