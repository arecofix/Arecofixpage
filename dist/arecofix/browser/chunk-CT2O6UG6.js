import{a as g}from"./chunk-JYOT3LNB.js";import{a as O}from"./chunk-F5WBDNED.js";import{C as h,R as f,W as b,k as p,r as _}from"./chunk-G4WDTWI7.js";import{a as c,b as l}from"./chunk-7CGTOI24.js";var w=class u{authService=b(g);logger=b(O);supabase;constructor(){this.supabase=this.authService.getSupabaseClient()}getOrders(){return p(this.supabase.from("orders").select("*, order_items(*)").order("created_at",{ascending:!1}).returns()).pipe(_(({data:r,error:t})=>{if(t)throw t;return(r||[]).map(this.mapDbOrderToDomain)}),h(r=>{throw this.handleError("Error fetching orders",r),r}))}getOrderById(r){return p(Promise.all([this.supabase.from("orders").select("*").eq("id",r).single(),this.supabase.from("order_items").select("*").eq("order_id",r)])).pipe(_(([t,a])=>{if(t.error)throw t.error;if(a.error)throw a.error;let s=t.data;return s.order_items=a.data,this.mapDbOrderToDomain(s)}),h(t=>{throw this.handleError("Error fetching order",t),t}))}async createOrder(r,t){try{let a=crypto.randomUUID(),s=`ORD-${Date.now()}`,d={id:a,customer_name:r.customer_name,customer_email:r.customer_email,customer_phone:r.customer_phone||null,customer_address:r.customer_address||null,status:r.status||"pending",subtotal:r.subtotal,tax:r.tax,discount:r.discount,total_amount:r.total,notes:r.notes||null,order_number:s,customer_id:r.customer_id||null},{error:o}=await this.supabase.from("orders").insert(d);if(o)throw o;let n=t.map(e=>({order_id:a,product_id:e.product_id||null,product_name:e.product_name,quantity:e.quantity,unit_price:e.unit_price,subtotal:e.subtotal})),{error:i}=await this.supabase.from("order_items").insert(n);if(i)throw i;return{data:l(c({},r),{id:a,order_number:s,created_at:new Date().toISOString()}),error:null}}catch(a){return this.handleError("Error creating order",a),{data:null,error:a}}}async updateOrderStatus(r,t){let{error:a}=await this.supabase.from("orders").update({status:t,updated_at:new Date().toISOString()}).eq("id",r);return a&&this.handleError("Error updating order status",a),{error:a}}async deleteOrder(r){let{error:t}=await this.supabase.from("orders").delete().eq("id",r);return t&&this.handleError("Error deleting order",t),{error:t}}async updateOrder(r,t,a){try{let s={customer_name:t.customer_name,customer_email:t.customer_email,customer_phone:t.customer_phone||null,customer_address:t.customer_address||null,status:t.status,subtotal:t.subtotal,tax:t.tax,discount:t.discount,total_amount:t.total,notes:t.notes||null,updated_at:new Date().toISOString()},{data:d,error:o}=await this.supabase.from("orders").update(s).eq("id",r).select().maybeSingle();if(o)throw o;if(!d)throw new Error("Order not found or permission denied");await this.handleItemsUpdate(r,a);let n=d,{data:i}=await this.supabase.from("order_items").select("*").eq("order_id",r);return n.order_items=i,{data:this.mapDbOrderToDomain(n),error:null}}catch(s){return this.handleError("Error updating order",s),{data:null,error:s}}}async handleItemsUpdate(r,t){let{data:a,error:s}=await this.supabase.from("order_items").select("id").eq("order_id",r);if(s)throw s;let d=(a||[]).map(e=>e.id),o=t.filter(e=>e.id).map(e=>e.id),n=d.filter(e=>!o.includes(e));if(n.length>0){let{error:e}=await this.supabase.from("order_items").delete().in("id",n);if(e)throw e}let i=t.map(e=>l(c({},e.id?{id:e.id}:{}),{order_id:r,product_name:e.product_name,quantity:e.quantity,unit_price:e.unit_price,subtotal:e.subtotal,product_id:e.product_id||null})),{error:m}=await this.supabase.from("order_items").upsert(i);if(m)throw m}mapDbOrderToDomain(r){return{id:r.id,created_at:r.created_at,updated_at:r.updated_at||void 0,order_number:r.order_number,customer_name:r.customer_name,customer_email:r.customer_email,customer_phone:r.customer_phone||void 0,customer_address:r.customer_address||void 0,customer_id:r.customer_id||void 0,status:r.status,subtotal:r.subtotal,tax:r.tax,discount:r.discount,total:r.total_amount,notes:r.notes||void 0,items:(r.order_items||[]).map(t=>({id:t.id,order_id:t.order_id,product_id:t.product_id||void 0,product_name:t.product_name,quantity:t.quantity,unit_price:t.unit_price,subtotal:t.subtotal,created_at:t.created_at}))}}handleError(r,t){this.logger.error(`${r}:`,t)}static \u0275fac=function(t){return new(t||u)};static \u0275prov=f({token:u,factory:u.\u0275fac,providedIn:"root"})};export{w as a};
