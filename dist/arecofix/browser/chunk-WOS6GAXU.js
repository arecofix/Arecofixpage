import{a as w}from"./chunk-XUGVF5KJ.js";import{C as f,S as g,W as O,o as l,u as h}from"./chunk-7J724YZS.js";import{a as d,b as u}from"./chunk-VOSPIT4N.js";var y=class c{constructor(r){this.authService=r;this.supabase=this.authService.getSupabaseClient()}supabase;getOrders(){return l(this.supabase.from("orders").select("*").order("created_at",{ascending:!1})).pipe(h(({data:r,error:e})=>{if(e)throw e;return r||[]}),f(r=>{throw console.error("Error fetching orders:",r),r}))}getOrderById(r){return l(Promise.all([this.supabase.from("orders").select("*").eq("id",r).single(),this.supabase.from("order_items").select("*").eq("order_id",r)])).pipe(h(([e,t])=>{if(e.error)throw e.error;if(t.error)throw t.error;return u(d({},e.data),{items:t.data||[]})}),f(e=>{throw console.error("Error fetching order:",e),e}))}async createOrder(r,e){try{let t=`ORD-${Date.now()}`,o={customer_name:r.customer_name,customer_email:r.customer_email,customer_phone:r.customer_phone,customer_address:r.customer_address,status:r.status,subtotal:r.subtotal,tax:r.tax,discount:r.discount,total_amount:r.total,notes:r.notes,order_number:t},{data:a,error:i}=await this.supabase.from("orders").insert(o).select().single();if(i)throw i;let m=e.map(p=>u(d({},p),{order_id:a.id})),{error:n}=await this.supabase.from("order_items").insert(m);if(n)throw n;return{data:a,error:null}}catch(t){return console.error("Error creating order:",t),{data:null,error:t}}}async updateOrderStatus(r,e){let{error:t}=await this.supabase.from("orders").update({status:e,updated_at:new Date().toISOString()}).eq("id",r);return{error:t}}async deleteOrder(r){let{error:e}=await this.supabase.from("orders").delete().eq("id",r);return{error:e}}async updateOrder(r,e,t){try{let o={customer_name:e.customer_name,customer_email:e.customer_email,customer_phone:e.customer_phone,customer_address:e.customer_address,status:e.status,subtotal:e.subtotal,tax:e.tax,discount:e.discount,total_amount:e.total,notes:e.notes,updated_at:new Date().toISOString()},{data:a,error:i}=await this.supabase.from("orders").update(o).eq("id",r).select().maybeSingle();if(i)throw i;if(!a)throw new Error("Order not found or permission denied");let{data:m,error:n}=await this.supabase.from("order_items").select("id").eq("order_id",r);if(n)throw n;let p=m.map(s=>s.id),I=t.filter(s=>s.id).map(s=>s.id),_=p.filter(s=>!I.includes(s));if(_.length>0){let{error:s}=await this.supabase.from("order_items").delete().in("id",_);if(s)throw s}let S=t.map(s=>u(d({},s),{order_id:r})),{error:b}=await this.supabase.from("order_items").upsert(S);if(b)throw b;return{data:a,error:null}}catch(o){return console.error("Error updating order:",o),{data:null,error:o}}}static \u0275fac=function(e){return new(e||c)(O(w))};static \u0275prov=g({token:c,factory:c.\u0275fac,providedIn:"root"})};export{y as a};
