import{a as k,b as _}from"./chunk-OPJKVOQK.js";import{a as R}from"./chunk-6KLMDNRR.js";import{a as C}from"./chunk-I4DLVUEL.js";import{R as w,W as g,p as d}from"./chunk-SD6TJRIO.js";var S=class b{productRepo=g(k);brandRepo=g(R);categoryRepo=g(_);auth=g(C);supabase=this.auth.getSupabaseClient();async getProducts(){return d(this.productRepo.getAll())}async getProduct(t){return d(this.productRepo.getById(t))}async getBrands(){return d(this.brandRepo.getAll())}async getCategories(){return d(this.categoryRepo.getAll())}async createProduct(t){await d(this.productRepo.create(t))}async updateProduct(t,r){await d(this.productRepo.update(t,r))}async uploadImage(t){let r=`products/${Date.now()}-${t.name}`,{data:s,error:n}=await this.supabase.storage.from("public-assets").upload(r,t);if(n)throw n;let{data:e}=this.supabase.storage.from("public-assets").getPublicUrl(s.path);return e.publicUrl}slugify(t){return t.toString().toLowerCase().trim().replace(/\s+/g,"-").replace(/&/g,"-and-").replace(/[^a-z0-9-]/g,"").replace(/-+/g,"-")}async exportProductsToCSV(){let t=await this.getProducts();if(!t.length)return;let r=["id","name","slug","description","price","stock","category_id","brand_id","image_url","is_active","is_featured","sku","barcode"],s=[r.join(","),...t.map(i=>r.map(m=>{let o=i[m]||"";return typeof o=="string"&&(o.includes(",")||o.includes('"')||o.includes(`
`))?`"${o.replace(/"/g,'""')}"`:o}).join(","))].join(`
`),n=new Blob([s],{type:"text/csv;charset=utf-8;"}),e=document.createElement("a"),l=URL.createObjectURL(n);e.setAttribute("href",l),e.setAttribute("download",`products_export_${new Date().toISOString().split("T")[0]}.csv`),e.style.visibility="hidden",document.body.appendChild(e),e.click(),document.body.removeChild(e)}async importProductsFromCSV(t){return new Promise((r,s)=>{let n=new FileReader;n.onload=async e=>{try{let i=e.target.result.split(/\r\n|\n/),m=i[0].split(",").map(u=>u.trim()),o=[],y=0;for(let u=1;u<i.length;u++){let v=i[u].trim();if(!v)continue;let f=[],P=!1,h="";for(let a of v)a==='"'?P=!P:a===","&&!P?(f.push(h),h=""):h+=a;if(f.push(h),f.length!==m.length){console.warn(`Skipping line ${u+1}: Column count mismatch`),y++;continue}let c={};m.forEach((a,A)=>{let p=f[A]?.trim();p?.startsWith('"')&&p?.endsWith('"')&&(p=p.substring(1,p.length-1).replace(/""/g,'"')),p===""?c[a]=null:a==="price"||a==="stock"||a==="min_stock_alert"?c[a]=Number(p):a==="is_active"||a==="is_featured"?c[a]=p.toLowerCase()==="true":c[a]=p}),(!c.id||c.id==="new")&&delete c.id,c.name&&c.price>=0?o.push(c):y++}if(o.length>0){let{error:u}=await this.supabase.from("products").upsert(o,{onConflict:"id"});if(u)throw u}r({success:o.length,errors:y})}catch(l){s(l)}},n.onerror=e=>s(e),n.readAsText(t)})}async bulkUpdate(t,r){let{error:s}=await this.supabase.from("products").update(r).in("id",t);if(s)throw s}async bulkIncreasePrice(t,r){let{data:s,error:n}=await this.supabase.from("products").select("id, price").in("id",t);if(n)throw n;if(!s||s.length===0)return;let e=s.map(i=>({id:i.id,price:Math.round(i.price*(1+r/100))})),l=5;for(let i=0;i<e.length;i+=l){let m=e.slice(i,i+l);await Promise.all(m.map(o=>this.supabase.from("products").update({price:o.price}).eq("id",o.id)))}}static \u0275fac=function(r){return new(r||b)};static \u0275prov=w({token:b,factory:b.\u0275fac,providedIn:"root"})};export{S as a};
