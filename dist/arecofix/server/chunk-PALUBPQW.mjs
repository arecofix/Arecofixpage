import './polyfills.server.mjs';
import{a as T}from"./chunk-BDXJUVVV.mjs";import{a as y}from"./chunk-RBOCUYI6.mjs";import{w as _}from"./chunk-R44Y3TM4.mjs";import{R as g,W as o,ma as l,xa as f}from"./chunk-CUO5BU3F.mjs";var r=class extends Error{constructor(t,s,a=500,u){super(t);this.code=s;this.statusCode=a;this.details=u;this.name=this.constructor.name,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},x=class extends r{constructor(e,t){super(e,"VALIDATION_ERROR",400,t)}},b=class extends r{constructor(e="Authentication failed",t){super(e,"AUTHENTICATION_ERROR",401,t)}},I=class extends r{constructor(e="Access denied",t){super(e,"AUTHORIZATION_ERROR",403,t)}},R=class extends r{constructor(e,t){let s=t?`${e} with identifier '${t}' not found`:`${e} not found`;super(s,"NOT_FOUND",404)}},i=class extends r{constructor(e,t){super(e,"DATABASE_ERROR",500,t)}},h=class extends r{constructor(e="Network request failed",t){super(e,"NETWORK_ERROR",503,t)}};var S=class n{supabase=o(T);logger=o(y);platformId=o(f);_currentTenant=l(null);currentTenant=this._currentTenant.asReadonly();_isInitialized=l(!1);isInitialized=this._isInitialized.asReadonly();getTenantId(){let e=this._currentTenant();if(e)return e.id;if(_(this.platformId)){let t=localStorage.getItem("arecofix_tenant_id");return t||"00000000-0000-0000-0000-000000000000"}return"00000000-0000-0000-0000-000000000000"}async resolveTenantByHostname(e){try{let{data:t,error:s}=await this.supabase.from("tenants").select("*").eq("custom_domain",e).eq("is_active",!0).maybeSingle();if(s)throw new i(s.message,s);if(!t){let a=e.split(".")[0],u=e.includes("localhost")||e==="arecofix.com.ar"?"demo":a,{data:d,error:c}=await this.supabase.from("tenants").select("*").eq("slug",u).eq("is_active",!0).maybeSingle();if(c)throw new i(c.message,c);if(d)t=d;else{let{data:p}=await this.supabase.from("tenants").select("*").limit(1).maybeSingle();if(p)t=p;else{let m={id:"00000000-0000-0000-0000-000000000000",name:"Arecofix Dev Local",slug:"demo",plan_type:"basic",currency:"ARS",tax_percentage:21,branding_settings:{primary_color:"#3b82f6"}};return this.setTenant(m),m}}}if(t){let a=t;return this.setTenant(a),a}return null}catch(t){return this.logger.error("Failed to resolve SaaS Tenant",t),null}}setTenant(e){this._currentTenant.set(e),this._isInitialized.set(!0),typeof window<"u"&&(localStorage.setItem("arecofix_tenant_id",e.id),e.branding_settings?.primary_color&&document.documentElement.style.setProperty("--primary-color",e.branding_settings.primary_color)),this.logger.info(`Context switched to Tenant: ${e.name} (${e.id})`)}clearTenantContext(){this._currentTenant.set(null),this._isInitialized.set(!1),typeof window<"u"&&(localStorage.removeItem("arecofix_tenant_id"),document.documentElement.style.removeProperty("--primary-color"))}static \u0275fac=function(t){return new(t||n)};static \u0275prov=g({token:n,factory:n.\u0275fac,providedIn:"root"})};export{r as a,x as b,b as c,I as d,R as e,i as f,h as g,S as h};
