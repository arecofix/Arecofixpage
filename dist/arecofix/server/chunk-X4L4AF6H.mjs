import './polyfills.server.mjs';
import{a as k}from"./chunk-QENMRFWU.mjs";import{a as T}from"./chunk-ACF32YXE.mjs";import{e as w}from"./chunk-BDXJUVVV.mjs";import{a as C}from"./chunk-WUMV5ZNI.mjs";import{R as g,W as f,p as a}from"./chunk-CUO5BU3F.mjs";import{a as R}from"./chunk-N7QBYMCK.mjs";var y=class p{constructor(){}async parse(t,r){return new Promise((i,o)=>{let n=new FileReader;n.onload=e=>{try{let s=e.target?.result;if(!s){o(new Error("Empty file"));return}let l=s.split(/\r\n|\n/),c=l[0].split(",").map(m=>m.trim()),d=[],u=0;for(let m=1;m<l.length;m++){let h=l[m].trim();if(!h)continue;let P=this.parseLine(h);if(P.length!==c.length){console.warn(`Skipping line ${m+1}: Column count mismatch`),u++;continue}let b=r(P,c);b?d.push(b):u++}i({data:d,errors:u})}catch(s){o(s)}},n.onerror=e=>o(e),n.readAsText(t)})}exportToCsv(t,r,i){if(!t.length)return;let o=[i.join(","),...t.map(l=>i.map(c=>{let d=l[c],u=d??"";return typeof u=="string"&&(u.includes(",")||u.includes('"')||u.includes(`
`))?`"${u.replace(/"/g,'""')}"`:u}).join(","))].join(`
`),n=new Blob([o],{type:"text/csv;charset=utf-8;"}),e=document.createElement("a"),s=URL.createObjectURL(n);e.setAttribute("href",s),e.setAttribute("download",`${r}_${new Date().toISOString().split("T")[0]}.csv`),e.style.visibility="hidden",document.body.appendChild(e),e.click(),document.body.removeChild(e)}parseLine(t){let r=[],i=!1,o="";for(let n of t)n==='"'?i=!i:n===","&&!i?(r.push(o),o=""):o+=n;return r.push(o),r}static \u0275fac=function(r){return new(r||p)};static \u0275prov=g({token:p,factory:p.\u0275fac,providedIn:"root"})};var v=class{static slugify(t){return t.toString().toLowerCase().trim().replace(/\s+/g,"-").replace(/&/g,"-and-").replace(/[^a-z0-9-]/g,"").replace(/-+/g,"-")}static capitalize(t){return t?t.charAt(0).toUpperCase()+t.slice(1):""}};var I=class p{productRepo=f(C);brandRepo=f(T);categoryRepo=f(k);csvService=f(y);auth=f(w);async getProducts(){let t=this.auth.getCurrentUser();if(t){let r=await this.auth.getUserProfile(t.id);return a(this.productRepo.getAll(r?.branch_id))}return a(this.productRepo.getAll())}async getProduct(t){return a(this.productRepo.getById(t))}async getBrands(){return a(this.brandRepo.getAll())}async getCategories(){return a(this.categoryRepo.getAll())}async createProduct(t){await a(this.productRepo.create(t))}async updateProduct(t,r){await a(this.productRepo.update(t,r))}async uploadImage(t){return this.productRepo.uploadImage(t)}slugify(t){return v.slugify(t)}async exportProductsToCSV(){let t=await this.getProducts();if(!t.length)return;let r=["id","name","slug","description","price","stock","category_id","brand_id","image_url","is_active","is_featured","sku","barcode"];this.csvService.exportToCsv(t,"products_export",r)}async importProductsFromCSV(t){let r=await this.csvService.parse(t,(o,n)=>{let e={};return n.forEach((s,l)=>{let c=o[l]?.trim();c===""||c===void 0?e[s]=null:s==="price"||s==="stock"||s==="min_stock_alert"?e[s]=Number(c):s==="is_active"||s==="is_featured"?e[s]=c.toLowerCase()==="true":e[s]=c}),(!e.id||e.id==="new")&&delete e.id,e.name&&(e.price===void 0||e.price>=0)?e:null}),i=r.data;return i.length>0?{success:(await a(this.productRepo.upsertMany(i))).length,errors:r.errors}:{success:0,errors:r.errors}}async bulkUpdate(t,r){let i=t.map(o=>R({id:o},r));await a(this.productRepo.updateMany(i))}async bulkCustomUpdate(t){await a(this.productRepo.upsertMany(t))}async bulkIncreasePrice(t,r){let o=(await a(this.productRepo.findWithFilters({ids:t}))).data;if(!o||o.length===0)return;let n=o.map(e=>({id:e.id,price:Math.round(e.price*(1+r/100))}));await a(this.productRepo.updateMany(n))}static \u0275fac=function(r){return new(r||p)};static \u0275prov=g({token:p,factory:p.\u0275fac,providedIn:"root"})};export{I as a};
