import './polyfills.server.mjs';
import{a as y,i as O,m as E}from"./chunk-OEE6LMKQ.mjs";import{a as g}from"./chunk-WO5P5INO.mjs";import{C as p,R as b,W as i,k as c,r as _}from"./chunk-PUXVFRR7.mjs";import{a as l,b as m}from"./chunk-DGJQU3KY.mjs";var w=class u{supabase=i(y);logger=i(g);auth=i(E);tenantService=i(O);useSoftDeletes=!0;applyTenantFilter(t){let r=t.eq("tenant_id",this.tenantService.getTenantId());return this.useSoftDeletes&&(r=r.is("deleted_at",null)),r}getOrders(){let t=this.supabase.from("orders").select("id, order_number, customer_name, customer_email, customer_phone, shipping_address, status, subtotal, tax, discount, total_amount, notes, user_id, tenant_id, created_at, updated_at, deleted_at, payment_method, order_items(id, order_id, product_id, course_id, product_name, quantity, unit_price, subtotal, tenant_id, created_at)"),r=this.applyTenantFilter(t).order("created_at",{ascending:!1});return c(r).pipe(_(e=>{let{data:a,error:o}=e;if(o)throw o;return(a||[]).map(n=>this.mapDbOrderToDomain(n))}),p(e=>{throw this.handleError("Error fetching orders",e),e}))}getOrderById(t){return c(Promise.all([this.applyTenantFilter(this.supabase.from("orders").select("id, order_number, customer_name, customer_email, customer_phone, shipping_address, status, subtotal, tax, discount, total_amount, notes, user_id, tenant_id, created_at, updated_at, deleted_at, payment_method").eq("id",t)).single(),this.supabase.from("order_items").select("id, order_id, product_id, course_id, product_name, quantity, unit_price, subtotal, tenant_id, created_at").eq("order_id",t).eq("tenant_id",this.tenantService.getTenantId())])).pipe(_(([r,e])=>{if(r.error)throw r.error;if(e.error)throw e.error;let a=r.data;return a.order_items=e.data,this.mapDbOrderToDomain(a)}),p(r=>{throw this.handleError("Error fetching order",r),r}))}async createOrder(t,r){try{let e=this.auth.getCurrentUser(),a=crypto.randomUUID(),o=`ORD-${Date.now().toString(36).toUpperCase()}`,n=this.tenantService.getTenantId(),d={id:a,customer_name:t.customer_name,customer_email:t.customer_email,customer_phone:t.customer_phone||null,shipping_address:t.shipping_address||null,status:t.status||"pending",subtotal:t.subtotal,tax:t.tax,discount:t.discount,total:t.total||t.total_amount,total_amount:t.total||t.total_amount,notes:t.notes||null,payment_method:t.payment_method||null,order_number:o,user_id:t.user_id||null,tenant_id:n},{error:h}=await this.supabase.from("orders").insert(d);if(h)throw h;let I=r.map(s=>({order_id:a,product_id:s.product_id||null,course_id:s.course_id||null,product_name:s.product_name,quantity:s.quantity,unit_price:s.unit_price,subtotal:s.subtotal,tenant_id:n})),{error:f}=await this.supabase.from("order_items").insert(I);if(f)throw f;return{data:m(l({},t),{id:a,order_number:o,created_at:new Date().toISOString(),tenant_id:n}),error:null}}catch(e){return this.handleError("Critical error creating order",e),{data:null,error:e}}}async updateOrderStatus(t,r){let e=this.supabase.from("orders").update({status:r,updated_at:new Date().toISOString()}).eq("id",t),{error:a,data:o}=await this.applyTenantFilter(e).select("id, status");return a&&this.handleError("Error updating order status",a),!a&&(!o||o.length===0)?{error:new Error("Supabase RLS Error: Permission denied or Record filtered out.")}:{error:a}}async deleteOrder(t){let r=this.supabase.from("orders").delete().eq("id",t),{error:e}=await this.applyTenantFilter(r);return e&&this.handleError("Error deleting order",e),{error:e}}async updateOrder(t,r,e){try{let a={customer_name:r.customer_name,customer_email:r.customer_email,customer_phone:r.customer_phone||null,shipping_address:r.shipping_address||null,status:r.status,subtotal:r.subtotal,tax:r.tax,discount:r.discount,total:r.total||r.total_amount,total_amount:r.total||r.total_amount,notes:r.notes||null,payment_method:r.payment_method||null,updated_at:new Date().toISOString()},o=this.supabase.from("orders").update(a).eq("id",t),{error:n,data:d}=await this.applyTenantFilter(o).select("id");if(n)throw n;if(!d||d.length===0)throw new Error("Supabase RLS Error: Permission denied or Record filtered out.");return await this.handleItemsUpdate(t,e),{data:m(l({},r),{id:t}),error:null}}catch(a){return this.handleError("Error updating order",a),{data:null,error:a}}}async handleItemsUpdate(t,r){let e=this.tenantService.getTenantId(),{error:a}=await this.supabase.from("order_items").delete().eq("order_id",t).eq("tenant_id",e);if(a)throw a;let o=r.map(n=>({order_id:t,product_name:n.product_name,quantity:n.quantity,unit_price:n.unit_price,subtotal:n.subtotal,product_id:n.product_id||null,course_id:n.course_id||null,tenant_id:e}));if(o.length>0){let{error:n}=await this.supabase.from("order_items").insert(o);if(n)throw n}}mapDbOrderToDomain(t){return{id:t.id,created_at:t.created_at,updated_at:t.updated_at||void 0,order_number:t.order_number,customer_name:t.customer_name,customer_email:t.customer_email,customer_phone:t.customer_phone||void 0,shipping_address:t.shipping_address||t.customer_address||void 0,user_id:t.user_id||t.customer_id||void 0,status:t.status,subtotal:t.subtotal,tax:t.tax,discount:t.discount,total:t.total_amount,notes:t.notes||void 0,items:(t.order_items||[]).map(r=>({id:r.id,order_id:r.order_id,product_id:r.product_id||void 0,product_name:r.product_name,quantity:r.quantity,unit_price:r.unit_price,subtotal:r.subtotal,created_at:r.created_at}))}}handleError(t,r){this.logger.error(`${t}:`,r)}static \u0275fac=function(r){return new(r||u)};static \u0275prov=b({token:u,factory:u.\u0275fac,providedIn:"root"})};export{w as a};
