import './polyfills.server.mjs';
import{a as d,i as f,m as h}from"./chunk-OEE6LMKQ.mjs";import{R as u,W as s,ma as a}from"./chunk-PUXVFRR7.mjs";import{a as r,b as c}from"./chunk-DGJQU3KY.mjs";var p=class o{notifications=a([]);notifications$=this.notifications.asReadonly();supabase=s(d);auth=s(h);tenantService=s(f);_dbNotifications=a([]);dbNotifications=this._dbNotifications.asReadonly();_unreadCount=a(0);unreadCount=this._unreadCount.asReadonly();realtimeChannel;showSuccess(i,t=3e3){this.show("success",i,t)}showError(i,t=5e3){this.show("error",i,t)}showWarning(i,t=4e3){this.show("warning",i,t)}showInfo(i,t=3e3){this.show("info",i,t)}show(i,t,e){let n={id:this.generateId(),type:i,message:t,duration:e};this.notifications.update(m=>[...m,n]),e>0&&setTimeout(()=>this.remove(n.id),e)}remove(i){this.notifications.update(t=>t.filter(e=>e.id!==i))}clearAll(){this.notifications.set([])}generateId(){return`notification-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}async loadNotifications(){let i=this.auth.getCurrentUser();if(!i)return;let{data:t,error:e}=await this.supabase.from("notifications").select("*").eq("user_id",i.id).eq("tenant_id",this.tenantService.getTenantId()).order("created_at",{ascending:!1}).limit(50);!e&&t&&(this._dbNotifications.set(t),this._unreadCount.set(t.filter(n=>!n.is_read).length))}async markAsRead(i){let{error:t}=await this.supabase.from("notifications").update({is_read:!0}).eq("id",i);t||(this._dbNotifications.update(e=>e.map(n=>n.id===i?c(r({},n),{is_read:!0}):n)),this._unreadCount.update(e=>Math.max(0,e-1)))}async markAllAsRead(){let i=this.auth.getCurrentUser();if(!i)return;let{error:t}=await this.supabase.from("notifications").update({is_read:!0}).eq("user_id",i.id).eq("is_read",!1);t||(this._dbNotifications.update(e=>e.map(n=>c(r({},n),{is_read:!0}))),this._unreadCount.set(0))}subscribeToRealtime(){let i=this.auth.getCurrentUser();i&&(this.realtimeChannel=this.supabase.channel("public:notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${i.id}`},t=>{let e=t.new;this._dbNotifications.update(n=>[e,...n]),this._unreadCount.update(n=>n+1),this.showInfo(e.title+" - "+e.message)}).subscribe())}unsubscribe(){this.realtimeChannel&&this.supabase.removeChannel(this.realtimeChannel)}static \u0275fac=function(t){return new(t||o)};static \u0275prov=u({token:o,factory:o.\u0275fac,providedIn:"root"})};export{p as a};
