{
  "version": 3,
  "sources": ["src/app/public/categories/services/category.service.ts"],
  "sourcesContent": ["import { inject, Injectable } from '@angular/core';\r\nimport { Observable, from, of } from 'rxjs';\r\nimport { map, catchError, switchMap } from 'rxjs/operators';\r\nimport { SupabaseClient } from '@supabase/supabase-js';\r\nimport { AuthService } from '@app/core/services/auth.service';\r\nimport { LoggerService } from '@app/core/services/logger.service';\r\nimport { TenantService } from '@app/core/services/tenant.service';\r\n\r\nimport {\r\n  iCategoriesResponse,\r\n  iRequestParams,\r\n  iCategory,\r\n} from '@app/public/categories/interfaces';\r\n\r\n@Injectable({\r\n  providedIn: 'root',\r\n})\r\nexport class CategoryService {\r\n  private supabase: SupabaseClient;\r\n  private logger = inject(LoggerService);\r\n  private tenantService = inject(TenantService);\r\n\r\n  constructor(private authService: AuthService) {\r\n    this.supabase = this.authService.getSupabaseClient();\r\n  }\r\n\r\n  private processResponse(data: any[], count: number | null, params: { _page: number; _per_page: number }): iCategoriesResponse {\r\n    const totalItems = count || data.length;\r\n    const perPage = params._per_page > 0 ? params._per_page : totalItems;\r\n    const pages = Math.max(1, Math.ceil(totalItems / (perPage || 1)));\r\n\r\n    return {\r\n      first: 1,\r\n      prev: params._page > 1 ? params._page - 1 : null,\r\n      next: params._page < pages ? params._page + 1 : null,\r\n      last: pages,\r\n      pages,\r\n      items: totalItems,\r\n      data: data as iCategory[],\r\n    };\r\n  }\r\n\r\n  public getData(params: iRequestParams): Observable<iCategoriesResponse> {\r\n    const { _page = 1, _per_page = 10 } = params;\r\n    const start = (_page - 1) * _per_page;\r\n    const end = start + _per_page - 1;\r\n\r\n    return from(\r\n      this.supabase\r\n        .from('categories')\r\n        .select('*', { count: 'exact' })\r\n        .eq('tenant_id', this.tenantService.getTenantId())\r\n        .eq('is_active', true)\r\n        .range(start, end)\r\n    ).pipe(\r\n      map(({ data, count, error }) => {\r\n        if (error) throw error;\r\n        return this.processResponse(data || [], count, { _page, _per_page });\r\n      }),\r\n      catchError((err) => {\r\n        this.logger.error('Supabase Error:', err);\r\n        return of({ first: 1, prev: null, next: null, last: 1, pages: 1, items: 0, data: [] });\r\n      })\r\n    );\r\n  }\r\n\r\n  public getFeaturedData(): Observable<iCategoriesResponse> {\r\n    const _page = 1;\r\n    const _per_page = 100;\r\n\r\n    return from(\r\n      this.supabase\r\n        .from('categories')\r\n        .select('*', { count: 'exact' })\r\n        .eq('tenant_id', this.tenantService.getTenantId())\r\n        .eq('is_active', true)\r\n        .order('name')\r\n        .limit(_per_page)\r\n    ).pipe(\r\n      map(({ data, count, error }) => {\r\n        if (error) throw error;\r\n        return this.processResponse(data || [], count, { _page, _per_page });\r\n      }),\r\n      catchError((err) => {\r\n        this.logger.error('Supabase Error:', err);\r\n        return of({ first: 1, prev: null, next: null, last: 1, pages: 1, items: 0, data: [] });\r\n      })\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Finds a category by its URL slug.\r\n   * Uses exact match first; falls back to case-insensitive partial match.\r\n   * Does NOT filter by type so that the category is always found regardless\r\n   * of whether type was set properly in the admin panel.\r\n   */\r\n  public getDataBySlug(slug: string): Observable<iCategoriesResponse> {\r\n    const normalizedSlug = (slug || '').trim().toLowerCase();\r\n    const tenantId = this.tenantService.getTenantId();\r\n\r\n    // Step 1: exact match (fastest, most reliable)\r\n    return from(\r\n      this.supabase\r\n        .from('categories')\r\n        .select('*')\r\n        .eq('tenant_id', tenantId)\r\n        .eq('slug', normalizedSlug)\r\n        .limit(1)\r\n    ).pipe(\r\n      switchMap(({ data, error }) => {\r\n        if (error) {\r\n          this.logger.error('Supabase Error (exact slug):', error);\r\n          return of({ data: [] as iCategory[], error });\r\n        }\r\n        if (data && data.length > 0) {\r\n          return of({ data: data as iCategory[], error: null });\r\n        }\r\n        // Step 2: case-insensitive partial fallback (handles slugs with suffixes)\r\n        return from(\r\n          this.supabase\r\n            .from('categories')\r\n            .select('*')\r\n            .eq('tenant_id', tenantId)\r\n            .ilike('slug', `%${normalizedSlug}%`)\r\n            .order('slug')\r\n            .limit(10)\r\n        ).pipe(\r\n          map(({ data: d2, error: e2 }) => {\r\n            if (e2) return { data: [] as iCategory[], error: e2 };\r\n            const rows = (d2 || []) as iCategory[];\r\n            // Prefer best match: starts with the slug\r\n            const best = rows.find(r => r.slug.toLowerCase() === normalizedSlug)\r\n              ?? rows.find(r => r.slug.toLowerCase().startsWith(normalizedSlug))\r\n              ?? rows[0];\r\n            return { data: best ? [best] : [], error: null };\r\n          })\r\n        );\r\n      }),\r\n      map(({ data, error }) => {\r\n        if (error) throw error;\r\n        return this.processResponse(data || [], data?.length ?? 0, { _page: 1, _per_page: 1 });\r\n      }),\r\n      catchError((err) => {\r\n        this.logger.error('Supabase Error (slug lookup):', err);\r\n        return of({ first: 1, prev: null, next: null, last: 1, pages: 1, items: 0, data: [] });\r\n      })\r\n    );\r\n  }\r\n\r\n  public getById(id: string): Observable<iCategory | null> {\r\n    if (!id || id === 'null' || id === '0') return of(null);\r\n    return from(\r\n      this.supabase\r\n        .from('categories')\r\n        .select('*')\r\n        .eq('tenant_id', this.tenantService.getTenantId())\r\n        .eq('id', id)\r\n        .single()\r\n    ).pipe(\r\n      map(({ data, error }) => {\r\n        if (error) throw error;\r\n        return data as iCategory;\r\n      }),\r\n      catchError((err) => {\r\n        this.logger.error('Supabase Error:', err);\r\n        return of(null);\r\n      })\r\n    );\r\n  }\r\n\r\n  /** Returns all product-type categories for the current tenant */\r\n  public getAll(): Observable<iCategory[]> {\r\n    return from(\r\n      this.supabase\r\n        .from('categories')\r\n        .select('*')\r\n        .eq('tenant_id', this.tenantService.getTenantId())\r\n        .eq('is_active', true)\r\n        .order('name')\r\n    ).pipe(\r\n      map(({ data, error }) => {\r\n        if (error) throw error;\r\n        return (data || []) as iCategory[];\r\n      }),\r\n      catchError((err) => {\r\n        this.logger.error('Supabase Error getAll:', err);\r\n        return of([]);\r\n      })\r\n    );\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
