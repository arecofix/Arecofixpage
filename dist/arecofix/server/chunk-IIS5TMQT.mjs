import './polyfills.server.mjs';
import{a as k}from"./chunk-QENMRFWU.mjs";import{a as T}from"./chunk-ACF32YXE.mjs";import{a as C}from"./chunk-WUMV5ZNI.mjs";import{b as R}from"./chunk-755PCX5U.mjs";import{R as v,W as f,p as c}from"./chunk-IUHZUWYM.mjs";import{a as w}from"./chunk-N7QBYMCK.mjs";var h=class l{constructor(){}async parse(t,r){return new Promise((o,e)=>{let i=new FileReader;i.onload=n=>{try{let u=n.target?.result;if(!u){e(new Error("Empty file"));return}let d=u.split(/\r\n|\n/),p=d[0].split(",").map(a=>a.trim()),m=[],s=0;for(let a=1;a<d.length;a++){let y=d[a].trim();if(!y)continue;let g=this.parseLine(y);if(g.length!==p.length){console.warn(`Skipping line ${a+1}: Column count mismatch`),s++;continue}let b=r(g,p);b?m.push(b):s++}o({data:m,errors:s})}catch(u){e(u)}},i.onerror=n=>e(n),i.readAsText(t)})}exportToCsv(t,r,o){if(!t.length)return;let e=[o.join(","),...t.map(d=>o.map(p=>{let m=d[p],s=m??"";return typeof s=="string"&&(s.includes(",")||s.includes('"')||s.includes(`
`))?`"${s.replace(/"/g,'""')}"`:s}).join(","))].join(`
`),i=new Blob([e],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a"),u=URL.createObjectURL(i);n.setAttribute("href",u),n.setAttribute("download",`${r}_${new Date().toISOString().split("T")[0]}.csv`),n.style.visibility="hidden",document.body.appendChild(n),n.click(),document.body.removeChild(n)}parseLine(t){let r=[],o=!1,e="";for(let i of t)i==='"'?o=!o:i===","&&!o?(r.push(e),e=""):e+=i;return r.push(e),r}static \u0275fac=function(r){return new(r||l)};static \u0275prov=v({token:l,factory:l.\u0275fac,providedIn:"root"})};var P=class{static slugify(t){return t.toString().toLowerCase().trim().replace(/\s+/g,"-").replace(/&/g,"-and-").replace(/[^a-z0-9-]/g,"").replace(/-+/g,"-")}static capitalize(t){return t?t.charAt(0).toUpperCase()+t.slice(1):""}};var F=class l{productRepo=f(C);brandRepo=f(T);categoryRepo=f(k);csvService=f(h);auth=f(R);supabase=this.auth.getSupabaseClient();async getProducts(){return c(this.productRepo.getAll())}async getProduct(t){return c(this.productRepo.getById(t))}async getBrands(){return c(this.brandRepo.getAll())}async getCategories(){return c(this.categoryRepo.getAll())}async createProduct(t){await c(this.productRepo.create(t))}async updateProduct(t,r){await c(this.productRepo.update(t,r))}async uploadImage(t){let r=`products/${Date.now()}-${t.name}`,{data:o,error:e}=await this.supabase.storage.from("public-assets").upload(r,t);if(e)throw e;let{data:i}=this.supabase.storage.from("public-assets").getPublicUrl(o.path);return i.publicUrl}slugify(t){return P.slugify(t)}async exportProductsToCSV(){let t=await this.getProducts();if(!t.length)return;let r=["id","name","slug","description","price","stock","category_id","brand_id","image_url","is_active","is_featured","sku","barcode"];this.csvService.exportToCsv(t,"products_export",r)}async importProductsFromCSV(t){return new Promise((r,o)=>{let e=new FileReader;e.onload=async i=>{try{if(!i.target?.result)throw new Error("Empty file");let u=await this.csvService.parse(t,(p,m)=>{let s={};return m.forEach((a,y)=>{let g=p[y]?.trim();g===""||g===void 0?s[a]=null:a==="price"||a==="stock"||a==="min_stock_alert"?s[a]=Number(g):a==="is_active"||a==="is_featured"?s[a]=g.toLowerCase()==="true":s[a]=g}),(!s.id||s.id==="new")&&delete s.id,s.name&&(s.price===void 0||s.price>=0)?s:null}),d=u.data;if(d.length>0)try{let p=await c(this.productRepo.upsertMany(d));r({success:p.length,errors:u.errors})}catch(p){o(p)}else r({success:0,errors:u.errors})}catch(n){o(n)}},e.onerror=i=>o(i),e.readAsText(t)})}async bulkUpdate(t,r){let o=t.map(e=>w({id:e},r));await c(this.productRepo.updateMany(o))}async bulkIncreasePrice(t,r){let e=(await c(this.productRepo.findWithFilters({ids:t}))).data;if(!e||e.length===0)return;let i=e.map(n=>({id:n.id,price:Math.round(n.price*(1+r/100))}));await c(this.productRepo.updateMany(i))}static \u0275fac=function(r){return new(r||l)};static \u0275prov=v({token:l,factory:l.\u0275fac,providedIn:"root"})};export{F as a};
