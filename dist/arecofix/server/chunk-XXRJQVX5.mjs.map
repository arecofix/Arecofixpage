{
  "version": 3,
  "sources": ["src/app/core/di/supabase-token.ts", "src/app/core/services/auth.service.ts"],
  "sourcesContent": ["import { InjectionToken } from '@angular/core';\r\nimport { SupabaseClient } from '@supabase/supabase-js';\r\n\r\nexport const SUPABASE_CLIENT = new InjectionToken<SupabaseClient>('SUPABASE_CLIENT');\r\n", "import { Injectable, inject, PLATFORM_ID } from '@angular/core';\r\nimport { isPlatformBrowser } from '@angular/common';\r\nimport { SupabaseClient, User, Session, AuthChangeEvent, AuthError } from '@supabase/supabase-js';\r\nimport { environment } from '../../../environments/environment';\r\nimport { SUPABASE_CLIENT } from '../di/supabase-token';\r\nimport { BehaviorSubject, Observable, firstValueFrom } from 'rxjs';\r\nimport { Router } from '@angular/router';\r\nimport { LoggerService } from './logger.service';\r\nimport { UserProfile } from '@app/shared/interfaces/user.interface';\r\n\r\nexport interface AuthResponse {\r\n  user: User | null;\r\n  session: Session | null;\r\n  error?: string;\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthService {\r\n  private supabase = inject(SUPABASE_CLIENT);\r\n  private router = inject(Router);\r\n  private logger = inject(LoggerService);\r\n  private platformId = inject(PLATFORM_ID);\r\n  private authState = new BehaviorSubject<{ user: User | null; session: Session | null }>({\r\n    user: null,\r\n    session: null,\r\n  });\r\n\r\n  public authState$ = this.authState.asObservable();\r\n\r\n  constructor() {\r\n    const isBrowser = isPlatformBrowser(this.platformId);\r\n    \r\n    if (isBrowser) {\r\n        this.initializeAuth();\r\n    }\r\n  }\r\n\r\n  private initializeAuth() {\r\n    // Set up auth state listener\r\n    this.supabase.auth.onAuthStateChange((event: AuthChangeEvent, session: Session | null) => {\r\n      if (session?.user) {\r\n        this.authState.next({\r\n          user: session.user,\r\n          session: session,\r\n        });\r\n      } else {\r\n        this.authState.next({\r\n          user: null,\r\n          session: null,\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  async signIn(email: string, password: string): Promise<AuthResponse> {\r\n\r\n    const { data, error } = await this.supabase.auth.signInWithPassword({\r\n      email,\r\n      password,\r\n    });\r\n\r\n    if (error) {\r\n      return { user: null, session: null, error: error.message };\r\n    }\r\n    this.authState.next({\r\n      user: data.user,\r\n      session: data.session,\r\n    });\r\n\r\n    // Perfil: gesti√≥n 100% lado Supabase. No realizar upsert desde el cliente.\r\n    // Eliminado bloque de ensure-profile tras login.\r\n\r\n    return { user: data.user, session: data.session };\r\n  }\r\n\r\n  // Complete sign up with profile information\r\n  async signUp(\r\n    email: string,\r\n    password: string,\r\n    profile?: {\r\n      first_name?: string;\r\n      last_name?: string;\r\n      display_name?: string;\r\n      phone?: string;\r\n    }\r\n  ): Promise<AuthResponse> {\r\n    try {\r\n      // 1. Create Auth User\r\n      const { data, error } = await this.supabase.auth.signUp({\r\n        email,\r\n        password,\r\n        options: {\r\n          emailRedirectTo: environment.authRedirectUrl,\r\n          // We still send metadata just in case, but we don't rely on the trigger anymore\r\n          data: profile ? {\r\n            ...profile,\r\n            display_name: (profile.display_name ?? `${profile.first_name ?? ''} ${profile.last_name ?? ''}`.trim()) || null,\r\n          } : undefined,\r\n        },\r\n      });\r\n\r\n      if (error) {\r\n        this.logger.error('Supabase signUp error', error);\r\n        return { user: null, session: null, error: error.message };\r\n      }\r\n\r\n      // 2. Profile creation is now handled by the Supabase Database Trigger 'on_auth_user_created'\r\n      // We no longer need to manually insert into the profiles table from the client.\r\n\r\n      this.authState.next({\r\n        user: data.user,\r\n        session: data.session,\r\n      });\r\n\r\n      return { user: data.user, session: data.session };\r\n\r\n    } catch (e: unknown) {\r\n      this.logger.error('Unexpected error during signup', e);\r\n      const errorMessage = e instanceof Error ? e.message : 'Unknown error';\r\n      return { user: null, session: null, error: errorMessage };\r\n    }\r\n  }\r\n\r\n  async signOut(): Promise<string | null> {\r\n    const { error } = await this.supabase.auth.signOut();\r\n    if (error) {\r\n      return error.message;\r\n    }\r\n    this.authState.next({\r\n      user: null,\r\n      session: null,\r\n    });\r\n    return null;\r\n  }\r\n\r\n  async getUser(): Promise<User | null> {\r\n    const { data } = await this.supabase.auth.getUser();\r\n    return data.user;\r\n  }\r\n\r\n  async getSession(): Promise<Session | null> {\r\n    const { data } = await this.supabase.auth.getSession();\r\n    return data.session;\r\n  }\r\n\r\n  async getUserProfile(userId: string): Promise<UserProfile | null> {\r\n    const { data, error } = await this.supabase\r\n      .from('profiles')\r\n      .select('*')\r\n      .eq('id', userId)\r\n      .single();\r\n\r\n    if (error) {\r\n      this.logger.error('Error fetching profile', error);\r\n      return null;\r\n    }\r\n\r\n    return data as UserProfile;\r\n  }\r\n\r\n  async updateUserProfile(userId: string, profile: Partial<UserProfile>): Promise<UserProfile | null> {\r\n    const { data, error } = await this.supabase\r\n      .from('profiles')\r\n      .update(profile)\r\n      .eq('id', userId)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      this.logger.error('Error updating profile', error);\r\n      return null;\r\n    }\r\n\r\n    return data as UserProfile;\r\n  }\r\n\r\n  async resetPassword(email: string): Promise<string | null> {\r\n    const { error } = await this.supabase.auth.resetPasswordForEmail(email, {\r\n      redirectTo: environment.authRedirectUrl,\r\n    });\r\n    return error ? error.message : null;\r\n  }\r\n\r\n  // Additional utility methods\r\n  isAuthenticated(): boolean {\r\n    return this.authState.value.user !== null;\r\n  }\r\n\r\n  getCurrentUser(): User | null {\r\n    return this.authState.value.user;\r\n  }\r\n\r\n  getCurrentSession(): Session | null {\r\n    return this.authState.value.session;\r\n  }\r\n\r\n  getAuthState$(): Observable<{ user: User | null; session: Session | null }> {\r\n    return this.authState.asObservable();\r\n  }\r\n\r\n  async testDatabaseConnection(): Promise<boolean> {\r\n    try {\r\n      const { data, error } = await this.supabase\r\n        .from('profiles')\r\n        .select('id')\r\n        .limit(1);\r\n\r\n      this.logger.debug('Database connection test', { data, error });\r\n      return !error;\r\n    } catch (err: unknown) {\r\n      this.logger.error('Database connection test failed', err);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async updatePassword(newPassword: string): Promise<string | null> {\r\n    const { error } = await this.supabase.auth.updateUser({\r\n      password: newPassword,\r\n    });\r\n    return error ? error.message : null;\r\n  }\r\n\r\n  async updateEmail(newEmail: string): Promise<string | null> {\r\n    const { error } = await this.supabase.auth.updateUser({\r\n      email: newEmail,\r\n    });\r\n    return error ? error.message : null;\r\n  }\r\n\r\n  async signInWithGoogle(): Promise<AuthResponse> {\r\n    const { data, error } = await this.supabase.auth.signInWithOAuth({\r\n      provider: 'google',\r\n      options: {\r\n        redirectTo: window.location.origin,\r\n      },\r\n    });\r\n\r\n    if (error) {\r\n      return { user: null, session: null, error: error.message };\r\n    }\r\n\r\n    return { user: null, session: null };\r\n  }\r\n\r\n  async signInWithGithub(): Promise<AuthResponse> {\r\n    const { data, error } = await this.supabase.auth.signInWithOAuth({\r\n      provider: 'github',\r\n      options: {\r\n        redirectTo: window.location.origin,\r\n      },\r\n    });\r\n\r\n    if (error) {\r\n      return { user: null, session: null, error: error.message };\r\n    }\r\n\r\n    return { user: null, session: null };\r\n  }\r\n\r\n  async signInWithFacebook(): Promise<AuthResponse> {\r\n    const { data, error } = await this.supabase.auth.signInWithOAuth({\r\n      provider: 'facebook',\r\n      options: {\r\n        redirectTo: window.location.origin,\r\n      },\r\n    });\r\n\r\n    if (error) {\r\n      return { user: null, session: null, error: error.message };\r\n    }\r\n\r\n    return { user: null, session: null };\r\n  }\r\n\r\n  async verifyOTP(email: string, token: string): Promise<AuthResponse> {\r\n    const { data, error } = await this.supabase.auth.verifyOtp({\r\n      email,\r\n      token,\r\n      type: 'email',\r\n    });\r\n\r\n    if (error) {\r\n      return { user: null, session: null, error: error.message };\r\n    }\r\n\r\n    this.authState.next({\r\n      user: data.user,\r\n      session: data.session,\r\n    });\r\n\r\n    return { user: data.user, session: data.session };\r\n  }\r\n\r\n  async sendMagicLink(email: string): Promise<string | null> {\r\n    const { error } = await this.supabase.auth.signInWithOtp({\r\n      email,\r\n      options: {\r\n        emailRedirectTo: environment.authRedirectUrl,\r\n      },\r\n    });\r\n\r\n    return error ? error.message : null;\r\n  }\r\n\r\n  async checkEmailExists(email: string): Promise<boolean> {\r\n    try {\r\n      const { data, error } = await this.supabase\r\n        .from('profiles')\r\n        .select('id')\r\n        .eq('email', email)\r\n        .single();\r\n\r\n      return !error && data !== null;\r\n    } catch (err) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async deleteAccount(): Promise<string | null> {\r\n    const user = this.getCurrentUser();\r\n    if (!user) {\r\n      return 'No user is currently authenticated';\r\n    }\r\n\r\n    // First delete the profile\r\n    const { error: profileError } = await this.supabase\r\n      .from('profiles')\r\n      .delete()\r\n      .eq('id', user.id);\r\n\r\n    if (profileError) {\r\n      return profileError.message;\r\n    }\r\n\r\n    // Then delete the auth user\r\n    // Note: supabase.auth.admin is not available on the client side with anon key.\r\n    // This needs to be done via a secure backend endpoint or Edge Function.\r\n    // const { error: authError } = await this.supabase.auth.admin.deleteUser(user.id);\r\n\r\n    // if (authError) {\r\n    //   return authError.message;\r\n    // }\r\n\r\n    this.logger.warn('Account deletion requires backend implementation');\r\n\r\n    // Sign out\r\n    await this.signOut();\r\n\r\n    return null;\r\n  }\r\n\r\n  async refreshSession(): Promise<Session | null> {\r\n    const { data, error } = await this.supabase.auth.refreshSession();\r\n\r\n    if (error) {\r\n      this.logger.error('Error refreshing session', error);\r\n      return null;\r\n    }\r\n\r\n    if (data.session?.user) {\r\n      this.authState.next({\r\n        user: data.session.user,\r\n        session: data.session,\r\n      });\r\n    }\r\n\r\n    return data.session;\r\n  }\r\n\r\n  getSupabaseClient(): SupabaseClient {\r\n    return this.supabase;\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
